{% if email['enabled'] === 'true' %}
	{% set enabledChecked = 'checked' %}
	{% set fieldsDisabled = '' %}
{% else %}
	{% set enabledChecked = '' %}
	{% set fieldsDisabled = 'disabled' %}
{% endif %}
{% if email['auth'] === 'true' %}
	{% set authChecked = 'checked' %}
	{% set authDisabled = '' %}
{% else %}
	{% set authChecked = '' %}
	{% set authDisabled = 'disabled' %}
{% endif %}
{% if email['encryption'] === 'true' %}
	{% set encryptionChecked = 'checked' %}
{% else %}
	{% set encryptionChecked = '' %}
{% endif %}
{% if email['allow_html_body'] === 'true' %}
	{% set allowHtmlBodyChecked = 'checked' %}
{% else %}
	{% set allowHtmlBodyChecked = '' %}
{% endif %}
<div class="row p-2">
	<div class="col">
		<div class="form-row">
			<div class="form-group col">
				<label for="email-enabled">Enabled?</label>
				<div class="checkbox icheck-success">
					<input type="checkbox" name="email-enabled" id="email-enabled" {{enabledChecked|default('')}}>
					<label for="email-enabled"></label>
				</div>
			</div>
			<div class="form-group col">
				<label for="email-host">Host *</label>
				<input type="text" class="form-control" id="email-host" placeholder="Host" value="{{email['host']|default('')}}" {{fieldsDisabled}}>
			</div>
			<div class="form-group col">
				<label for="email-port">Port *</label>
				<input type="number" class="form-control" id="email-port" placeholder="Port" value="{{email['port']|default('')}}" {{fieldsDisabled}}>
			</div>
		</div>
		<div class="form-row">
			<div class="form-group col">
				<label for="email-auth">Server Needs Authentication?</label>
				<div class="checkbox icheck-info">
					<input type="checkbox" name="email-auth" id="email-auth" {{authChecked}}>
					<label for="email-auth"></label>
				</div>
			</div>
			<div class="form-group col">
				<label>Server Require Encryption?</label>
				<div class="checkbox icheck-info">
					<input type="checkbox" name="email-encryption" id="email-encryption" {{encryptionChecked}}>
					<label for="email-encryption"></label>
				</div>
			</div>
			<div class="form-group col">
				<label>Allow HTML Body?</label>
				<div class="checkbox icheck-info">
					<input type="checkbox" name="email-allow-html-body" id="email-allow-html-body" {{allowHtmlBodyChecked}}>
					<label for="email-allow-html-body"></label>
				</div>
			</div>
		</div>
		<div id="email-auth-details" class="form-row">
			<div class="form-group col-md-6">
				<label for="email-username">Username *</label>
				<input type="text" class="form-control" id="email-username" placeholder="Username" value="{{email['username']}}" {{authDisabled}}>
			</div>
			<div class="form-group col-md-6">
				<label for="email-password">Password *</label>
				<input type="password" class="form-control" id="email-password" placeholder="Password" value="{{email['password']}}" {{authDisabled}}>
			</div>
		</div>
		<hr>
		<div class="form-row">
			<div class="form-group col">
				<label for="email-test">Test?</label>
				<div class="checkbox icheck-warning">
					<input type="checkbox" name="email-test" id="email-test">
					<label for="email-test"></label>
				</div>
			</div>
			<div class="col email-test-details" hidden>
				<label for="email-test-email-address">Test Email Address</label>
				<div class="input-group">
					<input type="text" class="form-control" id="email-test-email-address" placeholder="Test Email Address" value="">
					<div class="input-group-append">
						<button class="btn btn-primary" type="button" id="email-test-email-button">
							<span id="test-spinner" class="spinner-border spinner-border-sm" role="status" aria-hidden="true" hidden></span>
							Test
						</button>
					</div>
				</div>
			</div>
		</div>
		<div class="form-row email-test-details" hidden>
			<div class="col">
				<label for="email-test-messages">Debug Messages</label>
				<textarea class="form-control" id="email-test-messages" placeholder="Debug Messages" rows="10" disabled></textarea>
			</div>
		</div>
	</div>
</div>
<script type="text/javascript">
	(function emailJS() {
		var emailPostData;
		var emailTestUrl = "/{{route}}/module/settings/testemail";

		$(document).ready(function() {
			initEmailCheckboxes();
			enableEmailTest();
		});

		function initEmailCheckboxes() {
			$('#email-enabled').change(function() {
				if ($('#email-enabled')[0].checked === true) {
					$('#email-host').attr('disabled', false);
					$('#email-port').attr('disabled', false);
				} else if ($('#email-enabled')[0].checked === false) {
					$('#email-host').attr('disabled', true);
					$('#email-port').attr('disabled', true);
					$('#email-host').val('');
					$('#email-port').val('');
				}
			});

			$('#email-auth').change(function() {
				if ($('#email-auth')[0].checked === true) {
					$('#email-username').attr('disabled', false);
					$('#email-password').attr('disabled', false);
				} else if ($('#email-auth')[0].checked === false) {
					$('#email-username').attr('disabled', true);
					$('#email-password').attr('disabled', true);
					$('#email-username').val('');
					$('#email-password').val('');
				}
			});

			$('#email-test').change(function() {
				if ($('#email-test')[0].checked === true) {
					$('.email-test-details').attr('hidden', false);
				} else if ($('#email-test')[0].checked === false) {
					$('.email-test-details').attr('hidden', true);
					$('#email-test-messages').val('');
				}
			});
		}

		function enableEmailTest() {
			$('#email-test-email-button').click(function() {
				$('#email-test-messages').val('');
				extractEmailData();
			});
		}

		function extractEmailData() {
			emailPostData = {
				"enabled"					: $('#email-enabled')[0].checked,
				"host"						: $('#email-host').val(),
				"port"						: $('#email-port').val(),
				"auth"						: $('#email-auth')[0].checked,
				"encryption"				: $('#email-encryption')[0].checked,
				"allow_html_body"			: $('#email-allow-html-body')[0].checked,
				"username"					: $('#email-username').val(),
				"password"					: $('#email-password').val(),
				"test_email_address"		: $('#email-test-email-address').val(),
			};

			if (emailPostData.enabled === true &&
			   (emailPostData.host < 1 ||
				emailPostData.port < 1)
			) {
				if (emailPostData.host < 1) {
					$('#email-host').addClass('is-invalid');
					$('#email-host').focus(function() {
						$(this).removeClass('is-invalid');
					});
				} else if (emailPostData.port < 1) {
					$('#email-port').addClass('is-invalid');
					$('#email-port').focus(function() {
						$(this).removeClass('is-invalid');
					});
				}
			} else if (emailPostData.auth === true &&
					   (emailPostData.username < 1 ||
						emailPostData.password < 1)
					   ) {
				if (emailPostData.username < 1) {
					$('#email-username').addClass('is-invalid');
					$('#email-username').focus(function() {
						$(this).removeClass('is-invalid');
					});
				} else if (emailPostData.password < 1) {
					$('#email-password').addClass('is-invalid');
					$('#email-password').focus(function() {
						$(this).removeClass('is-invalid');
					});
				}
			} else if (emailPostData.test_email_address < 1) {
				$('#email-test-email-address').addClass('is-invalid');
				$('#email-test-email-address').focus(function() {
					$(this).removeClass('is-invalid');
				});
			} else {
				$('#test-spinner').attr('hidden', false);
				performEmailTest();
			}
		}

		function performEmailTest() {
			$.ajax({
				type	: 'POST',
				url		: emailTestUrl,
				data	: emailPostData,
				dataType: 'json'
			}).done(function (data) {
				if (data) {
					$('#test-spinner').attr('hidden', true);
					$('#email-test-messages').val(data.responseMessage.join());
				}
			});
		}
	})();
</script>