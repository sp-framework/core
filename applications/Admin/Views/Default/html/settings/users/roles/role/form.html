<form data-validateon="sections" id="{{componentId}}-{{sectionId}}-form">
    <fieldset id="{{componentId}}-{{sectionId}}-fieldset">
        <div class="row">
            <div class="col-md-12 col-sm-12">
                {{include('thelpers/fields/fields.html', {
                    fieldId                                 : 'id',
                    fieldLabel                              : 'Role ID',
                    fieldType                               : 'input',
                    fieldHelp                               : true,
                    fieldHelpTooltipContent                 : 'Role ID',
                    fieldRequired                           : true,
                    fieldBazScan                            : true,
                    fieldBazPostOnCreate                    : false,
                    fieldBazPostOnUpdate                    : true,
                    fieldDataMinLength                      : 1,
                    fieldDataMaxLength                      : 3,
                    fieldHidden                             : true,
                    fieldDisabled                           : true,
                    fieldValue                              : role.id
                    }
                )}}
            </div>
        </div>
        <div class="row">
            <div class="col-md-6 col-sm-12">
                {{include('thelpers/fields/fields.html', {
                    fieldId                                 : 'name',
                    fieldLabel                              : 'Role Name',
                    fieldType                               : 'input',
                    fieldHelp                               : true,
                    fieldHelpTooltipContent                 : 'Name of the role. Example: Manager',
                    fieldRequired                           : true,
                    fieldBazScan                            : true,
                    fieldBazPostOnCreate                    : true,
                    fieldBazPostOnUpdate                    : true,
                    fieldDataMinLength                      : 1,
                    fieldDataMaxLength                      : 45,
                    fieldHidden                             : false,
                    fieldDisabled                           : false,
                    fieldValue                              : role.name
                    }
                )}}
            </div>
            <div class="col-md-6 col-sm-12">
                {{include('thelpers/fields/fields.html', {
                    fieldId                                 : 'status',
                    fieldLabel                              : 'Status',
                    fieldType                               : 'radio-button-group',
                    fieldHelp                               : true,
                    fieldHelpTooltipContent                 : 'Status of the role',
                    fieldRequired                           : true,
                    fieldBazScan                            : true,
                    fieldBazPostOnCreate                    : true,
                    fieldBazPostOnUpdate                    : true,
                    fieldRadioButtonGroupBlock              : false,
                    buttonGroupSize                         : 'xs',
                    fieldRadioButtonGroupPosition           : '',
                    fieldRadiobuttonGroupButtons            : {
                        'enabled' : {
                            title                           : 'Enabled',
                            type                            : 'success',
                            style                           : 'outline',
                            flat                            : false,
                            size                            : 'xs',
                            icon                            : '',
                            iconPosition                    : 'after',
                            buttonAdditionalClass           : '',
                            dataValue                       : '1',
                            checked                         : true
                        },
                        'disabled' : {
                            title                           : 'Disabled',
                            type                            : 'danger',
                            style                           : 'outline',
                            flat                            : false,
                            size                            : 'xs',
                            icon                            : '',
                            iconPosition                    : 'after',
                            buttonAdditionalClass           : '',
                            dataValue                       : '0'
                        }
                    },
                    fieldRadioButtonGroupButtonChecked      : role.status
                })}}
            </div>
        </div>
        <div class="row">
            <div class="col">
                {{include('thelpers/fields/fields.html', {
                    fieldId                                     : 'permissions',
                    fieldLabel                                  : 'Permissions',
                    fieldType                                   : 'jstree',
                    fieldHelp                                   : true,
                    fieldHelpTooltipContent                     : 'Select permissions for the role',
                    fieldRequired                               : true,
                    fieldBazScan                                : true,
                    fieldBazPostOnCreate                        : true,
                    fieldBazPostOnUpdate                        : true,
                    fieldJstreeSearch                           : true,
                    fieldJstreeAdd                              : false,
                    fieldJstreeEdit                             : false,
                    fieldJstreeExpand                           : true,
                    fieldJstreeCollapse                         : true,
                    fieldJstreeFirstOpen                        : true,
                    fieldJstreeAllOpen                          : true,
                    fieldJstreeToggleAllChildren                : false,
                    fieldJstreeIncludeRootInPath                : false,
                    fieldJstreeSelectEndNodeOnly                : false,
                    fieldJstreeShowDots                         : true,
                    fieldJstreeDoubleClickToggle                : true,
                    fieldJstreeMultiple                         : false,
                    fieldJstreeSearchCaseSensitive              : false,
                    fieldJstreeSearchShowOnlyMatches            : false,
                    fieldJstreeSearchShowOnlyMatchesChildren    : false,
                    fieldJstreeHideJstreeIcons                  : false,
                    dataSrcArr :
                        {
                            'PERMISSIONS' : {
                                'groupIcon'             : '{"icon" : "fas fa-fw fa-plus text-sm"}',
                                'itemIcon'              : '{"icon" : "fas fa-fw fa-angle-right text-sm"}',
                                'srcArr'                : role.apps
                            }
                        }
                    }
                )}}
            </div>
        </div>
    </fieldset>
</form>
<script>
if (!window['bazDataCollection']['{{componentId}}']) {
    window['bazDataCollection']['{{componentId}}'] = { };
}
window['bazDataCollection']['{{componentId}}']['{{componentId}}-{{sectionId}}'] = $.extend(window['bazDataCollection']['{{componentId}}']['{{componentId}}-{{sectionId}}'], {
    '{{componentId}}-id' : { },
    '{{componentId}}-name' : { },
    '{{componentId}}-status' : { },
    '{{componentId}}-accounts' : { },
    '{{componentId}}-permissions' : $.extend(window['bazDataCollection']['{{componentId}}']['{{componentId}}-{{sectionId}}']['{{componentId}}-permissions'], {
        plugins: ["search", "types", "dnd", "grid"],
        grid: {
            columns: [
                {
                    header              :   '<p class="text-center mb-0">' +
                                                '<a href="#"><i id="{{componentId}}-permissions-components-denyall" data-toggle="tooltip" data-html="true" data-placement="bottom" '+
                                                                'data-original-title="Deny All" class="fas fa-fw fa-times-circle mr-1 text-danger helper"></i></a>' +
                                                    ' COMPONENTS ' +
                                                '<a href="#"><i id="{{componentId}}-permissions-components-permitall" data-toggle="tooltip" data-html="true" data-placement="bottom" '+
                                                                'data-original-title="Permit All" class="fas fa-fw fa-check-circle ml-1 text-success helper"></i></a>' +
                                            '</p>',
                    wideCellClass       : 'text-center components',
                    title               : "_DATA_",
                    width               : 500
                },
                {
                    header              :   '<p class="text-center mb-0">' +
                                                '<a href="#"><i id="{{componentId}}-permissions-view-denyall" data-toggle="tooltip" data-html="true" data-placement="bottom" '+
                                                                'data-original-title="Deny All View" class="fas fa-fw fa-times-circle mr-1 text-danger helper"></i></a>' +
                                                    ' VIEW ' +
                                                '<a href="#"><i id="{{componentId}}-permissions-view-permitall" data-toggle="tooltip" data-html="true" data-placement="bottom" '+
                                                                'data-original-title="Permit All View" class="fas fa-fw fa-check-circle ml-1 text-success helper"></i></a>' +
                                            '</p>',
                    wideCellClass       : 'text-center view',
                    cellClass           : 'empty'
                },
                {
                    header              :   '<p class="text-center mb-0">' +
                                                '<a href="#"><i id="{{componentId}}-permissions-create-denyall" data-toggle="tooltip" data-html="true" data-placement="bottom" '+
                                                                'data-original-title="Deny All Create" class="fas fa-fw fa-times-circle mr-1 text-danger helper"></i></a>' +
                                                    ' CREATE ' +
                                                '<a href="#"><i id="{{componentId}}-permissions-create-permitall" data-toggle="tooltip" data-html="true" data-placement="bottom" '+
                                                                'data-original-title="Permit All Create" class="fas fa-fw fa-check-circle ml-1 text-success helper"></i></a>' +
                                            '</p>',
                    wideCellClass       : 'text-center create',
                    cellClass           : 'empty'
                },
                {
                    header              :   '<p class="text-center mb-0">' +
                                                '<a href="#"><i id="{{componentId}}-permissions-edit-denyall" data-toggle="tooltip" data-html="true" data-placement="bottom" '+
                                                                'data-original-title="Deny All Edit" class="fas fa-fw fa-times-circle mr-1 text-danger helper"></i></a>' +
                                                    ' EDIT ' +
                                                '<a href="#"><i id="{{componentId}}-permissions-edit-permitall" data-toggle="tooltip" data-html="true" data-placement="bottom" '+
                                                                'data-original-title="Permit All Edit" class="fas fa-fw fa-check-circle ml-1 text-success helper"></i></a>' +
                                            '</p>',
                    wideCellClass       : 'text-center edit',
                    cellClass           : 'empty'
                },
                {
                    header              :   '<p class="text-center mb-0">' +
                                                '<a href="#"><i id="{{componentId}}-permissions-remove-denyall" data-toggle="tooltip" data-html="true" data-placement="bottom" '+
                                                                'data-original-title="Deny All Remove" class="fas fa-fw fa-times-circle mr-1 text-danger helper"></i></a>' +
                                                    ' REMOVE ' +
                                                '<a href="#"><i id="{{componentId}}-permissions-remove-permitall" data-toggle="tooltip" data-html="true" data-placement="bottom" '+
                                                                'data-original-title="Permit All Remove" class="fas fa-fw fa-check-circle ml-1 text-success helper"></i></a>' +
                                            '</p>',
                    wideCellClass       : 'text-center remove',
                    cellClass           : 'empty'
                },
            ],
            resizable   : true
        },
        afterInit : function(bazDataCollection) {
            'use strict';
            //Fix Grid Width
            (function fixGrid() {
                var gridCount = $('.jstree-grid-column').length - 1;
                var gridWidth = $('.jstree-grid-wrapper').width();
                var colWidth = (gridWidth - 500) / gridCount;
                $('.jstree-grid-column').each(function(index,grid) {
                    if (index !== 0) {
                        $(grid).css({
                            width: colWidth
                        });
                    }
                });
            })();

            var allIds, gridData, apps, permissions, parents, children;
            allIds = $(bazDataCollection['{{componentId}}']['{{componentId}}-{{sectionId}}']['{{componentId}}-permissions']['jstree']).jstree(true).get_json('#', {flat: true});

            // Make a data object
            if (!bazDataCollection['{{componentId}}']['{{componentId}}-{{sectionId}}']['data']) {
                bazDataCollection['{{componentId}}']['{{componentId}}-{{sectionId}}']['data'] = { };
            }
            bazDataCollection['{{componentId}}']['{{componentId}}-{{sectionId}}']['data']['permissions'] = { };
            gridData = bazDataCollection['{{componentId}}']['{{componentId}}-{{sectionId}}']['data']['permissions'];

            permissions = JSON.parse('{{role.permissions|json_encode|e("js")}}');
            for (apps in permissions) {
                if ($('#{{componentId}}-permissions').find('[data-id="' + permissions[apps]['app_id'] + '"]').length > 0) {
                    var jstreeId = $('#{{componentId}}-permissions').find('[data-id="' + permissions[apps]['app_id'] + '"]')[0].id;
                    gridData[jstreeId] = { };
                    gridData[jstreeId]['app_id'] = permissions[apps]['app_id'];
                    gridData[jstreeId]['permissions'] = permissions[apps]['permissions'];
                    gridData[jstreeId]['parents'] = [];
                    gridData[jstreeId]['children'] = [];
                }
            }
            $.each(allIds, function(index,obj) {
                if (gridData[obj.id]) {
                    var jstreeIdStructure = $(bazDataCollection['{{componentId}}']['{{componentId}}-{{sectionId}}']['{{componentId}}-permissions']['jstree']).jstree(true).get_json(obj.id, {flat: true})
                    $.each(jstreeIdStructure, function(index,childrenObj) {
                        if (childrenObj.id !== obj.id) {
                            gridData[obj.id]['children'].push(childrenObj.id);
                        }
                    });
                    $.each(gridData[obj.id]['children'], function(index,childrenId) {
                        gridData[childrenId]['parents'].push(obj.id);
                    });
                }
            });

            //Build Permissions grid
            function buildPermissionsGrid(data) {
                for (var jstreeGridId in gridData) {
                    $('.jstree-grid-wrapper').find('[data-jstreegrid="' + jstreeGridId + '"]').each(function(index, column) {
                        var spanClass, spanData;
                        if (gridData[jstreeGridId]['permissions'][0][index] === '0') {
                            spanClass = 'text-danger cursor-pointer';
                            spanData = '<i class="fas fa-fw fa-times-circle"></i>';
                            $(this).children('span').removeClass('empty');
                        } else if (gridData[jstreeGridId]['permissions'][0][index] === '1') {
                            spanClass = 'text-success cursor-pointer';
                            spanData = '<i class="fas fa-fw fa-check-circle"></i>';
                            $(this).children('span').removeClass('empty');
                        } else {
                            spanClass = 'na';
                            spanData = '<p class="text-info">N/A</p>';
                        }
                        $(this).children('span').addClass(spanClass).html(spanData);
                    });
                }
            }
            buildPermissionsGrid(gridData);

            //Search
            $(bazDataCollection['{{componentId}}']['{{componentId}}-{{sectionId}}']['{{componentId}}-permissions']['jstree']).
            on('search.jstree after_open.jstree after_close.jstree close_all.jstree open_all.jstree', function(e, data) {
                var notHidden = $('#{{componentId}}-permissions').find('.jstree-node').not('.jstree-hidden');
                $('#{{componentId}}-permissions-tree-search-input').keyup(function() {
                    if ($('#{{componentId}}-permissions-tree-search-input').val() === '') {
                        $('#{{componentId}}-permissions .bg-info').removeClass('bg-info');
                        $('.jstree-grid-wrapper .bg-info').removeClass('bg-info');
                        buildPermissionsGrid(gridData);
                    } else {
                        $('#{{componentId}}-permissions .bg-info').removeClass('bg-info');
                        $('.jstree-grid-wrapper .bg-info').removeClass('bg-info');
                        $('.jstree-search').addClass('bg-info');
                    }
                });
                buildPermissionsGrid(gridData);
            });

            function findSiblings(id) {
                return $('.jstree-grid-wrapper').find('[data-jstreegrid="' + id + '"]');
            }

            //Click Toggle
            $(bazDataCollection['{{componentId}}']['{{componentId}}-{{sectionId}}']['{{componentId}}-permissions']['jstree']).on('select_cell.jstree-grid', function(e, data) {
                toggleGridCell($(data.grid)[0].id, $(data.node)[0].id, false, null);
            });

            function toggleGridCell(dataGridId, dataNodeId, bulk, bulkState) {
                // Only run on columns that have data and are not empty or na (N/A)
                if (!$('#' + dataGridId).children('span').hasClass('empty') && !$('#' + dataGridId).children('span').hasClass('na')) {
                    parents = gridData[dataNodeId]['parents'];
                    children = gridData[dataNodeId]['children'];
                    var siblings = findSiblings(dataNodeId);
                    var viewId, viewState;
                    viewId = $(siblings)[0].id;
                    if ($('#' + viewId).children('span').hasClass('text-danger')) {
                        viewState = 'deny';
                    } else if ($('#' + viewId).children('span').hasClass('text-success')) {
                        viewState = 'permit';
                    } else if ($('#' + viewId).children('span').hasClass('text-secondary')) {
                        viewState = 'disabled';
                    }
                    if (bulkState === true) {
                        viewState = 'deny';
                    } else if (bulkState === false) {
                        viewState === 'permit';
                    }
                    //We only need this to store data at the moment. If the array is going to be named array like view => 0, then we dont need this.
                    var colNum, column;
                    column = dataGridId.split('col');
                    colNum = column[1] - 1;

                    if ($('#' + dataGridId).children('span').hasClass('text-danger') || $('#' + dataGridId).children('span').hasClass('text-secondary')) {
                        $('#' + dataGridId).children('span').removeClass('text-danger text-secondary').addClass('text-success');
                        $('#' + dataGridId).children('span').html('<i class="fas fa-fw fa-check-circle"></i>');
                        gridData[dataNodeId]['permissions'][0][colNum] = '1';
                    } else if ($('#' + dataGridId).children('span').hasClass('text-success')) {
                        $('#' + dataGridId).children('span').removeClass('text-success').addClass('text-danger');
                        $('#' + dataGridId).children('span').html('<i class="fas fa-fw fa-times-circle"></i>');
                        gridData[dataNodeId]['permissions'][0][colNum] = '0';
                    }

                    // Disable all siblings if view is disabled
                    if ($('#' + dataGridId)[0].id === viewId) {
                        if (children.length === 0) {
                            //eslint-disable-next-line
                            console.log(bulkState);
                            //eslint-disable-next-line
                            console.log(viewState);
                            if (!bulk) {
                                if (viewState === 'permit') {
                                    $.each(siblings, function(index, sibl) {
                                        if (index > 0) {
                                            $(sibl).children('span').removeClass('text-success text-danger').addClass('text-secondary');
                                            $(sibl).children('span').html('<i class="fas fa-fw fa-times-circle"></i>');
                                            gridData[dataNodeId]['permissions'][0][index] = '0';
                                        }
                                    });
                                } else if (viewState === 'deny') {
                                    $.each(siblings, function(index, sibl) {
                                        if (index > 0) {
                                            $(sibl).children('span').removeClass('text-secondary text-success').addClass('text-danger');
                                            $(sibl).children('span').html('<i class="fas fa-fw fa-times-circle"></i>');
                                            gridData[dataNodeId]['permissions'][0][index] = '0';
                                        }
                                    });
                                }
                            } else {
                                //
                            }
                        }
                    }

                    if (!bulk) {
                        // Disable children if parent is deny
                        if (children.length > 0) {
                            toggleChildren(children, dataGridId);
                        }
                        // Enable parent if child is enabled
                        if (parents.length > 0) {
                            toggleParents(parents, siblings, viewId, viewState);
                        }
                    }
                }
            }

            function toggleParents(parents, siblings, viewId, viewState) {
                $.each(parents, function(index, parent) {
                    var parentColumn = $('.jstree-grid-wrapper').find('[data-jstreegrid="' + parent + '"]')[0];//Only View
                    if ($(parentColumn).children('span').hasClass('text-danger')) {
                        $(parentColumn).children('span').removeClass('text-danger').addClass('text-success');
                        $(parentColumn).children('span').html('<i class="fas fa-fw fa-check-circle"></i>');
                        gridData[$(parentColumn).data('jstreegrid')]['permissions'][0][0] = '1';
                    }
                });
                $.each(siblings, function(index, sibl) {
                    if (viewState === 'deny' || viewState === 'disabled') {
                        if ($(sibl)[0].id !== viewId) {
                            if ($(sibl).children('span').hasClass('text-secondary')) {
                                $(sibl).children('span').removeClass('text-secondary').addClass('text-danger');
                                gridData[$(sibl).data('jstreegrid')]['permissions'][0][index] = '0';
                            }
                        } else {
                            $(sibl).children('span').removeClass('text-danger text-secondary').addClass('text-success');
                            $(sibl).children('span').html('<i class="fas fa-fw fa-check-circle"></i>');
                            gridData[$(sibl).data('jstreegrid')]['permissions'][0][index] = '1';
                        }
                    }
                });
            }

            function toggleChildren(children, dataGridId) {
                var childrenRemoveClass, childrenAddClass, childrenIcon, childrenPermissionData;
                $.each(children, function(index, child) {
                    var childColumns = $('.jstree-grid-wrapper').find('[data-jstreegrid="' + child + '"]');
                    if ($('#' + dataGridId).children('span').hasClass('text-danger')) {
                        var siblings = $('.jstree-grid-wrapper').find('[data-jstreegrid="' + child + '"]');
                        childrenRemoveClass = 'text-danger text-success';
                        childrenAddClass = 'text-secondary';
                        childrenIcon = 'times';
                        childrenPermissionData = '0';
                    } else if ($('#' + dataGridId).children('span').hasClass('text-success')) {
                        childrenRemoveClass = 'text-secondary text-success';
                        childrenAddClass = 'text-danger';
                        childrenIcon = 'times';
                        childrenPermissionData = '0';
                    }
                    $(childColumns).children('span').removeClass(childrenRemoveClass).addClass(childrenAddClass);
                    $(childColumns).children('span').html('<i class="fas fa-fw fa-' + childrenIcon + '-circle"></i>');
                    $.each(childColumns, function(index, childColumn) {
                        gridData[child]['permissions'][0][index] = childrenPermissionData;
                    });
                });
            }

            (function registerBulkButtons() {
                // Bulk deny/permit (All)
                $('#{{componentId}}-permissions-components-denyall').click(function(e) {
                    e.preventDefault();
                    denyPermitAll(null, null, false, null);
                });
                $('#{{componentId}}-permissions-components-permitall').click(function(e) {
                    e.preventDefault();
                    denyPermitAll(null, null, true, null);
                });

                // Bulk deny/permit (Specific Columns)
                $('#{{componentId}}-permissions-view-denyall').click(function(e) {
                    e.preventDefault();
                    denyPermitAll(this, false, null, true);
                });
                $('#{{componentId}}-permissions-view-permitall').click(function(e) {
                    e.preventDefault();
                    denyPermitAll(this, true, null, true);
                });

                $('#{{componentId}}-permissions-create-denyall, #{{componentId}}-permissions-edit-denyall, #{{componentId}}-permissions-remove-denyall').click(function(e) {
                    e.preventDefault();
                    denyPermitAll(this, false, null, null);
                });
                $('#{{componentId}}-permissions-create-permitall, #{{componentId}}-permissions-edit-permitall, #{{componentId}}-permissions-remove-permitall').click(function(e) {
                    e.preventDefault();
                    denyPermitAll(this, true, null, null);
                });
            })();

            // Function to make bulk changes
            function denyPermitAll(denyPermitPermissionIconId, permit, component, view) {
                if (denyPermitPermissionIconId) {
                    var colNum, column;
                    column = $(denyPermitPermissionIconId).parents('div').next('div')[0].id.split('col');
                    colNum = column[1] - 1;
                }
                // Deny All in that Column
                $.each(allIds, function(index, child) {
                    if (denyPermitPermissionIconId) {
                        if (view) {
                            if (permit) {
                                toggleGridCell($('.jstree-grid-wrapper').find('[data-jstreegrid="' + child.id + '"]')[colNum].id, child.id, true, permit);
                            } else {
                                toggleGridCell($('.jstree-grid-wrapper').find('[data-jstreegrid="' + child.id + '"]')[colNum].id, child.id, true, permit);
                            }
                        } else {
                            if (!$($('.jstree-grid-wrapper').find('[data-jstreegrid="' + child.id + '"]')[colNum]).children('span').hasClass('empty') &&
                                !$($('.jstree-grid-wrapper').find('[data-jstreegrid="' + child.id + '"]')[colNum]).children('span').hasClass('na')) {
                                if (permit) {
                                    $($('.jstree-grid-wrapper').find('[data-jstreegrid="' + child.id + '"]')[colNum]).children('span').removeClass('text-danger').addClass('text-success');
                                    $($('.jstree-grid-wrapper').find('[data-jstreegrid="' + child.id + '"]')[colNum]).children('span').html('<i class="fas fa-fw fa-check-circle"></i>');
                                    gridData[child.id]['permissions'][0][colNum] = '1';
                                } else {
                                    $($('.jstree-grid-wrapper').find('[data-jstreegrid="' + child.id + '"]')[colNum]).children('span').removeClass('text-success').addClass('text-danger');
                                    $($('.jstree-grid-wrapper').find('[data-jstreegrid="' + child.id + '"]')[colNum]).children('span').html('<i class="fas fa-fw fa-times-circle"></i>');
                                    gridData[child.id]['permissions'][0][colNum] = '0';
                                }
                            }
                        }
                    } else {
                        $('.jstree-grid-wrapper').find('[data-jstreegrid="' + child.id + '"]').children('span').each(function(index,span) {
                            if (!$(span).hasClass('empty') &&
                                !$(span).hasClass('na')) {
                                if (component) {
                                    $(span).removeClass('text-danger').addClass('text-success');
                                    $(span).html('<i class="fas fa-fw fa-check-circle"></i>');
                                    gridData[child.id]['permissions'][0][index] = '1';
                                } else {
                                    $(span).removeClass('text-success').addClass('text-danger');
                                    $(span).html('<i class="fas fa-fw fa-times-circle"></i>');
                                    gridData[child.id]['permissions'][0][index] = '0';
                                }
                            }
                        });
                    }
                });
            }
        }
    }),
    //Validation
    '{{componentId}}-{{sectionId}}-form' : {
        rules: {
            '{{componentId}}-name' : 'required',
        },
        messages: {
            '{{componentId}}-name' : 'Please enter role name',
        }
    }
});
</script>