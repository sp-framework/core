{% if user['id'] is defined %}
    {% set userId = user['id'] %}
    {% set userEmail = user['email'] %}
    {% set userRole = user['role_id'] %}
{% else %}
    {% set userId = '' %}
    {% set userEmail = '' %}
    {% set userRole = 0 %}
{% endif %}
{% if user['override_role'] is defined and user['override_role'] == '1' %}
    {% set override = true %}
{% else %}
    {% set override = false %}
{% endif %}
{% set userPermissions = user['permissions']['permissions'] %}
<form data-validateon="section" id="{{componentId}}-{{sectionId}}-form">
    <fieldset id="{{componentId}}-{{sectionId}}-fieldset">
        <div class="row">
            <div class="col">
                {{adminltetags.useTag('fields',
                    [
                        'component'                      : component,
                        'componentName'                  : componentName,
                        'componentId'                    : componentId,
                        'sectionId'                      : sectionId,
                        'fieldId'                        : 'id',
                        'fieldLabel'                     : 'User ID',
                        'fieldType'                      : 'input',
                        'fieldHelp'                      : true,
                        'fieldHelpTooltipContent'        : 'User ID',
                        'fieldRequired'                  : true,
                        'fieldBazScan'                   : true,
                        'fieldBazPostOnCreate'           : false,
                        'fieldBazPostOnUpdate'           : true,
                        'fieldHidden'                    : true,
                        'fieldDisabled'                  : true,
                        'fieldValue'                     : userId
                    ]
                )}}
            </div>
        </div>
        <div class="row">
            <div class="col">
                {{adminltetags.useTag('fields',
                    [
                        'component'                      : component,
                        'componentName'                  : componentName,
                        'componentId'                    : componentId,
                        'sectionId'                      : sectionId,
                        'fieldId'                        : 'email',
                        'fieldLabel'                     : 'Email',
                        'fieldType'                      : 'input',
                        'fieldInputType'                 : 'email',
                        'fieldHelp'                      : true,
                        'fieldHelpTooltipContent'        : 'User Email Address',
                        'fieldRequired'                  : true,
                        'fieldBazScan'                   : true,
                        'fieldBazPostOnCreate'           : true,
                        'fieldBazPostOnUpdate'           : true,
                        'fieldDataInputMinLength'        : 1,
                        'fieldDataInputMaxLength'        : 100,
                        'fieldValue'                     : userEmail
                    ]
                )}}
            </div>
            <div class="col">
                {{adminltetags.useTag('fields',
                    [
                        'component'                      : component,
                        'componentName'                  : componentName,
                        'componentId'                    : componentId,
                        'sectionId'                      : sectionId,
                        'fieldId'                        : 'email_new_password',
                        'fieldLabel'                     : 'Email New Password',
                        'fieldHelp'                      : true,
                        'fieldHelpTooltipContent'        : 'Email New Password to this user.<br>NOTE: Email Settings must be configured for this option to work.',
                        'fieldRequired'                  : true,
                        'fieldType'                      : 'checkbox',
                        'fieldCheckboxType'              : 'info',
                        'fieldCheckboxLabel'             : '',
                        'fieldCheckboxAdditionClass'     : 'text-sm text-uppercase',
                        'fieldBazPostOnCreate'           : true,
                        'fieldBazPostOnUpdate'           : true,
                        'fieldBazScan'                   : true
                    ]
                )}}
            </div>
            <div class="col">
                {{adminltetags.useTag('fields',
                    [
                        'component'                      : component,
                        'componentName'                  : componentName,
                        'componentId'                    : componentId,
                        'sectionId'                      : sectionId,
                        'fieldId'                        : 'force_change_password',
                        'fieldLabel'                     : 'Force User Change Password',
                        'fieldHelp'                      : true,
                        'fieldHelpTooltipContent'        : 'Force use to change password at next login.',
                        'fieldRequired'                  : true,
                        'fieldType'                      : 'checkbox',
                        'fieldCheckboxType'              : 'warning',
                        'fieldCheckboxLabel'             : '',
                        'fieldCheckboxAdditionClass'     : 'text-sm text-uppercase',
                        'fieldBazPostOnCreate'           : true,
                        'fieldBazPostOnUpdate'           : true,
                        'fieldBazScan'                   : true
                    ]
                )}}
            </div>
        </div>
        <hr>
        <div class="row">
            <div class="col">
                {{adminltetags.useTag('fields',
                    [
                        'component'                      : component,
                        'componentName'                  : componentName,
                        'componentId'                    : componentId,
                        'sectionId'                      : sectionId,
                        'fieldId'                        : 'applicationslogin',
                        'fieldLabel'                     : 'Can Login?',
                        'fieldHelp'                      : true,
                        'fieldHelpTooltipContent'        : 'Select applications to which this user can login',
                        'fieldRequired'                  : true,
                        'fieldType'                      : false
                    ]
                )}}
                {% for application in applications %}
                    {% set checkboxIds[componentId ~ '-' ~ sectionId ~ '-applications-login-' ~ application] = application %}
                    {% if user['permissions'][application] is defined %}
                        {% if user['permissions'][application]['login'] == true %}
                            {% set checked = true %}
                        {% else %}
                            {% set checked = false %}
                        {% endif %}
                    {% else %}
                        {% set checked = false %}
                    {% endif %}
                    {{adminltetags.useTag('fields',
                        [
                            'component'                      : component,
                            'componentName'                  : componentName,
                            'componentId'                    : componentId,
                            'sectionId'                      : sectionId,
                            'fieldId'                        : 'applications-login-' ~ application,
                            'fieldLabel'                     : false,
                            'fieldType'                      : 'checkbox',
                            'fieldCheckboxType'              : 'success',
                            'fieldCheckboxLabel'             : application,
                            'fieldCheckboxChecked'           : checked,
                            'fieldCheckboxAdditionClass'     : 'text-sm text-uppercase',
                            'fieldBazScan'                   : false
                        ]
                    )}}
                {% endfor %}
                {% set checkboxIds = json_encode(checkboxIds, 16) %}
            </div>
            <div class="col">
                {{adminltetags.useTag('fields',
                    [
                        'component'                      : component,
                        'componentName'                  : componentName,
                        'componentId'                    : componentId,
                        'sectionId'                      : sectionId,
                        'fieldId'                        : 'role_id',
                        'fieldLabel'                     : 'Select Role',
                        'fieldType'                      : 'select2',
                        'fieldHelp'                      : true,
                        'fieldHelpTooltipContent'        : 'Select a role for this user.',
                        'fieldBazScan'                   : true,
                        'fieldBazPostOnCreate'           : true,
                        'fieldBazPostOnUpdate'           : true,
                        'fieldRequired'                  : true,
                        'fieldDataSelect2Options'        : roles,
                        'fieldDataSelect2OptionsKey'     : 'id',
                        'fieldDataSelect2OptionsValue'   : 'name',
                        'fieldDataSelect2OptionsArray'   : true,
                        'fieldDataSelect2OptionsSelected': userRole
                    ]
                )}}
            </div>
            <div class="col">
                {{adminltetags.useTag('fields',
                    [
                        'component'                      : component,
                        'componentName'                  : componentName,
                        'componentId'                    : componentId,
                        'sectionId'                      : sectionId,
                        'fieldId'                        : 'override_role',
                        'fieldLabel'                     : 'User Level Permissions',
                        'fieldHelp'                      : true,
                        'fieldHelpTooltipContent'        : 'Select permissions for the user<br>NOTE: These permissions override role permissions',
                        'fieldRequired'                  : true,
                        'fieldType'                      : 'checkbox',
                        'fieldCheckboxType'              : 'danger',
                        'fieldCheckboxLabel'             : '',
                        'fieldCheckboxChecked'           : override,
                        'fieldCheckboxAdditionClass'     : 'text-sm text-uppercase',
                        'fieldBazPostOnCreate'           : true,
                        'fieldBazPostOnUpdate'           : true,
                        'fieldBazScan'                   : true
                    ]
                )}}
            </div>
        </div>
        <div class="row" id="user-permissions" hidden>
            <div class="col">
                {{adminltetags.useTag('fields',
                    [
                        'component'                                   : component,
                        'componentName'                               : componentName,
                        'componentId'                                 : componentId,
                        'sectionId'                                   : sectionId,
                        'fieldId'                                     : 'permissions',
                        'fieldLabel'                                  : 'Permissions',
                        'fieldType'                                   : 'jstree',
                        'fieldHelp'                                   : true,
                        'fieldHelpTooltipContent'                     : 'Select permissions for the user<br>NOTE: These permissions override role permissions',
                        'fieldRequired'                               : false,
                        'fieldBazScan'                                : true,
                        'fieldBazPostOnCreate'                        : true,
                        'fieldBazPostOnUpdate'                        : true,
                        'fieldJstreeSearch'                           : true,
                        'fieldJstreeAdd'                              : false,
                        'fieldJstreeEdit'                             : false,
                        'fieldJstreeExpand'                           : true,
                        'fieldJstreeCollapse'                         : true,
                        'fieldJstreeFirstOpen'                        : true,
                        'fieldJstreeAllOpen'                          : true,
                        'fieldJstreeToggleAllChildren'                : false,
                        'fieldJstreeIncludeRootInPath'                : false,
                        'fieldJstreeRootIcon'                         : 'lock',
                        'fieldJstreeSelectEndNodeOnly'                : false,
                        'fieldJstreeShowDots'                         : true,
                        'fieldJstreeDoubleClickToggle'                : true,
                        'fieldJstreeMultiple'                         : false,
                        'fieldJstreeSearchCaseSensitive'              : false,
                        'fieldJstreeSearchShowOnlyMatches'            : false,
                        'fieldJstreeSearchShowOnlyMatchesChildren'    : false,
                        'fieldJstreeHideJstreeIcons'                  : false,
                        'dataSrcArr' :
                            [
                                'components'   :
                                    [
                                        'srcArr'                : components
                                    ]
                            ]
                    ]
                )}}
            </div>
        </div>
    </fieldset>
</form>
<script>
var dataCollectionComponent, dataCollectionSection, dataCollectionSectionForm;

if (!window['dataCollection']['{{componentId}}']) {
    dataCollectionComponent =
        window['dataCollection']['{{componentId}}'] = { };
} else {
    dataCollectionComponent =
        window['dataCollection']['{{componentId}}'];
}
if (!dataCollectionComponent['{{componentId}}-{{sectionId}}']) {
    dataCollectionSection =
        dataCollectionComponent['{{componentId}}-{{sectionId}}'] = { };
} else {
    dataCollectionSection =
        dataCollectionComponent['{{componentId}}-{{sectionId}}'];
}
if (!dataCollectionSection['{{componentId}}-{{sectionId}}-form']) {
    dataCollectionSectionForm =
        dataCollectionSection['{{componentId}}-{{sectionId}}-form'] = { };
} else {
    dataCollectionSectionForm =
        dataCollectionSection['{{componentId}}-{{sectionId}}-form'];
}
dataCollectionSection =
    $.extend(dataCollectionSection, {
        '{{componentId}}-{{sectionId}}-id'                          : { },
        '{{componentId}}-{{sectionId}}-email'                       : { },
        '{{componentId}}-{{sectionId}}-email_new_password'          : { },
        '{{componentId}}-{{sectionId}}-force_change_password'       : { },
        '{{componentId}}-{{sectionId}}-role_id'                     : {
            'placeholder'   : 'SELECT ROLE'
        },
        '{{componentId}}-{{sectionId}}-override_role'   : {
            'afterInit' : function () {
                'use strict';

                function fixGrid() {
                    var gridCount = $('.jstree-grid-column').length - 1;
                    var gridWidth = $('.jstree-grid-wrapper').width();
                    var colWidth = (gridWidth - 500) / gridCount;
                    $('.jstree-grid-column').each(function(index,grid) {
                        if (index !== 0) {
                            $(grid).css({
                                width: colWidth
                            });
                        }
                    });
                }
                function toggleGrid() {
                    var checked = $('#' + '{{componentId}}-{{sectionId}}-override_role')[0].checked;
                    if (checked) {
                        $('#user-permissions').attr('hidden', false);
                        fixGrid();
                    } else if (!checked) {
                        $('#user-permissions').attr('hidden', true);
                    }
                }
                $('#' + '{{componentId}}-{{sectionId}}-override_role').click(function() {
                    toggleGrid();
                });
                toggleGrid();
            }
        },
        '{{componentId}}-{{sectionId}}-permissions'                 :
        $.extend(dataCollectionSection['{{componentId}}-{{sectionId}}-permissions'], {
            plugins: [
                        "search",
                        "types",
                        "dnd",
                        "grid"
            ],
            grid: {
                columns: [
                    {
                        header          :   '<p class="text-center mb-0">' +
                                                '<span class="cursor-pointer">' +
                                                    '<i id="{{componentId}}-{{sectionId}}-permissions-components-denyall" ' +
                                                        'data-toggle="tooltip" data-html="true" data-placement="bottom" '+
                                                        'data-original-title="Deny All" class="fas fa-fw fa-times-circle ' +
                                                        'mr-1 text-danger helper components">' +
                                                    '</i>' +
                                                '</span>' +
                                                    ' COMPONENTS ' +
                                                '<span class="cursor-pointer">' +
                                                    '<i id="{{componentId}}-{{sectionId}}-permissions-components-permitall" ' +
                                                        'data-toggle="tooltip" data-html="true" data-placement="bottom" '+
                                                        'data-original-title="Permit All" class="fas fa-fw fa-check-circle ' +
                                                        'ml-1 text-success helper components">' +
                                                    '</i>' +
                                                '</span>' +
                                            '</p>',
                        wideCellClass   : 'text-center components',
                        title           : "_DATA_",
                        width           : 500
                    },
                    {
                        header          :   '<p class="text-center mb-0">' +
                                                '<span class="cursor-pointer">' +
                                                    '<i id="{{componentId}}-{{sectionId}}-permissions-view-denyall" ' +
                                                        'data-toggle="tooltip" data-html="true" data-placement="bottom" '+
                                                        'data-original-title="Deny All View" class="fas fa-fw fa-times-circle ' +
                                                        'mr-1 text-danger helper view">' +
                                                    '</i>' +
                                                '</span>' +
                                                    ' VIEW ' +
                                                '<span class="cursor-pointer">' +
                                                    '<i id="{{componentId}}-{{sectionId}}-permissions-view-permitall" ' +
                                                        'data-toggle="tooltip" data-html="true" data-placement="bottom" '+
                                                        'data-original-title="Permit All View" class="fas fa-fw fa-check-circle ' +
                                                        'ml-1 text-success helper view">' +
                                                    '</i>' +
                                                '</span>' +
                                            '</p>',
                        wideCellClass   : 'text-center view',
                        cellClass       : 'empty'
                    },
                    {
                        header          :   '<p class="text-center mb-0">' +
                                                '<span class="cursor-pointer">' +
                                                    '<i id="{{componentId}}-{{sectionId}}-permissions-add-denyall" ' +
                                                        'data-toggle="tooltip" data-html="true" data-placement="bottom" '+
                                                        'data-original-title="Deny All Add" class="fas fa-fw fa-times-circle ' +
                                                        'mr-1 text-danger helper add">' +
                                                    '</i>' +
                                                '</span>' +
                                                    ' ADD ' +
                                                '<span class="cursor-pointer">' +
                                                    '<i id="{{componentId}}-{{sectionId}}-permissions-add-permitall" ' +
                                                        'data-toggle="tooltip" data-html="true" data-placement="bottom" '+
                                                        'data-original-title="Permit All Add" class="fas fa-fw fa-check-circle ' +
                                                        'ml-1 text-success helper add">' +
                                                    '</i>' +
                                                '</span>' +
                                            '</p>',
                        wideCellClass   : 'text-center add',
                        cellClass       : 'empty'
                    },
                    {
                        header          :   '<p class="text-center mb-0">' +
                                                '<span class="cursor-pointer">' +
                                                    '<i id="{{componentId}}-{{sectionId}}-permissions-edit-denyall" ' +
                                                        'data-toggle="tooltip" data-html="true" data-placement="bottom" '+
                                                        'data-original-title="Deny All Edit" class="fas fa-fw fa-times-circle ' +
                                                        'mr-1 text-danger helper edit">' +
                                                    '</i>' +
                                                '</span>' +
                                                    ' EDIT ' +
                                                '<span class="cursor-pointer">' +
                                                    '<i id="{{componentId}}-{{sectionId}}-permissions-edit-permitall" ' +
                                                        'data-toggle="tooltip" data-html="true" data-placement="bottom" '+
                                                        'data-original-title="Permit All Edit" class="fas fa-fw fa-check-circle ' +
                                                        'ml-1 text-success helper edit">' +
                                                    '</i>' +
                                                '</span>' +
                                            '</p>',
                        wideCellClass   : 'text-center edit',
                        cellClass       : 'empty'
                    },
                    {
                        header          :   '<p class="text-center mb-0">' +
                                                '<span class="cursor-pointer">' +
                                                    '<i id="{{componentId}}-{{sectionId}}-permissions-remove-denyall" ' +
                                                        'data-toggle="tooltip" data-html="true" data-placement="bottom" '+
                                                        'data-original-title="Deny All Remove" class="fas fa-fw fa-times-circle ' +
                                                        'mr-1 text-danger helper remove">' +
                                                    '</i>' +
                                                '</span>' +
                                                    ' REMOVE ' +
                                                '<span class="cursor-pointer">' +
                                                    '<i id="{{componentId}}-{{sectionId}}-permissions-remove-permitall" ' +
                                                        'data-toggle="tooltip" data-html="true" data-placement="bottom" '+
                                                        'data-original-title="Permit All Remove" class="fas fa-fw fa-check-circle ' +
                                                        'ml-1 text-success helper remove">' +
                                                    '</i>' +
                                                '</span>' +
                                            '</p>',
                        wideCellClass   : 'text-center remove',
                        cellClass       : 'empty'
                    },
                ],
                resizable   : true
            },
            afterInit : function(dataCollection) {
                'use strict';
                var checkboxIds = JSON.parse('{{checkboxIds}}');
                //Fix Grid Width
                (function fixGrid() {
                    var gridCount = $('.jstree-grid-column').length - 1;
                    var gridWidth = $('.jstree-grid-wrapper').width();
                    var colWidth = (gridWidth - 500) / gridCount;
                    $('.jstree-grid-column').each(function(index,grid) {
                        if (index !== 0) {
                            $(grid).css({
                                width: colWidth
                            });
                        }
                    });
                })();

                var allIds, gridData, permissions, parents, children;

                allIds =
                    $(dataCollection['{{componentId}}']['{{componentId}}-{{sectionId}}']['{{componentId}}-{{sectionId}}-permissions']['jstree'])
                        .jstree(true).get_json('#', {flat: true});

                // Make a data object
                if (!dataCollection['{{componentId}}']['{{componentId}}-{{sectionId}}']['{{componentId}}-{{sectionId}}-permissions']['data']) {
                    dataCollection['{{componentId}}']['{{componentId}}-{{sectionId}}']['{{componentId}}-{{sectionId}}-permissions']['data'] = { };
                }
                // dataCollection['{{componentId}}']['{{componentId}}-{{sectionId}}-permissions']['data']['permissions'] = { };
                gridData = dataCollection['{{componentId}}']['{{componentId}}-{{sectionId}}']['{{componentId}}-{{sectionId}}-permissions']['data'];

                permissions = JSON.parse('{{userPermissions}}');//Parse DB Data

                for (var application in permissions) {
                    for (var component in permissions[application]) {
                        if ($('#{{componentId}}-{{sectionId}}-permissions').find('[data-id="' + component + '"]').length > 0) {
                            var jstreeId =
                                $('#{{componentId}}-{{sectionId}}-permissions').find('[data-id="' + component + '"]')[0].id;
                            gridData[jstreeId] = { };
                            gridData[jstreeId]['component_id'] = component;
                            gridData[jstreeId]['permissions'] = permissions[application][component];
                            gridData[jstreeId]['parents'] = [];
                            gridData[jstreeId]['children'] = [];
                        }
                    }
                }
                $.each(allIds, function(index, obj) {
                    if (gridData[obj.id]) {
                        var jstreeIdStructure =
                            $(dataCollection['{{componentId}}']['{{componentId}}-{{sectionId}}']['{{componentId}}-{{sectionId}}-permissions']['jstree'])
                                .jstree(true).get_json(obj.id, {flat: true})

                        $.each(jstreeIdStructure, function(index, childrenObj) {
                            if (childrenObj.id !== obj.id) {
                                gridData[obj.id]['children'].push(childrenObj.id);
                            }
                        });

                        $.each(gridData[obj.id]['children'], function(index, childrenId) {
                            gridData[childrenId]['parents'].push(obj.id);
                        });
                    }
                });

                //Build Permissions grid
                function buildPermissionsGrid(gridData) {
                    for (var jstreeGridId in gridData) {
                        $('.jstree-grid-wrapper')
                            .find('[data-jstreegrid="' + jstreeGridId + '"]')
                            .each(function(index, column) {
                                var spanClass, spanData;
                                if (index === 0) {
                                    spanClass = 'view ';
                                } else if (index === 1) {
                                    spanClass = 'add ';
                                } else if (index === 2) {
                                    spanClass = 'edit ';
                                } else if (index === 3) {
                                    spanClass = 'remove ';
                                }
                                if (gridData[jstreeGridId]['permissions'][index] == '0') {
                                    spanClass += 'text-danger cursor-pointer';
                                    spanData = '<i class="fa fa-fw fa-times-circle"></i>';
                                    $(this).children('span').removeClass('empty');
                                } else if (gridData[jstreeGridId]['permissions'][index] == '1') {
                                    spanClass += 'text-success cursor-pointer';
                                    spanData = '<i class="fa fa-fw fa-check-circle"></i>';
                                    $(this).children('span').removeClass('empty');
                                } else {
                                    spanClass = 'na';
                                    spanData = '<p class="text-secondary">-</p>';
                                }
                                $(this).children('span').addClass(spanClass).html(spanData);
                            }
                        );
                    }
                    extractData();
                }
                buildPermissionsGrid(gridData);

                //Search
                $(dataCollection['{{componentId}}']['{{componentId}}-{{sectionId}}']['{{componentId}}-{{sectionId}}-permissions']['jstree'])
                    .on('search.jstree after_open.jstree after_close.jstree close_all.jstree open_all.jstree', function(e, data) {
                        var notHidden = $('#{{componentId}}-{{sectionId}}-permissions').find('.jstree-node').not('.jstree-hidden');

                        $('#{{componentId}}-{{sectionId}}-permissions-tree-search-input').keyup(function() {
                            if ($('#{{componentId}}-{{sectionId}}-permissions-tree-search-input').val() === '') {
                                $('#{{componentId}}-{{sectionId}}-permissions .bg-info').removeClass('bg-info');
                                $('.jstree-grid-wrapper .bg-info').removeClass('bg-info');
                                buildPermissionsGrid(gridData);
                            } else {
                                $('#{{componentId}}-{{sectionId}}-permissions .bg-info').removeClass('bg-info');
                                $('.jstree-grid-wrapper .bg-info').removeClass('bg-info');
                                $('.jstree-search').addClass('bg-info');
                            }
                        });

                        buildPermissionsGrid(gridData);
                });

                function findSiblings(id) {
                    return $('.jstree-grid-wrapper').find('[data-jstreegrid="' + id + '"]');
                }

                //Click Toggle
                $(dataCollection['{{componentId}}']['{{componentId}}-{{sectionId}}']['{{componentId}}-{{sectionId}}-permissions']['jstree'])
                    .on('select_cell.jstree-grid', function(e, data) {
                        toggleGridCell($(data.grid)[0].id, $(data.node)[0].id, false, null);
                    }
                );

                function toggleGridCell(dataGridId, dataNodeId, bulk, bulkState) {
                    //eslint-disable-next-line
                    // console.log(dataGridId, dataNodeId, bulk, bulkState);
                    // Only run on columns that have data and are not empty or na (N/A)
                    if (!$('#' + dataGridId).children('span').hasClass('empty') && !$('#' + dataGridId).children('span').hasClass('na')) {
                        parents = gridData[dataNodeId]['parents'];
                        children = gridData[dataNodeId]['children'];
                        var siblings = findSiblings(dataNodeId);
                        //eslint-disable-next-line
                        // console.log(siblings);
                        var viewId, viewState, myState;

                        viewId = $(siblings)[0].id;

                        if ($('#' + viewId).children('span').hasClass('text-danger')) {
                            viewState = 'deny';
                        } else if ($('#' + viewId).children('span').hasClass('text-success')) {
                            viewState = 'permit';
                        }

                        if ($('#' + dataGridId).children('span').hasClass('text-danger')) {
                            myState = 'deny';
                        } else if ($('#' + dataGridId).children('span').hasClass('text-success')) {
                            myState = 'permit'
                        }

                        if (bulkState === true) {
                            viewState = 'deny';
                        } else if (bulkState === false) {
                            viewState = 'permit';
                        }
                        //We only need this to store data at the moment. If the array is going to be named array like view => 0, then we dont need this.
                        var colNum, column;
                        column = dataGridId.split('col');
                        colNum = column[1] - 1;
                        //eslint-disable-next-line
                        // console.log(viewState, myState);
                        if (viewState === 'deny' && myState === 'deny') {
                        // if ($('#' + dataGridId).children('span').hasClass('text-danger') || $('#' + dataGridId).children('span').hasClass('text-secondary')) {
                            $('#' + dataGridId).children('span').removeClass('text-danger').addClass('text-success');
                            $('#' + dataGridId).children('span').html('<i class="fas fa-fw fa-check-circle"></i>');
                            $('#' + viewId).children('span').removeClass('text-danger').addClass('text-success');
                            $('#' + viewId).children('span').html('<i class="fas fa-fw fa-check-circle"></i>');
                            gridData[dataNodeId]['permissions'][0] = '1';
                            gridData[dataNodeId]['permissions'][colNum] = '1';
                        } else if (viewState === 'permit' && myState === 'permit') {
                        // } else if ($('#' + dataGridId).children('span').hasClass('text-success')) {
                            $('#' + dataGridId).children('span').removeClass('text-success').addClass('text-danger');
                            $('#' + dataGridId).children('span').html('<i class="fas fa-fw fa-times-circle"></i>');
                            gridData[dataNodeId]['permissions'][colNum] = '0';
                        } else if (viewState === 'permit' && myState === 'deny') {
                            $('#' + dataGridId).children('span').removeClass('text-danger').addClass('text-success');
                            $('#' + dataGridId).children('span').html('<i class="fas fa-fw fa-check-circle"></i>');
                            gridData[dataNodeId]['permissions'][colNum] = '1';
                        }

                        // Disable all siblings if view is disabled
                        if ($('#' + dataGridId)[0].id === viewId) {
                            if (children.length === 0) {
                                if (!bulk) {
                                    if (viewState === 'permit') {
                                        $.each(siblings, function(index, sibl) {
                                            if (index > 0) {
                                                if (!$(sibl).children('span').hasClass('empty') && !$(sibl).children('span').hasClass('na')) {
                                                    $(sibl).children('span').removeClass('text-success').addClass('text-danger');
                                                    $(sibl).children('span').html('<i class="fas fa-fw fa-times-circle"></i>');
                                                    gridData[dataNodeId]['permissions'][index] = '0';
                                                }
                                            }
                                        });
                                    } else if (viewState === 'deny') {
                                        $.each(siblings, function(index, sibl) {
                                            if (index > 0) {
                                                if (!$(sibl).children('span').hasClass('empty') && !$(sibl).children('span').hasClass('na')) {
                                                    $(sibl).children('span').removeClass('text-success').addClass('text-danger');
                                                    $(sibl).children('span').html('<i class="fas fa-fw fa-times-circle"></i>');
                                                    gridData[dataNodeId]['permissions'][index] = '0';
                                                }
                                            }
                                        });
                                    }
                                } else {
                                    //
                                }
                            }
                        }

                        // if (!bulk) {
                        //     // Disable children if parent is deny
                        //     if (children.length > 0) {
                        //         toggleChildren(children, dataGridId);
                        //     }
                        //     // Enable parent if child is enabled
                        //     if (parents.length > 0) {
                        //         toggleParents(parents, siblings, viewId, viewState);
                        //     }
                        // }
                    }
                    extractData();
                }

                // function toggleParents(parents, siblings, viewId, viewState) {
                //     $.each(parents, function(index, parent) {
                //         var parentColumn = $('.jstree-grid-wrapper').find('[data-jstreegrid="' + parent + '"]')[0];//Only View
                //         if ($(parentColumn).children('span').hasClass('text-danger')) {
                //             $(parentColumn).children('span').removeClass('text-danger').addClass('text-success');
                //             $(parentColumn).children('span').html('<i class="fas fa-fw fa-check-circle"></i>');
                //             gridData[$(parentColumn).data('jstreegrid')]['permissions'][0][0] = '1';
                //         }
                //     });
                //     $.each(siblings, function(index, sibl) {
                //         if (viewState === 'deny' || viewState === 'disabled') {
                //             // if ($(sibl)[0].id !== viewId) {
                //             //     if ($(sibl).children('span').hasClass('text-secondary')) {
                //             //         $(sibl).children('span').removeClass('text-secondary').addClass('text-danger');
                //             //         gridData[$(sibl).data('jstreegrid')]['permissions'][0][index] = '0';
                //             //     }
                //             // } else {
                //                 $(sibl).children('span').removeClass('text-danger').addClass('text-success');
                //                 $(sibl).children('span').html('<i class="fas fa-fw fa-check-circle"></i>');
                //                 gridData[$(sibl).data('jstreegrid')]['permissions'][0][index] = '1';
                //             // }
                //         }
                //     });
                // }

                // function toggleChildren(children, dataGridId) {
                //     var childrenRemoveClass, childrenAddClass, childrenIcon, childrenPermissionData;
                //     $.each(children, function(index, child) {
                //         var childColumns = $('.jstree-grid-wrapper').find('[data-jstreegrid="' + child + '"]');
                //         if ($('#' + dataGridId).children('span').hasClass('text-danger')) {
                //             var siblings = $('.jstree-grid-wrapper').find('[data-jstreegrid="' + child + '"]');
                //             childrenRemoveClass = 'text-danger text-success';
                //             childrenAddClass = 'text-danger';
                //             childrenIcon = 'times';
                //             childrenPermissionData = '0';
                //         } else if ($('#' + dataGridId).children('span').hasClass('text-success')) {
                //             childrenRemoveClass = 'text-danger text-success';
                //             childrenAddClass = 'text-danger';
                //             childrenIcon = 'times';
                //             childrenPermissionData = '0';
                //         }
                //         $(childColumns).children('span').removeClass(childrenRemoveClass).addClass(childrenAddClass);
                //         $(childColumns).children('span').html('<i class="fas fa-fw fa-' + childrenIcon + '-circle"></i>');
                //         $.each(childColumns, function(index, childColumn) {
                //             gridData[child]['permissions'][0][index] = childrenPermissionData;
                //         });
                //     });
                // }

                (function registerBulkButtons() {
                    // Bulk deny/permit (All)
                    $('#{{componentId}}-{{sectionId}}-permissions-components-denyall').click(function(e) {
                        e.preventDefault();
                        denyPermitAll(null, null, false, null);
                    });
                    $('#{{componentId}}-{{sectionId}}-permissions-components-permitall').click(function(e) {
                        e.preventDefault();
                        denyPermitAll(null, null, true, null);
                    });

                    // Bulk deny/permit (Specific Columns)
                    $('#{{componentId}}-{{sectionId}}-permissions-view-denyall').click(function(e) {
                        e.preventDefault();
                        denyPermitAll(null, null, false, true);
                    });
                    $('#{{componentId}}-{{sectionId}}-permissions-view-permitall').click(function(e) {
                        e.preventDefault();
                        denyPermitAll(this, true, null, true);
                    });

                    $('#{{componentId}}-{{sectionId}}-permissions-add-denyall, ' +
                      '#{{componentId}}-{{sectionId}}-permissions-edit-denyall, ' +
                      '#{{componentId}}-{{sectionId}}-permissions-remove-denyall')
                    .click(function(e) {
                        e.preventDefault();
                        denyPermitAll(this, false, null, null);
                    });
                    $('#{{componentId}}-{{sectionId}}-permissions-add-permitall, ' +
                      '#{{componentId}}-{{sectionId}}-permissions-edit-permitall, ' +
                      '#{{componentId}}-{{sectionId}}-permissions-remove-permitall')
                    .click(function(e) {
                        e.preventDefault();
                        denyPermitAll(this, true, null, null);
                    });
                })();

                // Function to make bulk changes
                function denyPermitAll(denyPermitPermissionIconId, permit, component, view) {
                    //eslint-disable-next-line
                    // console.log(denyPermitPermissionIconId, permit, component, view);
                    if (denyPermitPermissionIconId) {
                        var colNum, column;
                        column = $(denyPermitPermissionIconId).parents('div').next('div')[0].id.split('col');
                        colNum = column[1] - 1;
                    }
                    // Deny All in that Column
                    $.each(allIds, function(index, child) {
                        if (denyPermitPermissionIconId) {
                            // if (view) {
                                toggleGridCell(
                                    $('.jstree-grid-wrapper')
                                    .find('[data-jstreegrid="' + child.id + '"]')[colNum].id, child.id, true, permit
                                );
                            // } else {
                            //     if (!$($('.jstree-grid-wrapper').find('[data-jstreegrid="' + child.id + '"]')[colNum])
                            //             .children('span').hasClass('empty') &&
                            //         !$($('.jstree-grid-wrapper').find('[data-jstreegrid="' + child.id + '"]')[colNum])
                            //             .children('span').hasClass('na')
                            //     ) {
                            //         if (permit) {
                            //             $($('.jstree-grid-wrapper').find('[data-jstreegrid="' + child.id + '"]')[colNum])
                            //                 .children('span')
                            //                 .removeClass('text-danger')
                            //                 .addClass('text-success');
                            //             $($('.jstree-grid-wrapper').find('[data-jstreegrid="' + child.id + '"]')[colNum])
                            //                 .children('span')
                            //                 .html('<i class="fas fa-fw fa-check-circle"></i>');
                            //             gridData[child.id]['permissions'][colNum] = '1';
                            //         } else {
                            //             $($('.jstree-grid-wrapper').find('[data-jstreegrid="' + child.id + '"]')[colNum])
                            //                 .children('span')
                            //                 .removeClass('text-success')
                            //                 .addClass('text-danger');
                            //             $($('.jstree-grid-wrapper').find('[data-jstreegrid="' + child.id + '"]')[colNum])
                            //                 .children('span')
                            //                 .html('<i class="fas fa-fw fa-times-circle"></i>');
                            //             gridData[child.id]['permissions'][colNum] = '0';
                            //         }
                            //     }
                            // }
                        } else {
                            $('.jstree-grid-wrapper').find('[data-jstreegrid="' + child.id + '"]')
                                .children('span')
                                .each(function(index,span) {
                                    if (!$(span).hasClass('empty') &&
                                        !$(span).hasClass('na')) {
                                        if (component) {
                                            $(span).removeClass('text-danger').addClass('text-success');
                                            $(span).html('<i class="fas fa-fw fa-check-circle"></i>');
                                            gridData[child.id]['permissions'][index] = '1';
                                        } else {
                                            $(span).removeClass('text-success').addClass('text-danger');
                                            $(span).html('<i class="fas fa-fw fa-times-circle"></i>');
                                            gridData[child.id]['permissions'][index] = '0';
                                        }
                                    }
                            });
                        }
                    });

                    extractData();
                }

                //Extract data to post;
                function extractData() {
                    // Make a data object
                    if (!dataCollectionSectionForm['data']) {
                        dataCollectionSectionForm['data'] = { };
                    }
                    if (!dataCollectionSection['data']['permissions']) {
                        dataCollectionSection['data']['permissions'] = { };
                    }
                    // if (!dataCollectionSection['dataToSubmit']) {
                    //     dataCollectionSection['dataToSubmit'] = { };
                    // }
                    // if (!dataCollectionSection['dataToSubmit']['permissions']) {
                    //     dataCollectionSection['dataToSubmit']['permissions'] = { };
                    // }

                    var data = dataCollectionSection['data']['permissions'];
                    data['permissions'] = { };

                    for (var nodeId in gridData) {
                        data['permissions'][gridData[nodeId]['component_id']] = { };
                        data['permissions'][gridData[nodeId]['component_id']] = gridData[nodeId]['permissions'];
                    }
                    for (var checkbox in checkboxIds) {
                        data[checkboxIds[checkbox]] = { };

                        if ($('#' + checkbox)[0].checked) {
                            data[checkboxIds[checkbox]]['login'] = true;
                        } else {
                            data[checkboxIds[checkbox]]['login'] = false;
                        }
                    }

                    // dataCollectionSection['dataToSubmit']['permissions'] = JSON.stringify(data);
                }

                for (var checkbox in checkboxIds) {
                    $('#' + checkbox).click(function() {
                        extractData();
                    });
                }
            }
        }),
        //Validation
        '{{componentId}}-{{sectionId}}-form' : {
            rules: {
                '{{componentId}}-{{sectionId}}-email'       : {'required' : true, 'email' : true},
                '{{componentId}}-{{sectionId}}-role_id'     : 'required',
            },
            messages: {
                '{{componentId}}-{{sectionId}}-email'       : 'Please enter correct email address',
                '{{componentId}}-{{sectionId}}-role_id'     : 'Please select role',
            }
        }
});
</script>