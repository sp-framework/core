{% if storage is not defined %}
    {# Throw Error #}
{% endif %}

{% if sortable is not defined %}
    {% set sortable = false %}
{% endif %}

{% if tableMaxHeight is defined %}
    {% set maxheight = tableMaxHeight %}
{% else %}
    {% set maxheight = 300 %}
{% endif %}

{% if thumbnailSize is not defined %}
    {% set thumbnailSize = 30 %}
{% endif %}
{% if spotlightSize is not defined %}
    {% set spotlightSize = 1200 %}
{% endif %}

{% if maxAttachments is not defined %}
    {% set maxAttachments = 5 %}
{% endif %}

{% set allowedFileMimeType = json_encode(storage['allowed_file_mime_types']) %}
{% set allowedImageMimeType = json_encode(storage['allowed_image_mime_types']) %}

<div style="max-height: {{maxheight}}px;overflow-y: scroll;overflow-x: hidden">
    <div class="row">
        <div class="col mb-2">
            {{adminltetags.useTag('fields',
                [
                    'component'                      : component,
                    'componentName'                  : componentName,
                    'componentId'                    : componentId,
                    'sectionId'                      : sectionId,
                    'fieldId'                        : fieldId,
                    'fieldLabel'                     : fieldLabel,
                    'fieldType'                      : 'html',
                    'fieldHelp'                      : true,
                    'fieldHelpTooltipContent'        : fieldHelpTooltipContent,
                    'fieldAdditionalClass'           : 'mb-0',
                    'fieldRequired'                  : false,
                    'fieldBazScan'                   : true,
                    'fieldBazPostOnCreate'           : true,
                    'fieldBazPostOnUpdate'           : true
                ]
            )}}
            {{adminltetags.useTag('buttons',
                {
                    'componentId'            : componentId,
                    'sectionId'              : sectionId ~ '-' ~ fieldId,
                    'buttonLabel'            : false,
                    'buttonType'             : 'button',
                    'buttons'                :
                    {
                        'dropzone-upload' :
                        {
                            'title'                 : false,
                            'position'              : 'left',
                            'icon'                  : 'upload',
                            'size'                  : 'xs',
                            'buttonAdditionalClass' : 'mr-1 ml-1 btn-file'
                        },
                        'dropzone-save' :
                        {
                            'title'                 : false,
                            'position'              : 'left',
                            'icon'                  : 'save',
                            'hidden'                : true,
                            'size'                  : 'xs',
                            'buttonAdditionalClass' : 'mr-1 ml-1'
                        },
                        'dropzone-cancel' :
                        {
                            'title'                 : false,
                            'type'                  : 'secondary',
                            'position'              : 'left',
                            'icon'                  : 'times',
                            'hidden'                : true,
                            'size'                  : 'xs',
                            'buttonAdditionalClass' : 'mr-1 ml-1'
                        }
                    }
                }
            )}}
            <span id="{{componentId}}-{{sectionId}}-{{fieldId}}-dropzone-save-warning" class="text-danger" hidden>Save/Cancel Files</span>
        </div>
    </div>
    <div class="row">
        <div class="col">
            <ul class="list-group" id="{{componentId}}-{{sectionId}}-{{fieldId}}-upload-previews">
                <li class="list-group-item list-group-item-secondary {{componentId}}-{{sectionId}}-{{fieldId}}-upload-template" area-disabled="false">
                    <div class="row">
                        <div class="col-sm-2 p-1 text-center">
                            <span class="preview">
                                <img alt="" data-dz-thumbnail />
                            </span>
                        </div>
                        <div class="col-sm-8 p-1">
                            <div class="progress" style="position: relative;top: 8px;" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
                                <div class="progress progress-bar progress-bar-striped bg-success" style="width:0%;" data-dz-uploadprogress></div>
                            </div>
                        </div>
                        <div class="col-sm-2 p-1 text-center">
                            <button data-dz-remove class="btn btn-danger delete p-1">
                                <i class="fa fa-fw fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </li>
            </ul>
        </div>
    </div>
    <hr>
    <div class="row" id="{{componentId}}-{{sectionId}}-{{fieldId}}-attachment">
        <div class="col">
            <ul class="list-group" id="{{componentId}}-{{sectionId}}-{{fieldId}}-sortable-attachments">
                {% for attachment in attachments %}
                    {% if attachment['type'] === 'application/pdf' %}
                        {% set src = links.images('/general/pdf.png') %}
                        {% set alt = 'pdf' %}
                    {% elseif attachment['type'] === 'text/plain' %}
                        {% set src = links.images('/general/file.png') %}
                        {% set alt = 'file' %}
                    {% elseif attachment['type'] === 'application/msword' or attachment['type'] === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' %}
                        {% set src = links.images('/general/file.png') %}
                        {% set alt = 'file' %}
                    {% elseif attachment['type'] === 'application/vnd.ms-excel' or attachment['type'] === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' %}
                        {% set src = links.images('/general/excel.png') %}
                        {% set alt = 'excel' %}
                    {% elseif attachment['type'] === 'application/vnd.ms-powerpoint' or attachment['type'] === 'application/vnd.openxmlformats-officedocument.presentationml.presentation' %}
                        {% set src = links.images('/general/powerpoint.png') %}
                        {% set alt = 'powerpoint' %}
                    {% elseif attachment['type'] === 'application/zip' %}
                        {% set src = links.images('/general/zip.png') %}
                        {% set alt = 'zip' %}
                    {% elseif attachment['type'] === 'text/csv' %}
                        {% set src = links.images('/general/csv.png') %}
                        {% set alt = 'csv' %}
                    {% else %}
                        {% set src = links.images('/general/file-unknown.png') %}
                        {% set alt = 'Unknwon File Type' %}
                    {% endif %}

                    <li class="list-group-item list-group-item-secondary" area-disabled="false" style="cursor: pointer" data-uuid="{{attachment['uuid']}}">
                        {% if sortable is defined and sortable === true %}
                            <i class="fa fa-sort fa-fw handle"></i>
                        {% endif %}
                        {{attachment['org_file_name']}}
                        <div class="row mt-2">
                            <div class="col">
                                {% if attachment['type'] in storage['allowed_file_mime_types'] %}
                                    <img alt="{{alt}}" src="{{src}}" class="img-fluid img-thumbnail">
                                    {% set download = true %}
                                {% elseif attachment['type'] in storage['allowed_image_mime_types'] %}
                                    {% set download = false %}
                                    <a class="spotlight" href="/storages/q/uuid/{{attachment['uuid']}}/w/{{spotlightSize}}">
                                        <img alt="{{attachment['org_file_name']}}" src="/storages/q/uuid/{{attachment['uuid']}}/w/{{thumbnailSize}}" class="img-fluid img-thumbnail">
                                    </a>
                                {% else %}
                                    {% set download = true %}
                                    <img alt="{{alt}}" src="{{src}}" class="img-fluid img-thumbnail">
                                {% endif %}
                            </div>
                            <div class="col">
                                <a data-uuid="{{attachment['uuid']}}" class="uploads-delete btn btn-danger btn-xs float-right" href="#">
                                    <i class="fa fa-fw fa-trash"></i>
                                </a>
                                {% if download is defined and download === true %}
                                    {% set fileLink = links.url('storages/q/uuid/' ~ attachment["uuid"]) %}
                                    <a data-uuid="{{attachment['uuid']}}" class="uploads-download btn btn-primary btn-xs float-right mr-2" href="{{fileLink}}" target="_blank">
                                        <i class="fa fa-fw fa-download"></i>
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                    </li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>
<script>
/* globals Dropzone PNotify Swal Sortable */
if (!window['dataCollection']['{{componentId}}']) {
    window['dataCollection']['{{componentId}}'] = { };
}

window['dataCollection']['{{componentId}}']['{{componentId}}-{{sectionId}}'] =
$.extend(window['dataCollection']['{{componentId}}']['{{componentId}}-{{sectionId}}'], {
    '{{componentId}}-{{sectionId}}-{{fieldId}}'                    : {
        afterInit: function() {
            var initialFiles = $('#{{componentId}}-{{sectionId}}-{{fieldId}}-sortable-attachments li').length;
            // var uploadUUIDs = [];
            var deleteUUIDs = [];
            var filesLimit = parseInt("{{maxAttachments}}") - initialFiles;
            // var totalUploadFiles = initialFiles;
            var problemWithUpload = false;
            var sortable = Boolean('{{sortable}}');

            var fileMimeTypes = JSON.parse('{{allowedFileMimeType}}');
            var imageMimeTypes = JSON.parse('{{allowedImageMimeType}}');

            var previewNode = document.querySelector(".{{componentId}}-{{sectionId}}-{{fieldId}}-upload-template");
            previewNode.id = "";
            var previewTemplate = previewNode.parentNode.innerHTML;
            previewNode.parentNode.removeChild(previewNode);

            var fieldId =
                window['dataCollection']['{{componentId}}']['{{componentId}}-{{sectionId}}']['{{componentId}}-{{sectionId}}-{{fieldId}}'];

            initDropzone();

            function initDropzone() {
                if (fieldId['dropzone']) {
                    fieldId['dropzone'].destroy()
                }

                fieldId['dropzone'] = new Dropzone('#{{componentId}}-{{sectionId}}-{{fieldId}}', {
                    url                 : '{{links.url("storages/add")}}',
                    timeout             : 60000,
                    thumbnailWidth      : '{{thumbnailSize}}',
                    thumbnailHeight     : '{{thumbnailSize}}',
                    parallelUploads     : 5,
                    maxFiles            : filesLimit,
                    previewTemplate     : previewTemplate,
                    autoQueue           : false,
                    previewsContainer   : '#{{componentId}}-{{sectionId}}-{{fieldId}}-upload-previews',
                    clickable           : '#{{componentId}}-{{sectionId}}-{{fieldId}}-dropzone-upload'
                });

                initEvents();
                registerDeleteButtons();
                collectData();
            }

            function initEvents() {
                fieldId['dropzone'].on("addedfile", function(file) {
                    registerSaveCancel();

                    var src, alt;
                    var indexOfFile = fileMimeTypes.indexOf(file.type);
                    var indexOfImage = imageMimeTypes.indexOf(file.type);

                    if (file.type === 'application/pdf') {
                        src = "{{links.images('/general/pdf.png')}}";
                        alt = 'pdf'
                    } else if (file.type === 'text/plain') {
                        src = "{{links.images('/general/file.png')}}";
                        alt = 'file';
                    } else if (file.type === 'application/msword' ||
                               file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
                    ) {
                        src = "{{links.images('/general/file.png')}}";
                        alt = 'file';
                    } else if (file.type === 'application/vnd.ms-excel' ||
                               file.type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                    ) {
                        src = "{{links.images('/general/excel.png')}}";
                        alt = 'excel';
                    } else if (file.type === 'application/vnd.ms-powerpoint' ||
                               file.type === 'application/vnd.openxmlformats-officedocument.presentationml.presentation'
                    ) {
                        src = "{{links.images('/general/powerpoint.png')}}";
                        alt = 'powerpoint';
                    } else if (file.type === 'application/zip') {
                        src = "{{links.images('/general/zip.png')}}";
                        alt = 'zip';
                    } else if (file.type === 'text/csv') {
                        src = "{{links.images('/general/csv.png')}}";
                        alt = 'csv';
                    } else {
                        src = "{{links.images('/general/file-unknown.png')}}";
                        alt = 'Unknwon File Type';
                    }

                    if (indexOfFile !== -1 || indexOfImage !== -1) {
                        $(file.previewElement).children().first().find("[data-dz-thumbnail]").attr("src", src);
                        $(file.previewElement).children().first().find("[data-dz-thumbnail]").attr("alt", alt);

                        // totalUploadFiles = totalUploadFiles + 1;
                        // filesLimit = filesLimit - 1
                        // if (filesLimit < 0) {
                        //     fieldId['dropzone'].removeFile(file);
                        //     PNotify.error({
                        //         title: file.name + ' was not added!',
                        //         text: 'Max file limit reached'
                        //     });
                        // }
                    } else if (indexOfFile === -1 && indexOfImage === -1) {
                        fieldId['dropzone'].removeFile(file);
                        PNotify.error({
                            title: file.name,
                            text: 'Extension not allowed! File not added.'
                        });
                    }
                });

                fieldId['dropzone'].on("removedfile", function(file) {
                    if (fieldId['dropzone'].getAcceptedFiles().length === 0) {
                        $('#{{componentId}}-{{sectionId}}-{{fieldId}}-dropzone-save').attr('hidden', true);
                        $('#{{componentId}}-{{sectionId}}-{{fieldId}}-dropzone-cancel').attr('hidden', true);
                    }
                });

                fieldId['dropzone'].on("queuecomplete", function() {
                    if (deleteUUIDs.length > 0) {
                        processDeleteUUIDs();
                    } else {
                        initDropzone();
                    }
                });

                fieldId['dropzone'].on("success", function(file, response) {
                    $('#{{componentId}}-{{sectionId}}-{{fieldId}}-dropzone-save').attr('hidden', true);
                    $('#{{componentId}}-{{sectionId}}-{{fieldId}}-dropzone-cancel').attr('hidden', true);

                    if (response.tokenKey && response.token) {
                        $("#security-token").attr("name", response.tokenKey);
                        $("#security-token").val(response.token);
                    }

                    if (file.accepted && file.status === 'success') {
                        if (response.responseCode == 1) {
                            problemWithUpload = true;
                            PNotify.error({
                                title: file.name,
                                text: response.responseMessage
                            });
                        } else {
                            $(file.previewTemplate).remove();

                            var src, alt, download;
                            var indexOfFile = fileMimeTypes.indexOf(file.type);
                            var indexOfImage = imageMimeTypes.indexOf(file.type);

                            if (file.type === 'application/pdf') {
                                src = "{{links.images('/general/pdf.png')}}";
                                alt = 'pdf'
                            } else if (file.type === 'text/plain') {
                                src = "{{links.images('/general/file.png')}}";
                                alt = 'file';
                            } else if (file.type === 'application/msword' ||
                                       file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
                            ) {
                                src = "{{links.images('/general/file.png')}}";
                                alt = 'file';
                            } else if (file.type === 'application/vnd.ms-excel' ||
                                       file.type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                            ) {
                                src = "{{links.images('/general/excel.png')}}";
                                alt = 'excel';
                            } else if (file.type === 'application/vnd.ms-powerpoint' ||
                                       file.type === 'application/vnd.openxmlformats-officedocument.presentationml.presentation'
                            ) {
                                src = "{{links.images('/general/powerpoint.png')}}";
                                alt = 'powerpoint';
                            } else if (file.type === 'application/zip') {
                                src = "{{links.images('/general/zip.png')}}";
                                alt = 'zip';
                            } else if (file.type === 'text/csv') {
                                src = "{{links.images('/general/csv.png')}}";
                                alt = 'csv';
                            } else {
                                src = "{{links.images('/general/file-unknown.png')}}";
                                alt = 'Unknwon File Type';
                            }

                            var newList = '';

                            newList +=
                                '<li class="list-group-item list-group-item-secondary" area-disabled="false" style="cursor: pointer" data-uuid="' + response.storageData.uuid + '">';

                            if (sortable === true) {
                                newList +=
                                    '<i class="fa fa-sort fa-fw handle"></i>';
                            }

                            newList +=
                                file.name +
                                '<div class="row mt-2">' +
                                    '<div class="col">';

                            if (indexOfFile !== -1) {
                                newList +=
                                    '<img alt="' + alt + '" src="' + src + '" class="img-fluid img-thumbnail">';
                                download = true;
                            } else if (indexOfImage !== -1) {
                                newList +=
                                    '<a class="spotlight" href="/storages/q/uuid/' + response.storageData.uuid + '/w/{{spotlightSize}}">' +
                                        '<img alt="' + file.name + '" src="/storages/q/uuid/' + response.storageData.uuid + '/w/{{thumbnailSize}}" class="img-fluid img-thumbnail">' +
                                    '</a>';
                                download = false;
                            } else {
                                newList +=
                                    '<img alt="' + alt + '" src="' + src + '" class="img-fluid img-thumbnail">';
                                download = true;
                            }

                            newList +=
                                '</div>' +
                                    '<div class="col">' +
                                        '<a data-uuid="' + response.storageData.uuid + '" class="uploads-delete btn btn-danger btn-xs float-right" href="#">' +
                                            '<i class="fa fa-fw fa-trash"></i>' +
                                        '</a>';

                            if (download) {
                                var linksUrl = '{{links.url("storages/q/uuid/' + response.storageData.uuid + '")}}';
                                newList +=
                                    '<a data-uuid="' + response.storageData.uuid + '" class="uploads-download btn btn-primary btn-xs float-right mr-2" href="' + linksUrl + '" target="_blank">' +
                                        '<i class="fa fa-fw fa-download"></i>' +
                                    '</a>';
                            }
                            newList +=
                                    '</div>' +
                                '</div>' +
                            '</li>';

                            $('#{{componentId}}-{{sectionId}}-{{fieldId}}-sortable-attachments').append(newList);

                            filesLimit = filesLimit - 1
                        }
                    }
                });

                fieldId['dropzone'].on("error", function(file, response) {
                    if (response.tokenKey && response.token) {
                        $("#security-token").attr("name", response.tokenKey);
                        $("#security-token").val(response.token);
                    }

                    if (file.accepted === false) {
                        fieldId['dropzone'].removeFile(file);
                        PNotify.error({
                            title: 'Limit Reached!',
                            text: response + ' Did not add file ' + file.name + ' to the queue.'
                        });
                        return;
                    }

                    //Fatal Error
                    if (file.status === 'error') {
                        PNotify.error({
                            title: 'ERROR',
                            text: 'Contact Administrator!'
                        });

                        fieldId['dropzone'].removeAllFiles(true);
                        $('#{{componentId}}-{{sectionId}}-{{fieldId}}-dropzone-upload').attr('hidden', true);
                        $('#{{componentId}}-{{sectionId}}-{{fieldId}}-dropzone-save').attr('hidden', true);
                        $('#{{componentId}}-{{sectionId}}-{{fieldId}}-dropzone-cancel').attr('hidden', true);

                        return;
                    }
                });
            }

            function registerDeleteButtons() {
                $('.uploads-delete').each(function(index,button) {
                   $(button).off();
                   $(button).removeClass('disabled');

                   $(button).click(function(e) {
                        e.preventDefault();

                        $('#{{componentId}}-{{sectionId}}-{{fieldId}}-dropzone-save').attr('hidden', false);
                        $('#{{componentId}}-{{sectionId}}-{{fieldId}}-dropzone-cancel').attr('hidden', false);

                        $(this).addClass('disabled');
                        deleteUUIDs.push($(this).data('uuid'));
                        registerSaveCancel();
                    });
                });
            }

            function registerSaveCancel() {
                $('#{{componentId}}-{{sectionId}}-{{fieldId}}-dropzone-save').attr('hidden', false);
                $('#{{componentId}}-{{sectionId}}-{{fieldId}}-dropzone-save').off();
                $('#{{componentId}}-{{sectionId}}-{{fieldId}}-dropzone-save').click(function() {
                    var tokenName = $('#security-token').attr('name');
                    var token = $('#security-token').val();

                    if (fieldId['dropzone'].files.length > 0) {
                        fieldId['dropzone'].options.params = {
                            'directory'     : '{{componentName|lower}}',
                            'storagetype'   : '{{storage["permission"]}}'
                        };
                        fieldId['dropzone'].options.params[tokenName] = token;

                        fieldId['dropzone'].enqueueFiles(
                            fieldId['dropzone'].getFilesWithStatus(Dropzone.ADDED)
                        );
                    } else if (deleteUUIDs.length > 0) {
                        processDeleteUUIDs();
                    }
                });

                $('#{{componentId}}-{{sectionId}}-{{fieldId}}-dropzone-cancel').attr('hidden', false);
                $('#{{componentId}}-{{sectionId}}-{{fieldId}}-dropzone-cancel').off();
                $('#{{componentId}}-{{sectionId}}-{{fieldId}}-dropzone-cancel').click(function() {
                    fieldId['dropzone'].removeAllFiles(true);

                    $('#{{componentId}}-{{sectionId}}-{{fieldId}}-dropzone-save').attr('hidden', true);
                    $('#{{componentId}}-{{sectionId}}-{{fieldId}}-dropzone-cancel').attr('hidden', true);

                    deleteUUIDs = [];
                    registerDeleteButtons();
                });
            }

            function processDeleteUUIDs() {
                var tokenName = $('#security-token').attr('name');
                var token = $('#security-token').val();

                if (deleteUUIDs.length > 0) {
                    $(deleteUUIDs).each(function(index, uuid) {

                        var postData = { };
                        postData['uuid'] = uuid;
                        postData[tokenName] = token;
                        postData['storagetype']  = '{{storage["permission"]}}';

                        $.post('{{links.url("storages/remove")}}', postData, function(response) {
                            if (response.tokenKey && response.token) {
                                $("#security-token").attr("name", response.tokenKey);
                                $("#security-token").val(response.token);
                            }
                            if (response.responseCode != 0) {
                                PNotify.error({
                                    title: 'Error:',
                                    text: response.responseMessage
                                });
                            } else {
                                $('#{{componentId}}-{{sectionId}}-{{fieldId}}-sortable-attachments').find('[data-uuid="' + uuid + '"]')[0].remove();
                            }
                        }, 'json');
                    });

                    $('#{{componentId}}-{{sectionId}}-{{fieldId}}-dropzone-save').attr('hidden', true);
                    $('#{{componentId}}-{{sectionId}}-{{fieldId}}-dropzone-cancel').attr('hidden', true);
                    deleteUUIDs = [];
                    initDropzone();
                }
            }

            function collectData() {
                if (!window['dataCollection']['{{componentId}}']['{{componentId}}-{{sectionId}}']['data']) {
                    window['dataCollection']['{{componentId}}']['{{componentId}}-{{sectionId}}']['data'] = { };
                }
                if (!window['dataCollection']['{{componentId}}']['{{componentId}}-{{sectionId}}']['data']['{{fieldId}}']) {
                    window['dataCollection']['{{componentId}}']['{{componentId}}-{{sectionId}}']['data']['{{fieldId}}'] = { };
                }

                if (sortable) {
                    var el = document.getElementById("{{componentId}}-{{sectionId}}-{{fieldId}}-sortable-attachments");
                    fieldId['sortable'] = null;
                    fieldId['sortable'] = Sortable.create(el, {
                        dataIdAttr : 'data-uuid',
                        onEnd: function() {
                            window['dataCollection']['{{componentId}}']['{{componentId}}-{{sectionId}}']['data']['{{fieldId}}'] =
                                fieldId['sortable'].toArray();
                        }
                    });
                    window['dataCollection']['{{componentId}}']['{{componentId}}-{{sectionId}}']['data']['{{fieldId}}'] =
                        fieldId['sortable'].toArray();
                } else {
                    fieldId['uuidData'] = [];
                    $('#{{componentId}}-{{sectionId}}-{{fieldId}}-sortable-attachments li').each(function(index,li) {
                        fieldId['uuidData'].push($(li).data('uuid'));
                    });

                    window['dataCollection']['{{componentId}}']['{{componentId}}-{{sectionId}}']['data']['{{fieldId}}'] =
                        fieldId['uuidData'];
                }
            }
        }
    }
});
</script>