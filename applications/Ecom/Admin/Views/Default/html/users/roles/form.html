{% if role['id'] is defined %}
    {% set roleId = role['id'] %}
    {% set roleName = role['name'] %}
    {% set roleDescription = role['description'] %}
{% else %}
    {% set roleId = '' %}
    {% set roleName = '' %}
    {% set roleDescription = '' %}
{% endif %}
{% set rolePermissions = role['permissions'] %}
<form data-validateon="section" id="{{componentId}}-{{sectionId}}-form">
    <fieldset id="{{componentId}}-{{sectionId}}-fieldset">
        <div class="row">
            <div class="col">
                {{adminltetags.useTag('fields',
                    [
                        'component'                      : component,
                        'componentName'                  : componentName,
                        'componentId'                    : componentId,
                        'sectionId'                      : sectionId,
                        'fieldId'                        : 'id',
                        'fieldLabel'                     : 'Role ID',
                        'fieldType'                      : 'input',
                        'fieldHelp'                      : true,
                        'fieldHelpTooltipContent'        : 'Role ID',
                        'fieldRequired'                  : true,
                        'fieldBazScan'                   : true,
                        'fieldBazPostOnCreate'           : false,
                        'fieldBazPostOnUpdate'           : true,
                        'fieldHidden'                    : true,
                        'fieldDisabled'                  : true,
                        'fieldValue'                     : roleId
                    ]
                )}}
            </div>
        </div>
        <div class="row">
            <div class="col">
                {{adminltetags.useTag('fields',
                    [
                        'component'                      : component,
                        'componentName'                  : componentName,
                        'componentId'                    : componentId,
                        'sectionId'                      : sectionId,
                        'fieldId'                        : 'name',
                        'fieldLabel'                     : 'Role Name',
                        'fieldType'                      : 'input',
                        'fieldHelp'                      : true,
                        'fieldHelpTooltipContent'        : 'Name of the role. Example: Sales Manager',
                        'fieldRequired'                  : true,
                        'fieldBazScan'                   : true,
                        'fieldBazPostOnCreate'           : true,
                        'fieldBazPostOnUpdate'           : true,
                        'fieldDataInputMinLength'        : 1,
                        'fieldDataInputMaxLength'        : 50,
                        'fieldValue'                     : roleName
                    ]
                )}}
            </div>
        </div>
        <div class="row">
            <div class="col">
                {{adminltetags.useTag('fields',
                    [
                        'component'                      : component,
                        'componentName'                  : componentName,
                        'componentId'                    : componentId,
                        'sectionId'                      : sectionId,
                        'fieldId'                        : 'description',
                        'fieldLabel'                     : 'Role Description',
                        'fieldType'                      : 'textarea',
                        'fieldDataMaxLength'             : 1024,
                        'fieldHelp'                      : true,
                        'fieldHelpTooltipContent'        : 'Description of the role',
                        'fieldRequired'                  : false,
                        'fieldBazScan'                   : true,
                        'fieldBazPostOnCreate'           : true,
                        'fieldBazPostOnUpdate'           : true,
                        'fieldDataInputMaxLength'        : 1024,
                        'fieldTextareaRows'              : 2,
                        'fieldValue'                     : roleDescription
                    ]
                )}}
            </div>
        </div>
        <div class="row">
            <div class="col">
                {{adminltetags.useTag('fields',
                    [
                        'component'                                   : component,
                        'componentName'                               : componentName,
                        'componentId'                                 : componentId,
                        'sectionId'                                   : sectionId,
                        'fieldId'                                     : 'permissions',
                        'fieldLabel'                                  : 'Permissions',
                        'fieldType'                                   : 'jstree',
                        'fieldHelp'                                   : true,
                        'fieldHelpTooltipContent'                     : 'Select permissions for the role',
                        'fieldRequired'                               : false,
                        'fieldBazScan'                                : true,
                        'fieldBazPostOnCreate'                        : true,
                        'fieldBazPostOnUpdate'                        : true,
                        'fieldJstreeSearch'                           : true,
                        'fieldJstreeAdd'                              : false,
                        'fieldJstreeEdit'                             : false,
                        'fieldJstreeExpand'                           : true,
                        'fieldJstreeCollapse'                         : true,
                        'fieldJstreeFirstOpen'                        : true,
                        'fieldJstreeAllOpen'                          : true,
                        'fieldJstreeToggleAllChildren'                : false,
                        'fieldJstreeIncludeRootInPath'                : false,
                        'fieldJstreeRootIcon'                         : 'lock',
                        'fieldJstreeSelectEndNodeOnly'                : false,
                        'fieldJstreeShowDots'                         : true,
                        'fieldJstreeDoubleClickToggle'                : true,
                        'fieldJstreeMultiple'                         : false,
                        'fieldJstreeSearchCaseSensitive'              : false,
                        'fieldJstreeSearchShowOnlyMatches'            : false,
                        'fieldJstreeSearchShowOnlyMatchesChildren'    : false,
                        'fieldJstreeHideJstreeIcons'                  : false,
                        'dataSrcArr' :
                            [
                                'components'   :
                                    [
                                        'srcArr'                : components
                                    ]
                            ]
                    ]
                )}}
            </div>
        </div>
    </fieldset>
</form>
<script>
var acls = JSON.parse('{{acls}}');
var gridColumns = [];
gridColumns.push(
    {
        header          :   '<p class="text-center mb-0">' +
                                '<span class="cursor-pointer">' +
                                    '<i id="{{componentId}}-{{sectionId}}-permissions-components-denyall" ' +
                                        'data-toggle="tooltip" data-html="true" data-placement="bottom" '+
                                        'data-original-title="Deny All" class="fas fa-fw fa-times-circle ' +
                                        'mr-1 text-danger helper components">' +
                                    '</i>' +
                                '</span>' +
                                    ' COMPONENTS ' +
                                '<span class="cursor-pointer">' +
                                    '<i id="{{componentId}}-{{sectionId}}-permissions-components-permitall" ' +
                                        'data-toggle="tooltip" data-html="true" data-placement="bottom" '+
                                        'data-original-title="Permit All" class="fas fa-fw fa-check-circle ' +
                                        'ml-1 text-success helper components">' +
                                    '</i>' +
                                '</span>' +
                            '</p>',
        wideCellClass   : 'text-center components',
        title           : "_DATA_",
        width           : 300
    }
);

for (var acl in acls) {
    gridColumns.push(
        {
            header          :   '<p class="text-center mb-0">' +
                                    '<span class="cursor-pointer">' +
                                        '<i id="{{componentId}}-{{sectionId}}-permissions-' + acls[acl] + '-denyall" ' +
                                            'data-toggle="tooltip" data-html="true" data-placement="bottom" '+
                                            'data-original-title="Deny all ' + acls[acl] + '" class="fas fa-fw fa-times-circle ' +
                                            'mr-1 text-danger helper ' + acls[acl] + '">' +
                                        '</i>' +
                                    '</span> ' +
                                        acls[acl].toUpperCase() +
                                    ' <span class="cursor-pointer">' +
                                        '<i id="{{componentId}}-{{sectionId}}-permissions-' + acls[acl] + '-permitall" ' +
                                            'data-toggle="tooltip" data-html="true" data-placement="bottom" '+
                                            'data-original-title="Permit all ' + acls[acl] + '" class="fas fa-fw fa-check-circle ' +
                                            'ml-1 text-success helper ' + acls[acl] + '">' +
                                        '</i>' +
                                    '</span>' +
                                '</p>',
            wideCellClass   : 'text-center ACL-' + acls[acl],
            cellClass       : 'empty ACL-' + acls[acl]
        }
    );
}
var dataCollectionComponent, dataCollectionSection, dataCollectionSectionForm;

if (!window['dataCollection']['{{componentId}}']) {
    dataCollectionComponent =
        window['dataCollection']['{{componentId}}'] = { };
} else {
    dataCollectionComponent =
        window['dataCollection']['{{componentId}}'];
}
if (!dataCollectionComponent['{{componentId}}-{{sectionId}}']) {
    dataCollectionSection =
        dataCollectionComponent['{{componentId}}-{{sectionId}}'] = { };
} else {
    dataCollectionSection =
        dataCollectionComponent['{{componentId}}-{{sectionId}}'];
}
if (!dataCollectionSection['{{componentId}}-{{sectionId}}-form']) {
    dataCollectionSectionForm =
        dataCollectionSection['{{componentId}}-{{sectionId}}-form'] = { };
} else {
    dataCollectionSectionForm =
        dataCollectionSection['{{componentId}}-{{sectionId}}-form'];
}
dataCollectionSection =
    $.extend(dataCollectionSection, {
        '{{componentId}}-{{sectionId}}-id'           : { },
        '{{componentId}}-{{sectionId}}-name'         : { },
        '{{componentId}}-{{sectionId}}-parent_id'    : {
            'placeholder'   : 'SELECT PARENT ROLE'
        },
        '{{componentId}}-{{sectionId}}-description'  : { },
        '{{componentId}}-{{sectionId}}-permissions'  :
        $.extend(dataCollectionSection['{{componentId}}-{{sectionId}}-permissions'], {
            plugins: [
                        "search",
                        "types",
                        "dnd",
                        "grid"
            ],
            grid: {
                columns: gridColumns,
                resizable   : true
            },
            afterInit : function(dataCollection) {
                //Fix Grid Width
                (function fixGrid() {
                    var gridCount = $('.jstree-grid-column').length - 1;
                    var gridWidth = $('.jstree-grid-wrapper').width();
                    var colWidth = (gridWidth - 300) / gridCount;
                    $('.jstree-grid-column').each(function(index,grid) {
                        if (index !== 0) {
                            $(grid).css({
                                width: colWidth
                            });
                        }
                    });
                })();

                var allIds, gridData, permissions, parents, children;

                allIds =
                    $(dataCollection['{{componentId}}']['{{componentId}}-{{sectionId}}']['{{componentId}}-{{sectionId}}-permissions']['jstree'])
                        .jstree(true).get_json('#', {flat: true});

                // Make a data object
                if (!dataCollection['{{componentId}}']['{{componentId}}-{{sectionId}}']['{{componentId}}-{{sectionId}}-permissions']['data']) {
                    dataCollection['{{componentId}}']['{{componentId}}-{{sectionId}}']['{{componentId}}-{{sectionId}}-permissions']['data'] = { };
                }
                gridData = dataCollection['{{componentId}}']['{{componentId}}-{{sectionId}}']['{{componentId}}-{{sectionId}}-permissions']['data'];

                permissions = JSON.parse('{{rolePermissions}}');//Parse DB Data

                for (var application in permissions) {
                    for (var component in permissions[application]) {
                        if ($('#{{componentId}}-{{sectionId}}-permissions').find('[data-id="' + component + '"]').length > 0) {
                            var jstreeId =
                                $('#{{componentId}}-{{sectionId}}-permissions').find('[data-id="' + component + '"]')[0].id;
                            gridData[jstreeId] = { };
                            gridData[jstreeId]['component_id'] = component;
                            gridData[jstreeId]['permissions'] = permissions[application][component];
                            gridData[jstreeId]['parents'] = [];
                            gridData[jstreeId]['children'] = [];
                        }
                    }
                }

                $.each(allIds, function(index, obj) {
                    if (gridData[obj.id]) {
                        var jstreeIdStructure =
                            $(dataCollection['{{componentId}}']['{{componentId}}-{{sectionId}}']['{{componentId}}-{{sectionId}}-permissions']['jstree'])
                                .jstree(true).get_json(obj.id, {flat: true})

                        $.each(jstreeIdStructure, function(index, childrenObj) {
                            if (childrenObj.id !== obj.id) {
                                gridData[obj.id]['children'].push(childrenObj.id);
                            }
                        });

                        $.each(gridData[obj.id]['children'], function(index, childrenId) {
                            gridData[childrenId]['parents'].push(obj.id);
                        });
                    }
                });

                //Build Permissions grid
                function buildPermissionsGrid(gridData) {
                    for (var jstreeGridId in gridData) {
                        $('.jstree-grid-wrapper')
                            .find('[data-jstreegrid="' + jstreeGridId + '"]')
                            .each(function(index, column) {
                                var permission, spanClass, spanData;

                                var spanClasses = $(this).children('span').attr("class").split(/\s+/);
                                $(spanClasses).each(function(index, sclass) {
                                    if (sclass.search(/ACL-.*/) === 0) {
                                        permission = sclass.replace('ACL-', '');
                                        spanClass = permission + ' ';
                                    }
                                });

                                if (gridData[jstreeGridId]['permissions'][permission] == '0') {
                                    spanClass += 'text-danger cursor-pointer';
                                    spanData = '<i class="fa fa-fw fa-times-circle"></i>';
                                    $(this).children('span').removeClass('empty');
                                } else if (gridData[jstreeGridId]['permissions'][permission] == '1') {
                                    spanClass += 'text-success cursor-pointer';
                                    spanData = '<i class="fa fa-fw fa-check-circle"></i>';
                                    $(this).children('span').removeClass('empty');
                                } else {
                                    spanClass = 'na';
                                    spanData = '<p class="text-secondary">-</p>';
                                }
                                $(this).children('span').addClass(spanClass).html(spanData);
                            }
                        );
                    }
                    extractData();
                }
                buildPermissionsGrid(gridData);

                //Search
                $(dataCollection['{{componentId}}']['{{componentId}}-{{sectionId}}']['{{componentId}}-{{sectionId}}-permissions']['jstree'])
                    .on('search.jstree after_open.jstree after_close.jstree close_all.jstree open_all.jstree', function(e, data) {
                        var notHidden = $('#{{componentId}}-{{sectionId}}-permissions').find('.jstree-node').not('.jstree-hidden');

                        $('#{{componentId}}-{{sectionId}}-permissions-tree-search-input').keyup(function() {
                            if ($('#{{componentId}}-{{sectionId}}-permissions-tree-search-input').val() === '') {
                                $('#{{componentId}}-{{sectionId}}-permissions .bg-info').removeClass('bg-info');
                                $('.jstree-grid-wrapper .bg-info').removeClass('bg-info');
                                buildPermissionsGrid(gridData);
                            } else {
                                $('#{{componentId}}-{{sectionId}}-permissions .bg-info').removeClass('bg-info');
                                $('.jstree-grid-wrapper .bg-info').removeClass('bg-info');
                                $('.jstree-search').addClass('bg-info');
                            }
                        });

                        buildPermissionsGrid(gridData);
                });

                function findSiblings(id) {
                    return $('.jstree-grid-wrapper').find('[data-jstreegrid="' + id + '"]');
                }

                //Click Toggle
                $(dataCollection['{{componentId}}']['{{componentId}}-{{sectionId}}']['{{componentId}}-{{sectionId}}-permissions']['jstree'])
                    .on('select_cell.jstree-grid', function(e, data) {
                        toggleGridCell($(data.grid)[0].id, $(data.node)[0].id, false, null);
                    }
                );

                function toggleGridCell(dataGridId, dataNodeId, bulk, bulkState) {
                    // Only run on columns that have data and are not empty or na (N/A)
                    if (!$('#' + dataGridId).children('span').hasClass('empty') && !$('#' + dataGridId).children('span').hasClass('na')) {
                        parents = gridData[dataNodeId]['parents'];
                        children = gridData[dataNodeId]['children'];
                        var siblings = findSiblings(dataNodeId);
                        var viewId, viewState, myState;

                        viewId = $(siblings)[0].id;

                        if ($('#' + viewId).children('span').hasClass('text-danger')) {
                            viewState = 'deny';
                        } else if ($('#' + viewId).children('span').hasClass('text-success')) {
                            viewState = 'permit';
                        }

                        if ($('#' + dataGridId).children('span').hasClass('text-danger')) {
                            myState = 'deny';
                        } else if ($('#' + dataGridId).children('span').hasClass('text-success')) {
                            myState = 'permit'
                        }

                        if (bulkState === true) {
                            viewState = 'deny';
                        } else if (bulkState === false) {
                            viewState = 'permit';
                        }
                        //We only need this to store data at the moment. If the array is going to be named array like view => 0, then we dont need this.
                        var permission, spanClass, spanData;
                        var spanClasses = $('#' + dataGridId).children('span').attr("class").split(/\s+/);
                        $(spanClasses).each(function(index, sclass) {
                            if (sclass.search(/ACL-.*/) === 0) {
                                permission = sclass.replace('ACL-', '');
                                spanClass = permission + ' ';
                            }
                        });
                        if (viewState === 'deny' && myState === 'deny') {
                            $('#' + dataGridId).children('span').removeClass('text-danger').addClass('text-success');
                            $('#' + dataGridId).children('span').html('<i class="fas fa-fw fa-check-circle"></i>');
                            $('#' + viewId).children('span').removeClass('text-danger').addClass('text-success');
                            $('#' + viewId).children('span').html('<i class="fas fa-fw fa-check-circle"></i>');
                            gridData[dataNodeId]['permissions']['view'] = 1;
                            gridData[dataNodeId]['permissions'][permission] = 1;
                        } else if (viewState === 'permit' && myState === 'permit') {
                            $('#' + dataGridId).children('span').removeClass('text-success').addClass('text-danger');
                            $('#' + dataGridId).children('span').html('<i class="fas fa-fw fa-times-circle"></i>');
                            gridData[dataNodeId]['permissions'][permission] = 0;
                        } else if (viewState === 'permit' && myState === 'deny') {
                            $('#' + dataGridId).children('span').removeClass('text-danger').addClass('text-success');
                            $('#' + dataGridId).children('span').html('<i class="fas fa-fw fa-check-circle"></i>');
                            gridData[dataNodeId]['permissions'][permission] = 1;
                        }

                        // Disable all siblings if view is disabled
                        if ($('#' + dataGridId)[0].id === viewId) {
                            if (children.length === 0) {
                                if (!bulk) {
                                    if (viewState === 'permit') {
                                        $.each(siblings, function(index, sibl) {
                                            if (index > 0) {
                                                if (!$(sibl).children('span').hasClass('empty') && !$(sibl).children('span').hasClass('na')) {
                                                    var permission, spanClass, spanData;
                                                    var spanClasses = $(sibl).children('span').attr("class").split(/\s+/);
                                                    $(spanClasses).each(function(index, sclass) {
                                                        if (sclass.search(/ACL-.*/) === 0) {
                                                            permission = sclass.replace('ACL-', '');
                                                            spanClass = permission + ' ';
                                                        }
                                                        gridData[dataNodeId]['permissions'][permission] = 0;
                                                    });
                                                    $(sibl).children('span').removeClass('text-success').addClass('text-danger');
                                                    $(sibl).children('span').html('<i class="fas fa-fw fa-times-circle"></i>');
                                                }
                                            }
                                        });
                                    } else if (viewState === 'deny') {
                                        $.each(siblings, function(index, sibl) {
                                            if (index > 0) {
                                                if (!$(sibl).children('span').hasClass('empty') && !$(sibl).children('span').hasClass('na')) {
                                                    var permission, spanClass, spanData;
                                                    var spanClasses = $(sibl).children('span').attr("class").split(/\s+/);
                                                    $(spanClasses).each(function(index, sclass) {
                                                        if (sclass.search(/ACL-.*/) === 0) {
                                                            permission = sclass.replace('ACL-', '');
                                                            spanClass = permission + ' ';
                                                        }
                                                        gridData[dataNodeId]['permissions'][permission] = 0;
                                                    });
                                                    $(sibl).children('span').removeClass('text-success').addClass('text-danger');
                                                    $(sibl).children('span').html('<i class="fas fa-fw fa-times-circle"></i>');
                                                }
                                            }
                                        });
                                    }
                                } else {
                                    //
                                }
                            }
                        }
                    }
                    extractData();
                }

                (function registerBulkButtons() {
                    // Bulk deny/permit (All)
                    $('#{{componentId}}-{{sectionId}}-permissions-components-denyall').click(function(e) {
                        e.preventDefault();
                        denyPermitAll(null, null, false, null);
                    });
                    $('#{{componentId}}-{{sectionId}}-permissions-components-permitall').click(function(e) {
                        e.preventDefault();
                        denyPermitAll(null, null, true, null);
                    });

                    for (var aclAll in acls) {
                        $('#{{componentId}}-{{sectionId}}-permissions-' + acls[aclAll] + '-denyall').click(function(e) {
                            e.preventDefault();

                            if ($(this)[0].id === '{{componentId}}-{{sectionId}}-permissions-view-denyall') {
                                denyPermitAll(null, null, false, true);
                            } else {
                                denyPermitAll(this, false, null, null);
                            }
                        });
                        $('#{{componentId}}-{{sectionId}}-permissions-' + acls[aclAll] + '-permitall').click(function(e) {
                            e.preventDefault();
                            if ($(this)[0].id === '{{componentId}}-{{sectionId}}-permissions-view-permitall') {
                                denyPermitAll(this, true, null, true);
                            } else {
                                denyPermitAll(this, true, null, null);
                            }
                        });
                    }
                })();

                // Function to make bulk changes
                function denyPermitAll(denyPermitPermissionIconId, permit, component, view) {
                    if (denyPermitPermissionIconId) {
                        var colNum, column;
                        column = $(denyPermitPermissionIconId).parents('div').next('div')[0].id.split('col');
                        colNum = column[1] - 1;
                    }
                    // Deny All in that Column
                    $.each(allIds, function(index, child) {
                        if (denyPermitPermissionIconId) {
                            toggleGridCell(
                                $('.jstree-grid-wrapper')
                                .find('[data-jstreegrid="' + child.id + '"]')[colNum].id, child.id, true, permit
                            );
                        } else {
                            $('.jstree-grid-wrapper').find('[data-jstreegrid="' + child.id + '"]')
                                .children('span')
                                .each(function(index,span) {
                                    if (!$(span).hasClass('empty') &&
                                        !$(span).hasClass('na')) {

                                        var permission, spanClass, spanData;
                                        var spanClasses = $(span).attr("class").split(/\s+/);
                                        $(spanClasses).each(function(index, sclass) {
                                            if (sclass.search(/ACL-.*/) === 0) {
                                                permission = sclass.replace('ACL-', '');
                                                spanClass = permission + ' ';
                                            }
                                            if (component) {
                                                $(span).removeClass('text-danger').addClass('text-success');
                                                $(span).html('<i class="fas fa-fw fa-check-circle"></i>');
                                                gridData[child.id]['permissions'][permission] = 1;
                                            } else {
                                                $(span).removeClass('text-success').addClass('text-danger');
                                                $(span).html('<i class="fas fa-fw fa-times-circle"></i>');
                                                gridData[child.id]['permissions'][permission] = 0;
                                            }
                                        });

                                    }
                            });
                        }
                    });
                    extractData();
                }

                //Extract data to post;
                function extractData() {
                    // Make a data object
                    if (!dataCollectionSectionForm['data']) {
                        dataCollectionSectionForm['data'] = { };
                    }
                    if (!dataCollectionSection['data']['permissions']) {
                        dataCollectionSection['data']['permissions'] = { };
                    }

                    var data = dataCollectionSection['data']['permissions'];

                    for (var nodeId in gridData) {
                        data[gridData[nodeId]['component_id']] = gridData[nodeId]['permissions'];
                    }
                }
            }
        }),
        //Validation
        '{{componentId}}-{{sectionId}}-form' : {
            rules: {
                '{{componentId}}-{{sectionId}}-name'     : 'required',
                '{{componentId}}-{{sectionId}}-parent_id': 'required',
            },
            messages: {
                '{{componentId}}-{{sectionId}}-name'     : 'Please enter role name',
                '{{componentId}}-{{sectionId}}-parent_id': 'Please select parent role',
            }
        }
});
</script>