<script>
/*global BazCore */
BazCore.header({
    loadHeaderAt : 'login'
});
</script>
<div id="{{componentId}}" class="login-box">
    <div class="card m-0">
        <div class="card-body login-card-body">
            <div class="login-logo">
                <img src="{{links.images(assets.get('branding').getCodes()[3].getContent())}}" data-rjs="3" alt="Bazaari Logo">
            </div>
            <div id="{{componentId}}-regular" hidden>
                <p class="login-box-msg text-sm font-weight-bold">Password Reset</p>
                <div id="{{componentId}}-form">
                    <div class="row">
                        <div class="col">
                            {{adminltetags.useTag('fields',
                                [
                                    'componentId'                           : componentId,
                                    'sectionId'                             : 'form',
                                    'fieldId'                               : 'user',
                                    'fieldLabel'                            : false,
                                    'fieldType'                             : 'input',
                                    'fieldInputType'                        : 'text',
                                    'fieldPlaceholder'                      : 'Username',
                                    'fieldBazScan'                          : true,
                                    'fieldGroupPostAddonIcon'               : 'user'
                                ]
                            )}}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            {{adminltetags.useTag('fields',
                                [
                                    'componentId'                           : componentId,
                                    'sectionId'                             : 'form',
                                    'fieldId'                               : 'pass',
                                    'fieldLabel'                            : false,
                                    'fieldType'                             : 'input',
                                    'fieldInputType'                        : 'password',
                                    'fieldPlaceholder'                      : 'Current Password',
                                    'fieldBazScan'                          : true,
                                    'fieldGroupPostAddonButtonId'            : 'visibility',
                                    'fieldGroupPostAddonButtonValue'         : '<i class="fas fa-fw fa-eye-slash"></i>',
                                    'fieldGroupPostAddonButtonTooltipTitle'  : false
                                ]
                            )}}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            {{adminltetags.useTag('fields',
                                [
                                    'componentId'                           : componentId,
                                    'sectionId'                             : 'form',
                                    'fieldId'                               : 'newpass',
                                    'fieldLabel'                            : false,
                                    'fieldType'                             : 'input',
                                    'fieldInputType'                        : 'password',
                                    'fieldPlaceholder'                      : 'New Password',
                                    'fieldBazScan'                          : true,
                                    'fieldGroupPostAddonButtonId'           : 'visibility',
                                    'fieldGroupPostAddonButtonValue'        : '<i class="fas fa-fw fa-eye-slash"></i>',
                                    'fieldGroupPostAddonButtonTooltipTitle' : false,
                                    'fieldAdditionalClass'                  : 'mb-0',
                                    'fieldGroupPreAddonButtons'             :
                                        {
                                            'password_generate'             : {
                                                'title'                         : false,
                                                'icon'                          : 'wand-magic-sparkles',
                                                'noMargin'                      : true,
                                                'buttonAdditionalClass'         : 'rounded-0'
                                            }
                                        }
                                ]
                            )}}
                            {{adminltetags.useTag('fields',
                                [
                                    'componentId'                           : componentId,
                                    'sectionId'                             : 'form',
                                    'fieldId'                               : 'strength-meter',
                                    'fieldLabel'                            : false,
                                    'fieldHidden'                           : false,
                                    'fieldType'                             : 'html',
                                    'fieldRequired'                         : false,
                                    'fieldBazScan'                          : true,
                                    'fieldBazPostOnCreate'                  : false,
                                    'fieldBazPostOnUpdate'                  : false
                                ]
                            )}}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            {{adminltetags.useTag('fields',
                                [
                                    'componentId'                           : componentId,
                                    'sectionId'                             : 'form',
                                    'fieldId'                               : 'confirmnewpass',
                                    'fieldLabel'                            : false,
                                    'fieldType'                             : 'input',
                                    'fieldInputType'                        : 'password',
                                    'fieldPlaceholder'                      : 'Confirm New Password',
                                    'fieldBazScan'                          : true,
                                    'fieldGroupPostAddonButtonId'           : 'visibility',
                                    'fieldGroupPostAddonButtonValue'        : '<i class="fas fa-fw fa-eye-slash"></i>',
                                    'fieldGroupPostAddonButtonTooltipTitle' : false
                                ]
                            )}}
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col">
                            <button id="{{componentId}}-form-reset" type="button" class="btn btn-info float-right">
                                <i class="fa fa-cog fa-spin login-spinner" hidden></i>
                                <span class="text-uppercase">Reset</span>
                            </button>
                        </div>
                    </div>
                </div>
                {% include 'auth/footer.html' %}
            </div>
        </div>
    </div>
</div>
<script>
/*global BazCore PNotify */
$(document).ready(function(){

    $('#{{componentId}}-regular').attr('hidden', false).addClass('animated fadeIn');
    $('#{{componentId}}-form-user').focus();

    BazCore.footer({
        loadFooterAt : 'auth'
    });

    // Slideshow
    $('body').vegas({
        delay: 300000,
        timer: false,
        shuffle: true,
        slides: [
        { src: '{{links.images("/vegas/2.4.4/images/wp1.jpg")}}' },
        { src: '{{links.images("/vegas/2.4.4/images/wp2.jpg")}}' },
        { src: '{{links.images("/vegas/2.4.4/images/wp3.jpg")}}' },
        { src: '{{links.images("/vegas/2.4.4/images/wp4.jpg")}}' },
        { src: '{{links.images("/vegas/2.4.4/images/wp5.jpg")}}' },
        { src: '{{links.images("/vegas/2.4.4/images/wp6.jpg")}}' },
        { src: '{{links.images("/vegas/2.4.4/images/wp7.jpg")}}' },
        { src: '{{links.images("/vegas/2.4.4/images/wp8.jpg")}}' },
        { src: '{{links.images("/vegas/2.4.4/images/wp9.jpg")}}' },
        { src: '{{links.images("/vegas/2.4.4/images/wp10.jpg")}}' }
        ],
        overlay: '{{links.images("/vegas/2.4.4/overlays/01.png")}}'
    });

    var url, thisButton, countDownTimer;
    var postData = { };
    function getAjaxUrlData(thisButton) {
        $('#{{componentId}}-form-auth, ' +
          '#{{componentId}}-form-forgot, ' +
          '#{{componentId}}-form-reset, ' +
          '#{{componentId}}-form-send-verification, ' +
          '#{{componentId}}-form-send-2faemail, ' +
          '#{{componentId}}-form-verify').attr('disabled', true);

        $('.login-spinner').attr('hidden', false);

        if ($('#{{componentId}}-form-auth').length > 0) {
            if ($('#twofa-email').hasClass('d-none') === false) {
                if (thisButton.id === '{{componentId}}-form-send-2faemail') {
                    url = '{{links.url("auth/sendtwofaemail")}}';
                    postData = {
                        'user'      : $('#{{componentId}}-form-user').val().trim(),
                        'pass'      : $('#{{componentId}}-form-pass').val().trim()
                    };
                    clearInterval(countDownTimer);
                } else {
                    url = '{{links.url("auth/login")}}';
                    postData = {
                        'user'          : $('#{{componentId}}-form-user').val().trim(),
                        'pass'          : $('#{{componentId}}-form-pass').val().trim(),
                        'code'          : $('#{{componentId}}-form-twofa-email').val().trim(),
                        'twofa_using'   : 'email'
                    };
                }
            } else {
                url = '{{links.url("auth/login")}}';
                postData = {
                    'user'      : $('#{{componentId}}-form-user').val().trim(),
                    'pass'      : $('#{{componentId}}-form-pass').val().trim(),
                    'remember'  : $('#{{componentId}}-form-remember')[0].checked
                };

                if ($('#{{componentId}}-form-twofa-totp').val().trim() !== '') {
                    postData['code'] = $('#{{componentId}}-form-twofa-totp').val().trim();
                    postData['twofa_using'] = 'totp';
                }
            }
        } else if ($('#{{componentId}}-form-forgot').length > 0) {
            url = '{{links.url("auth/forgot")}}';
            postData = {
                'user'      : $('#{{componentId}}-form-user').val().trim()
            };
        } else if ($('#{{componentId}}-form-reset').length > 0) {
            url = '{{links.url("auth/pwreset")}}';
            postData = {
                'user'              : $('#{{componentId}}-form-user').val().trim(),
                'pass'              : $('#{{componentId}}-form-pass').val().trim(),
                'newpass'           : $('#{{componentId}}-form-newpass').val().trim(),
                'confirmnewpass'    : $('#{{componentId}}-form-confirmnewpass').val().trim()
            };
        } else if ($('#{{componentId}}-form-send-verification').length > 0) {
            if (thisButton.id === '{{componentId}}-form-send-verification') {
                url = '{{links.url("auth/sendVerification")}}';
            } else if (thisButton.id === '{{componentId}}-form-verify') {
                postData = {
                    'code'          : $('#{{componentId}}-form-verification-code').val().trim()
                };
                url = '{{links.url("auth/verify")}}';
            }
        } else if ($('#{{componentId}}-form-generate-code').length > 0) {
            url = '{{links.url("auth/enableTwoFaTotp")}}';
            postData = {
                'user'              : $('#{{componentId}}-form-user').val().trim(),
                'pass'              : $('#{{componentId}}-form-pass').val().trim()
            };
        }
        postData[$('#security-token').attr('name')] = $('#security-token').val();
    }

    $('#{{componentId}}-form-auth, ' +
      '#{{componentId}}-form-forgot, ' +
      '#{{componentId}}-form-reset, ' +
      '#{{componentId}}-form-send-verification, ' +
      '#{{componentId}}-form-send-2faemail, ' +
      '#{{componentId}}-form-generate-code, ' +
      '#{{componentId}}-form-verify').click(function(e) {
            e.preventDefault();
            thisButton = this;
            getAjaxUrlData(thisButton);
            runAjax();
        });

    if ($('#{{componentId}}-form-send-verification').length === 0) {
        $('body').keyup(function(e) {
            if (e.keyCode === 13) {
                e.preventDefault();
                getAjaxUrlData();
                runAjax();
            }
        });
    }

    function runAjax() {
        $.ajax({
            url             : url,
            data            : postData,
            method          : 'post',
            dataType        : 'json',
            beforeSend      : function() {
                                    $("#{{componentId}}-form :input").prop("disabled", true);
                                },
            error           : function(response) {
                                    if (response.getResponseHeader('redirect_url')) {
                                        window.location = response.getResponseHeader('redirect_url');
                                    }
                                    $('.login-box-msg').text('Error! Please contact administrator.');
                                    failed();
                                },
            success         : function(response) {
                                if (response.responseCode == '0') {
                                    $('.login-box-msg').text(response.responseMessage);
                                    if (response) {
                                        success(response);
                                    } else {
                                        success();
                                    }
                                } else if (response.responseCode == '1') {
                                    $('.login-box-msg').text(response.responseMessage);
                                    if (response) {
                                        failed(response);
                                    } else {
                                        failed();
                                    }
                                } else if (response.responseCode == '2') {
                                    $('.login-box-msg').text(response.responseMessage);
                                    failed();
                                } else if (response.responseCode == '3') {
                                    $('.login-box-msg').text(response.responseMessage);
                                    if (response) {
                                        twoFa(response);
                                    } else {
                                        twoFa();
                                    }
                                }

                                if (response.tokenKey && response.token) {
                                    $('#security-token').attr('name', response.tokenKey);
                                    $('#security-token').val(response.token);
                                }
                            }
        });
    }

    function failed(response) {
        if (response && response.redirectUrl) {
            window.location = response.redirectUrl;
            return;
        }
        if ($('#{{componentId}}-form-auth').length > 0) {
            $('.login-spinner').attr('hidden', true);
            $('.login-box-msg').removeClass('fadeIn').addClass('text-danger animated fadeIn');
            $('#{{componentId}}-form :input').prop('disabled', false);
            if ($('#twofa-email').hasClass('d-none') === false) {
                $('#{{componentId}}-form-twofa-email').val('');
                setEmailTimer(response.responseData.code_sent_on, response.responseData.email_timeout);
            } else {
                $('#{{componentId}}-form :input').not('.token').val('');
                $('#{{componentId}}-form-user').focus();
                $('#{{componentId}}-form-auth').attr('disabled', false);
                $('#{{componentId}}-form-twofa-totp').parents('.form-group').addClass('d-none');
            }
        }
        setTimeout(function () {
            $('.login-box-msg').removeClass('text-danger text-success animated fadeIn');

            if ($('#{{componentId}}-form-auth').length > 0) {
                $('.login-box-msg').text('Login to start {{appRoute}} session');
            } else if ($('#{{componentId}}-form-forgot').length > 0) {
                $('.login-box-msg').text('Forgot Password');
            } else if ($('#{{componentId}}-form-reset').length > 0) {
                $('.login-box-msg').text('Reset Password');
            } else if ($('#{{componentId}}-form-generate-code').length > 0) {
                $('.login-box-msg').text('App requires 2 factor authentication. Setup now to login.');
            }

            $('.login-box-msg').addClass('animated fadeIn');
        }, 5000);
    }

    function twoFa(response) {
        $('.login-spinner').attr('hidden', true);
        $('.login-box-msg').removeClass('fadeIn').addClass('text-danger animated fadeIn');

        if (response.responseData['allowed_methods'].includes('totp')) {
            $('#{{componentId}}-form :input').prop('disabled', false);
            $('#{{componentId}}-form-twofa-totp').parents('.form-group').removeClass('d-none');
            $('#twofa-totp').removeClass('d-none');
            $('#{{componentId}}-form-twofa-totp').focus();
            if (!response.responseData.totp_status ||
                response.responseData.totp_status && response.responseData.totp_status != '1'
            ) {
                $('#twofa-totp-register').removeClass('d-none');
            }
        } else if (response.responseData['allowed_methods'].includes('email')) {
            $('#{{componentId}}-form :input').prop('disabled', false);
            $('#{{componentId}}-form-twofa-email').parents('.form-group').removeClass('d-none');
            $('#twofa-email').removeClass('d-none');
        }

        if (response.responseData['allowed_methods'].length > 1) {
            $('#twofa-methods').removeClass('d-none');
            $('#twofa-methods a').off();
            $('#twofa-methods a').click(function(e) {
                e.preventDefault();

                if ($('#twofa-methods').hasClass('email')) {
                    $($('#twofa-methods span')[0]).html('Use Authenticator 2FA');
                    $('#twofa-methods').removeClass('email').addClass('authenticator');
                    $('#twofa-email').removeClass('d-none');
                    $('#{{componentId}}-form-twofa-totp').parents('.form-group').addClass('d-none');
                    $('#{{componentId}}-form-twofa-totp').val('');
                    $('#{{componentId}}-form-twofa-email').parents('.form-group').removeClass('d-none');
                    $('#{{componentId}}-form-twofa-email').val('');
                    if (!response.responseData.totp_status ||
                        response.responseData.totp_status && response.responseData.totp_status != '1'
                    ) {
                        $('#twofa-totp-register').addClass('d-none');
                    }
                } else {
                    $($('#twofa-methods span')[0]).html('Use Email 2FA');
                    $('#twofa-methods').removeClass('authenticator').addClass('email');
                    $('#twofa-email').addClass('d-none');
                    $('#{{componentId}}-form-twofa-totp').parents('.form-group').removeClass('d-none');
                    $('#{{componentId}}-form-twofa-totp').val('');
                    $('#{{componentId}}-form-twofa-email').parents('.form-group').addClass('d-none');
                    $('#{{componentId}}-form-twofa-email').val('');
                    if (!response.responseData.totp_status ||
                        response.responseData.totp_status && response.responseData.totp_status != '1'
                    ) {
                        $('#twofa-totp-register').removeClass('d-none');
                    }
                }
            });


        }
        setTimeout(function () {
            $('.login-box-msg').removeClass('text-danger text-success animated fadeIn');

            if ($('#{{componentId}}-form-auth').length > 0) {
                $('.login-box-msg').text('Login to start {{appRoute}} session');
            } else if ($('#{{componentId}}-form-forgot').length > 0) {
                $('.login-box-msg').text('Forgot Password');
            } else if ($('#{{componentId}}-form-reset').length > 0) {
                $('.login-box-msg').text('Reset Password');
            }

            $('.login-box-msg').addClass('animated fadeIn');
        }, 5000);
    }

    function success(response) {
        $('.login-spinner').attr('hidden', true);
        $('.login-box-msg').removeClass('text-danger').addClass('text-success font-weight-bold');

        if ($('#{{componentId}}-form-auth').length > 0) {
            if ($('#twofa-email').hasClass('d-none') === false) {
                if (response.responseMessage && response.responseMessage.includes('Authenticated')) {
                    if (response && response.redirectUrl) {
                        window.location = response.redirectUrl;
                        return;
                    } else {
                        window.location = '/{{appRoute}}/';
                        return;
                    }
                } else {
                    $('#{{componentId}}-form :input').prop('disabled', false);
                    $('#{{componentId}}-form-twofa-email').val('');
                    setTimeout(function () {
                        $('.login-box-msg').removeClass('text-danger text-success animated fadeIn');
                        $('.login-box-msg').text('Login to start {{appRoute}} session');
                        $('.login-box-msg').addClass('animated fadeIn');
                    }, 5000);
                    setEmailTimer(null, response.responseData.email_timeout);
                }
            } else {
                if (response && response.redirectUrl) {
                    window.location = response.redirectUrl;
                    return;
                } else {
                    window.location = '/{{appRoute}}/';
                    return;
                }
            }
        } else if ($('#{{componentId}}-form-forgot').length > 0) {
            //
        } else if ($('#{{componentId}}-form-generate-code').length > 0) {
            $('#{{componentId}}-form-regenerate-code').attr('disabled', false);
            $('#{{componentId}}-form-verifycode').attr('disabled', false);
            $('#credentials-div').attr('hidden', true);
            $('#generate-div').attr('hidden', true);
            $('#regenerate-div').attr('hidden', false);
            $('#twofa-qrcode').empty().append(
                '<img src="' + response.qrcode + '" />'
            );
            $('#twofa-details').attr('hidden', false);
            $('#twofa-secret').empty().append(response.secret);
            $('#{{componentId}}-form-verifycode').off();
            $('#{{componentId}}-form-verifycode').on('input propertychange', function() {
                if ($(this).val().length === 6) {
                    $('#{{componentId}}-form-verify').attr('disabled', false);
                } else {
                    $('#{{componentId}}-form-verify').attr('disabled', true);
                }
            });

            $('#{{componentId}}-form-regenerate-code').off();
            $('#{{componentId}}-form-regenerate-code').click(function(e) {
                e.preventDefault();

                $(this).attr('disabled', true);
                $(this).children('i').attr('hidden', false);

                var postData = { };
                postData['user'] = $('#{{componentId}}-form-user').val().trim();
                postData['pass'] = $('#{{componentId}}-form-pass').val().trim();
                postData[$('#security-token').attr('name')] = $('#security-token').val();

                var url = '{{links.url("auth/enableTwoFaTotp")}}';

                $.post(url, postData, function(response) {
                    if (response.responseCode === 0) {
                        $('#twofa-qrcode').empty().append(
                            '<img src="' + response.qrcode + '" />'
                        );
                        $('#twofa-secret').empty().append(response.secret);
                    } else {
                        $('.login-box-msg').removeClass('text-success').addClass('text-danger font-weight-bold');
                        $('.login-box-msg').text(response.responseMessage);
                    }

                    if (response.tokenKey && response.token) {
                        $('#security-token').attr('name', response.tokenKey);
                        $('#security-token').val(response.token);
                    }

                    $('#{{componentId}}-form-regenerate-code').attr('disabled', false);
                    $('#{{componentId}}-form-regenerate-code').children('i').attr('hidden', true);

                }, 'json');
            });

            $('#{{componentId}}-form-verify').off();
            $('#{{componentId}}-form-verify').click(function(e) {
                e.preventDefault();

                $(this).attr('disabled', true);
                $(this).children('i').attr('hidden', false);

                var postData = { };
                postData[$('#security-token').attr('name')] = $('#security-token').val();
                postData['code'] = $('#{{componentId}}-form-verifycode').val().trim();
                postData['user'] = $('#{{componentId}}-form-user').val().trim();
                postData['pass'] = $('#{{componentId}}-form-pass').val().trim();

                var url = '{{links.url("auth/verifytwofatotp")}}';

                $.post(url, postData, function(response) {
                    if (response.responseCode === 0) {
                        $('.login-box-msg').text(response.responseMessage);
                        $('.login-box-msg').removeClass('text-danger').addClass('text-success font-weight-bold');

                        $('#login-div').attr('hidden', false);

                        if (response.redirectUrl) {
                            $('#login').attr('href', response.redirectUrl);
                        } else {
                            $('#login').attr('href', '/{{appRoute}}/');
                        }
                    } else {
                        $('.login-box-msg').removeClass('text-success').addClass('text-danger font-weight-bold');
                        $('.login-box-msg').text(response.responseMessage);
                    }

                    if (response.tokenKey && response.token) {
                        $('#security-token').attr('name', response.tokenKey);
                        $('#security-token').val(response.token);
                    }

                    $('#{{componentId}}-form-verify').attr('disabled', false);
                    $('#{{componentId}}-form-verify').children('i').attr('hidden', true);

                }, 'json');
            });
        } else if ($('#{{componentId}}-form-reset').length > 0) {
            if (response && response.redirectUrl) {
                window.location = response.redirectUrl;

                return;
            } else {
                window.location = '/{{appRoute}}/';

                return;
            }
        } else if ($('#{{componentId}}-form-send-verification').length > 0) {
            if (thisButton.id === '{{componentId}}-form-send-verification') {
                verify();
            } else if (thisButton.id === '{{componentId}}-form-verify') {
                if (response && response.redirectUrl) {
                    window.location = response.redirectUrl;
                } else {
                    window.location = '/{{appRoute}}/';
                }
            }
        }
    }

    function setEmailTimer(oldsenttime = null, emailtimeout = 60) {
        $('#{{componentId}}-form-send-2faemail').attr('disabled', true);
        $('.resend-timer').removeClass('d-none');
        var expiryTimer;

        if (oldsenttime) {
            expiryTimer = (oldsenttime * 1000) + (emailtimeout * 1000);
        } else {
            expiryTimer = new Date().getTime() + (emailtimeout * 1000);
        }

        countDownTimer = setInterval(() => {
            var seconds, now, tillExpiry;

            now = new Date().getTime();
            tillExpiry = expiryTimer - now;
            seconds = Math.floor((tillExpiry % (emailtimeout * 1000)) / 1000);

            $('.resend-timer').html('Code sent valid for ' + seconds + 's...');

            if (tillExpiry < 0) {
                clearInterval(countDownTimer);
                $('#{{componentId}}-form-send-2faemail').attr('disabled', false);
                $('.resend-timer').addClass('d-none');
            }
        }, 1000);
    }

    function verify() {
        $(thisButton).attr('hidden', true);
        $('#{{componentId}}-form-verification-code').parents('.form-group').removeClass('d-none');
        $('#{{componentId}}-form-verification-code').attr('disabled', false);
        $('#{{componentId}}-form-verify').attr('hidden', false);
        $('#{{componentId}}-form-verify').attr('disabled', false);

        setTimeout(function () {
            $('.login-box-msg').removeClass('text-danger text-success animated fadeIn');
            $('.login-box-msg').text('Enter email verification code and hit verify');
            $('.login-box-msg').addClass('animated fadeIn');
        }, 2000);
    }

    $('#{{componentId}}-form-pass-visibility, #{{componentId}}-form-newpass-visibility, #{{componentId}}-form-confirmnewpass-visibility').click(function(e) {
        e.preventDefault();

        var id = $(this)[0].id;

        if (id === '{{componentId}}-form-pass-visibility') {
            if ($('#{{componentId}}-form-pass').attr('type') === 'password') {
                $('#{{componentId}}-form-pass').attr('type', 'text');
                $('#' + id).children('i').removeClass('fa-eye-slash').addClass('fa-eye');
            } else if ($('#{{componentId}}-form-pass').attr('type') === 'text') {
                $('#{{componentId}}-form-pass').attr('type', 'password');
                $('#' + id).children('i').removeClass('fa-eye').addClass('fa-eye-slash');
            }
        } else if (id === '{{componentId}}-form-newpass-visibility') {
            if ($('#{{componentId}}-form-newpass').attr('type') === 'password') {
                $('#{{componentId}}-form-newpass').attr('type', 'text');
                $('#' + id).children('i').removeClass('fa-eye-slash').addClass('fa-eye');
            } else if ($('#{{componentId}}-form-newpass').attr('type') === 'text') {
                $('#{{componentId}}-form-newpass').attr('type', 'password');
                $('#' + id).children('i').removeClass('fa-eye').addClass('fa-eye-slash');
            }
        } else if (id === '{{componentId}}-form-confirmnewpass-visibility') {
            if ($('#{{componentId}}-form-confirmnewpass').attr('type') === 'password') {
                $('#{{componentId}}-form-confirmnewpass').attr('type', 'text');
                $('#' + id).children('i').removeClass('fa-eye-slash').addClass('fa-eye');
            } else if ($('#{{componentId}}-form-confirmnewpass').attr('type') === 'text') {
                $('#{{componentId}}-form-confirmnewpass').attr('type', 'password');
                $('#' + id).children('i').removeClass('fa-eye').addClass('fa-eye-slash');
            }
        }
    });

    $('#{{componentId}}-form-strength-meter').strengthMeter({
        "url" : '{{links.url("auth/checkPwStrength")}}'
    });

    $('#{{componentId}}-form-password_generate').click(function(e) {
        e.preventDefault();

        var postData = { };
        postData[$('#security-token').attr('name')] = $('#security-token').val();

        $.post('{{links.url("auth/generatePw")}}', postData, function(response) {
            if (response.responseCode == 0) {
                if (response.responseData) {
                    $('#{{componentId}}-form-newpass').val(response.responseData).trigger('change');
                    $('#{{componentId}}-form-confirmnewpass').val(response.responseData);
                    $('#{{componentId}}-form-newpass').attr('type', 'text');
                    $('#{{componentId}}-form-confirmnewpass').attr('type', 'text');
                }
            } else {
                PNotify.error(response.responseMessage);
            }
            if (response.tokenKey && response.token) {
                $("#security-token").attr("name", response.tokenKey);
                $("#security-token").val(response.token);
            }

            $('#{{componentId}}-form-newpass, #{{componentId}}-form-confirmnewpass').keyup(function() {
                if ($(this).val() === '') {
                    $('#{{componentId}}-form-confirmnewpass').val('');
                    $(this).attr('type', 'password');
                }
            });
        }, 'json');
    });
});
</script>