{% set tabsData =
    [
        'info'   :
        [
            'tabTitle'          : 'Info',
            'tabInclude'        : 'modules/module/info'
        ],
        'settings'   :
        [
            'tabTitle'          : 'Settings',
            'tabInclude'        : 'modules/module/settings'
        ],
        'dependencies'   :
            [
                'tabTitle'          : 'Dependencies',
                'tabInclude'        : 'modules/module/dependencies'
            ]
    ]
%}
<form data-validateon="section" id="{{componentId}}-{{sectionId}}-form">
    <fieldset id="{{componentId}}-{{sectionId}}-fieldset">
        {{adminltetags.useTag('tabs',
            [
                'component'                     : component,
                'componentName'                 : componentName,
                'componentId'                   : componentId,
                'sectionId'                     : 'main',
                'tabsId'                        : 'tabs',
                'tabsStyle'                     : 'card-outline-tabs',
                'tabsData'                      : tabsData
            ]
        )}}
    </fieldset>
</form>
<script>
var dataCollectionComponent, dataCollectionSection, dataCollectionSectionForm;

if (!window['dataCollection']['{{componentId}}']) {
    dataCollectionComponent =
        window['dataCollection']['{{componentId}}'] = { };
} else {
    dataCollectionComponent =
        window['dataCollection']['{{componentId}}'];
}
if (!dataCollectionComponent['{{componentId}}-{{sectionId}}']) {
    dataCollectionSection =
        dataCollectionComponent['{{componentId}}-{{sectionId}}'] = { };
} else {
    dataCollectionSection =
        dataCollectionComponent['{{componentId}}-{{sectionId}}'];
}
if (!dataCollectionSection['{{componentId}}-{{sectionId}}-form']) {
    dataCollectionSectionForm =
        dataCollectionSection['{{componentId}}-{{sectionId}}-form'] = { };
} else {
    dataCollectionSectionForm =
        dataCollectionSection['{{componentId}}-{{sectionId}}-form'];
}

dataCollectionSectionForm['vars'] = { };
dataCollectionSectionForm['vars']['modules'] = JSON.parse('{{modulesJson}}');
dataCollectionSectionForm['vars']['moduleDependenciese'] = JSON.parse('{{moduleDependencies}}');

dataCollectionSection =
    $.extend(dataCollectionSection, {
        '{{componentId}}-{{sectionId}}-id'                                  : { },
        '{{componentId}}-{{sectionId}}-type'                                : { },
        '{{componentId}}-{{sectionId}}-name'                                : { },
        '{{componentId}}-{{sectionId}}-display_name'                        : { },
        '{{componentId}}-{{sectionId}}-route'                               : { },
        '{{componentId}}-{{sectionId}}-description'                         : { },
        '{{componentId}}-{{sectionId}}-module_type'                         : {
            'placeholder'   : 'SELECT MODULE TYPE'
        },
        '{{componentId}}-{{sectionId}}-app_type'                            : { },
        '{{componentId}}-{{sectionId}}-category'                            : { },
        '{{componentId}}-{{sectionId}}-sub_category'                        : { },
        '{{componentId}}-{{sectionId}}-version'                             : { },
        '{{componentId}}-{{sectionId}}-repo'                                : { },
        '{{componentId}}-{{sectionId}}-class'                               : { },
        '{{componentId}}-{{sectionId}}-settings'                            : { },
        '{{componentId}}-{{sectionId}}-menu'                                : { },
        '{{componentId}}-{{sectionId}}-menu_id'                             : { },
        '{{componentId}}-{{sectionId}}-apps'                                : { },
        '{{componentId}}-{{sectionId}}-dependencies-modules'                : {
            'placeholder'   : 'SELECT MODULE',
            'afterInit'     : function() {
                var id, label, moduleData;
                $('#{{componentId}}-{{sectionId}}-dependencies-modules').on('select2:select', function(e) {
                    id = e.params.data.id;
                    label = $(e.params.data.element).parents('optgroup').attr('label').toLowerCase();

                    moduleData = dataCollectionSectionForm['vars']['modules'][label][id];
                    $('#{{componentId}}-{{sectionId}}-dependencies-modulename').val(moduleData['name']);
                    $('#{{componentId}}-{{sectionId}}-dependencies-moduleversion').val(moduleData['version']);
                    $('#{{componentId}}-{{sectionId}}-dependencies-modulerepo').val(moduleData['repo']);

                    $('#{{componentId}}-{{sectionId}}-dependencies-add, ' +
                      '#{{componentId}}-{{sectionId}}-dependencies-remove').attr('disabled', false);
                });

                function reset() {
                    $('#{{componentId}}-{{sectionId}}-dependencies-add, ' +
                      '#{{componentId}}-{{sectionId}}-dependencies-remove').attr('disabled', true);

                    $('#{{componentId}}-{{sectionId}}-dependencies-modulename').val('');
                    $('#{{componentId}}-{{sectionId}}-dependencies-moduleversion').val('');
                    $('#{{componentId}}-{{sectionId}}-dependencies-modulerepo').val('');
                    $('#{{componentId}}-{{sectionId}}-dependencies-modules').val(0).trigger('change');
                }

                function prettyfyDependencies() {
                    $('#{{componentId}}-{{sectionId}}-dependencies')
                        .val(JSON.stringify(dataCollectionSectionForm['vars']['moduleDependenciese'], null, 4));
                }

                $('#{{componentId}}-{{sectionId}}-dependencies-add').click(function(e) {
                    e.preventDefault();

                    var found = false;

                    if (label === 'core') {
                        dataCollectionSectionForm['vars']['moduleDependenciese'][label]['name'] = moduleData['name'];
                        dataCollectionSectionForm['vars']['moduleDependenciese'][label]['version'] = moduleData['version'];
                        dataCollectionSectionForm['vars']['moduleDependenciese'][label]['repo'] = moduleData['repo'];
                    } else {
                        for (var modules in dataCollectionSectionForm['vars']['moduleDependenciese']) {
                            if (label === modules) {
                                $.each(dataCollectionSectionForm['vars']['moduleDependenciese'][modules], function(index, mod) {
                                    if (mod['name'] === moduleData['name']) {
                                        found = true;
                                    }
                                });

                                if (!found) {
                                    dataCollectionSectionForm['vars']['moduleDependenciese'][modules].push(moduleData);
                                }
                            }
                        }
                    }

                    reset();
                    prettyfyDependencies();
                });

                $('#{{componentId}}-{{sectionId}}-dependencies-remove').click(function(e) {
                    e.preventDefault();

                    var found = false;
                    var foundIndex;

                    if (label === 'core') {
                        dataCollectionSectionForm['vars']['moduleDependenciese'][label]['name'] = moduleData['name'];
                        dataCollectionSectionForm['vars']['moduleDependenciese'][label]['version'] = moduleData['version'];
                        dataCollectionSectionForm['vars']['moduleDependenciese'][label]['repo'] = moduleData['repo'];
                    } else {
                        for (var modules in dataCollectionSectionForm['vars']['moduleDependenciese']) {
                            if (label === modules) {
                                $.each(dataCollectionSectionForm['vars']['moduleDependenciese'][modules], function(index, mod) {
                                    if (mod['name'] === moduleData['name']) {
                                        found = true;
                                        foundIndex = index;
                                    }
                                });

                                if (found) {
                                    dataCollectionSectionForm['vars']['moduleDependenciese'][modules].splice(foundIndex);
                                }
                            }
                        }
                    }

                    reset();
                    prettyfyDependencies();
                });

                prettyfyDependencies();
            }
        },
        '{{componentId}}-{{sectionId}}-dependencies-modulename'             : { },
        '{{componentId}}-{{sectionId}}-dependencies-moduleversion'          : { },
        '{{componentId}}-{{sectionId}}-dependencies-modulerepo'             : { },
        '{{componentId}}-{{sectionId}}-dependencies'                        : { },
        '{{componentId}}-{{sectionId}}-dependencies-pretty'                 : { },
        '{{componentId}}-{{sectionId}}-form'                                : {
            rules: {
                '{{componentId}}-{{sectionId}}-name'                        : 'required',
                '{{componentId}}-{{sectionId}}-route'                       : 'required',
                '{{componentId}}-{{sectionId}}-app_type'                    : 'required',
                '{{componentId}}-{{sectionId}}-category'                    : 'required',
                '{{componentId}}-{{sectionId}}-sub_category'                : 'required',
                '{{componentId}}-{{sectionId}}-version'                     : 'required',
                '{{componentId}}-{{sectionId}}-repo'                        : 'required',
                '{{componentId}}-{{sectionId}}-class'                       : 'required',
                '{{componentId}}-{{sectionId}}-settings'                    : 'required',
                '{{componentId}}-{{sectionId}}-menu_id'                     : 'required',
                '{{componentId}}-{{sectionId}}-menu'                        : 'required'
            },
            messages: {
                '{{componentId}}-{{sectionId}}-name'                        : 'Please enter name',
                '{{componentId}}-{{sectionId}}-route'                       : 'Please enter route',
                '{{componentId}}-{{sectionId}}-app_type'                    : 'Please enter app_type',
                '{{componentId}}-{{sectionId}}-category'                    : 'Please enter category',
                '{{componentId}}-{{sectionId}}-sub_category'                : 'Please enter sub_category',
                '{{componentId}}-{{sectionId}}-version'                     : 'Please enter version',
                '{{componentId}}-{{sectionId}}-repo'                        : 'Please enter repo',
                '{{componentId}}-{{sectionId}}-class'                       : 'Please enter class',
                '{{componentId}}-{{sectionId}}-settings'                    : 'Please enter settings',
                '{{componentId}}-{{sectionId}}-menu_id'                     : 'Please enter menu_id',
                '{{componentId}}-{{sectionId}}-menu'                        : 'Please enter menu'
            }
        }
    });
</script>