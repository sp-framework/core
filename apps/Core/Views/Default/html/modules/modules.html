{# <div class="row">
    <div id="repo" class="col">
        {% include 'modules/repositories/list.html' %}
    </div>
</div> #}
<div class="row vdivide">
    <div class="col-md-4 vdivide-resizable">
        {{adminltetags.useTag('fields',
            [
                'component'                                 : component,
                'componentName'                             : componentName,
                'componentId'                               : componentId,
                'sectionId'                                 : sectionId,
                'fieldId'                                   : 'modules',
                'fieldLabel'                                : 'Modules',
                'fieldType'                                 : 'jstree',
                'fieldHelp'                                 : true,
                'fieldHelpTooltipContent'                   : 'Available modules on repository.',
                'fieldRequired'                             : false,
                'fieldBazScan'                              : true,
                'fieldJstreeSearch'                         : true,
                'fieldBazPostOnCreate'                      : false,
                'fieldBazPostOnUpdate'                      : false,
                'fieldJstreeDataSrcArr'                     : ["modules":["srcArr" : modules]],
                'fieldJstreeAdd'                            : false,
                'fieldJstreeEdit'                           : false,
                'fieldJstreeExpand'                         : true,
                'fieldJstreeCollapse'                       : true,
                'fieldJstreeFirstOpen'                      : true,
                'fieldJstreeAllOpen'                        : true,
                'fieldJstreeAllChecked'                     : false,
                'fieldJstreeRootIcon'                       : 'th',
                'fieldJstreeToggleAllChildren'              : true,
                'fieldJstreeIncludeRootInPath'              : false,
                'fieldJstreeSelectEndNodeOnly'              : false,
                'fieldJstreeShowDots'                       : true,
                'fieldJstreeDoubleClickToggle'              : true,
                'fieldJstreeMultiple'                       : false,
                'fieldJstreeSearchCaseSensitive'            : false,
                'fieldJstreeSearchShowOnlyMatches'          : true,
                'fieldJstreeSearchShowOnlyMatchesChildren'  : true,
                'fieldJstreeHideJstreeIcons'                : false,
                'fieldJstreeAdditionalTools'                :
                    [
                        'repo-sync' :
                            [
                                'id'        : 'repo-sync',
                                'tooltip'   : 'Sync',
                                'icon'      : 'fas fa-fw fa-sync-alt text-secondary',
                                'iconColor' : 'secondary',
                                'disabled'  : true
                            ],
                        'filter-update-available' :
                            [
                                'id'        : 'filter-update-available',
                                'tooltip'   : 'Apply Filter (update)',
                                'icon'      : 'fas fa-fw fa-circle-up',
                                'iconColor' : 'secondary',
                                'disabled'  : true
                            ],
                        '0'       :
                            [
                                'id'        : 'divider'
                            ],
                        'filter-update' :
                            [
                                'id'        : 'filter-update',
                                'tooltip'   : 'Apply Filter (:update)',
                                'icon'      : 'fas fa-fw fa-circle-up',
                                'iconColor' : 'secondary',
                                'disabled'  : true
                            ],
                        'filter-install' :
                            [
                                'id'        : 'filter-install',
                                'tooltip'   : 'Apply Filter Install/Update (:install)',
                                'icon'      : 'fas fa-fw fa-circle-plus',
                                'iconColor' : 'secondary',
                                'disabled'  : true
                            ],
                        'filter-uninstall' :
                            [
                                'id'        : 'filter-uninstall',
                                'tooltip'   : 'Apply Filter Uninstall (:uninstall)',
                                'icon'      : 'fas fa-fw fa-circle-minus',
                                'iconColor' : 'secondary',
                                'disabled'  : true
                            ],
                        'filter-remove' :
                            [
                                'id'        : 'filter-remove',
                                'tooltip'   : 'Apply Filter Remove (:remove)',
                                'icon'      : 'fas fa-fw fa-circle-xmark',
                                'iconColor' : 'secondary',
                                'disabled'  : true
                            ],
                        '1'       :
                            [
                                'id'        : 'divider'
                            ],
                        'filter-queue' :
                            [
                                'id'        : 'filter-queue',
                                'tooltip'   : 'Apply Filter In Queue (queue:)',
                                'icon'      : 'fas fa-fw fa-list',
                                'iconColor' : 'secondary',
                                'disabled'  : true
                            ],
                        'filter-clear' :
                            [
                                'id'        : 'filter-clear',
                                'tooltip'   : 'Clear all filters',
                                'icon'      : 'fas fa-fw fa-times',
                                'iconColor' : 'primary'
                            ]
                    ],
                'fieldJstreeReplaceIdWithDataField'         : 'moduleid',
                'fieldJstreePlugins'                        : ["search", "types"],
                'fieldJstreeAdditionalClass'                : 'text-uppercase'
            ]
        )}}
    </div>
    <div class="col">
        <div class="row text-center m-2" id="{{componentId}}-{{sectionId}}-moduleinfo-error" hidden>
            <div class="col">
                <h6><i class="fa fa-fw fa-info-circle text-danger"></i> Error loading module information. Please contact administrator.</h6>
            </div>
        </div>
        <div class="row text-center m-2" id="{{componentId}}-{{sectionId}}-moduleinfo-noinfo">
            <div class="col">
                <h6><i class="fa fa-fw fa-info-circle text-info"></i> Select module from the tree to see it's details.</h6>
            </div>
        </div>
        <div class="row text-center" id="{{componentId}}-{{sectionId}}-moduleinfo-loader" hidden>
            <div class="col">
                <i class="fa fa-cog fa-spin"></i> Loading module information...
            </div>
        </div>
        <div class="row" id="{{componentId}}-{{sectionId}}-moduleinfo-info" hidden>
            <div class="col">
                {{adminltetags.useTag('tabs',
                    [
                        'component'                     : component,
                        'componentName'                 : componentName,
                        'componentId'                   : componentId,
                        'sectionId'                     : sectionId,
                        'tabsId'                        : 'tabs',
                        'tabsStyle'                     : 'card-outline-tabs',
                        'tabsData'                      :
                            [
                                'info'   :
                                [
                                    'tabTitle'          : 'Info',
                                    'tabInclude'        : 'modules/modules/info'
                                ],
                                'description'   :
                                [
                                    'tabTitle'          : 'Description',
                                    'tabInclude'        : 'modules/modules/description'
                                ],
                                'changelogs'   :
                                [
                                    'tabTitle'          : 'Change logs',
                                    'tabInclude'        : 'modules/modules/changelogs'
                                ],
                                'settings'   :
                                [
                                    'tabTitle'          : 'Settings',
                                    'tabInclude'        : 'modules/modules/settings'
                                ]
                            ]
                    ]
                )}}
            </div>
        </div>
    </div>
</div>
<hr>
<div class="row">
    <div class="col-md-6">
        <div id="installer-progress" class="mb-3"></div>
    </div>
    <div class="col">
        <span class="text-uppercase float-right">Queue:
            <span style="top: -2px;position: relative;" class="badge badge-info" id="queue-counter">0</span>
        </span>
    </div>
    <div class="col">
        {{adminltetags.useTag('buttons',
            [
                'component'                     : component,
                'componentName'                 : componentName,
                'componentId'                   : componentId,
                'sectionId'                     : sectionId,
                'buttonType'                    : 'button',
                'buttons'                       :
                    [
                        'analyse-queue'     : [
                            'title'             : 'Analyse Queue',
                            'position'          : 'right',
                            'size'              : 'xs',
                            'icon'              : 'fa-cog fa-spin',
                            'iconHidden'        : true,
                            'disabled'          : true
                        ],
                        'clear-queue'       : [
                            'title'             : 'Clear Queue',
                            'position'          : 'right',
                            'type'              : 'danger',
                            'size'              : 'xs',
                            'disabled'          : true
                        ]
                    ]
            ]
        )}}
    </div>
</div>
{% set modules = json_encode(modules, 16) %}
<script>
/*global PNotify BazProgress Swal BazContentFields */
var dataCollectionComponent, dataCollectionSection, dataCollectionSectionForm;

if (!window['dataCollection']['{{componentId}}']) {
    dataCollectionComponent =
        window['dataCollection']['{{componentId}}'] = { };
} else {
    dataCollectionComponent =
        window['dataCollection']['{{componentId}}'];
}
if (!dataCollectionComponent['{{componentId}}-{{sectionId}}']) {
    dataCollectionSection =
        dataCollectionComponent['{{componentId}}-{{sectionId}}'] = { };
} else {
    dataCollectionSection =
        dataCollectionComponent['{{componentId}}-{{sectionId}}'];
}
if (!dataCollectionSection['{{componentId}}-{{sectionId}}-form']) {
    dataCollectionSectionForm =
        dataCollectionSection['{{componentId}}-{{sectionId}}-form'] = { };
} else {
    dataCollectionSectionForm =
        dataCollectionSection['{{componentId}}-{{sectionId}}-form'];
}

dataCollectionSection =
    $.extend(dataCollectionSection, {
        '{{componentId}}-{{sectionId}}-level_of_update'             : {
            placeholder: 'SELECT LEVEL OF UPDATE'
        },
        '{{componentId}}-{{sectionId}}-auto_update'                 : {
            afterInit: function() {
                $('#{{componentId}}-{{sectionId}}-save-settings').off();
                $('#{{componentId}}-{{sectionId}}-save-settings').click(function() {
                    $('#{{componentId}}-{{sectionId}}-save-settings').attr('disabled', true);
                    $('#{{componentId}}-{{sectionId}}-save-settings').children("i").removeClass("fa-save").addClass("fa-cog fa-spin");

                    var postData = { };
                    postData[$('#security-token').attr('name')] = $('#security-token').val();
                    postData['module_id'] = dataCollectionSectionForm['vars']['module']['id'];
                    postData['module_type'] = dataCollectionSectionForm['vars']['module']['module_type'];
                    postData['level_of_update'] = $('#{{componentId}}-{{sectionId}}-level_of_update').val();
                    postData['auto_update'] = '0';
                    if ($('#{{componentId}}-{{sectionId}}-auto_update')[0].checked === true) {
                        postData['auto_update'] = '1';
                    }

                    $.post('{{links.url("modules/saveModuleSettings")}}', postData, function(response) {
                        if (response.tokenKey && response.token) {
                            $('#security-token').attr('name', response.tokenKey);
                            $('#security-token').val(response.token);
                        }

                        if (response.responseCode == 0) {
                            PNotify.success({text: response.responseMessage});
                        } else if (response.responseCode == 1) {
                            PNotify.error({text: response.responseMessage});
                        }

                        $('#{{componentId}}-{{sectionId}}-save-settings').attr('disabled', false);
                        $('#{{componentId}}-{{sectionId}}-save-settings').children("i").removeClass("fa-cog fa-spin").addClass("fa-save");
                    }, 'json');
                });
            }
        },
        '{{componentId}}-{{sectionId}}-form'                        : {
            rules: { },
            messages: { }
        }
    });

dataCollectionSectionForm['vars'] = { };
dataCollectionSectionForm['vars']['rootTree'] = [];
dataCollectionSectionForm['vars']['org_update_available'] = 0;
dataCollectionSectionForm['vars']['update_available'] = 0;
dataCollectionSectionForm['vars']['modules'] = JSON.parse('{{modules}}');
dataCollectionSectionForm['vars']['module'] = { };
dataCollectionSectionForm['vars']['queue'] = { };
dataCollectionSectionForm['vars']['queue']['count'] = 0;
dataCollectionSectionForm['vars']['queue']['install'] = { };
dataCollectionSectionForm['vars']['queue']['uninstall'] = { };
dataCollectionSectionForm['vars']['queue']['update'] = { };
dataCollectionSectionForm['vars']['queue']['remove'] = { };
dataCollectionSectionForm['vars']['initJstree'] = false;

dataCollectionSectionForm['funcs'] = { };

dataCollectionSectionForm['funcs']['jstreeReady'] = function() {
    $('#{{componentId}}-{{sectionId}}-modules').off('ready.jstree');
    $('#{{componentId}}-{{sectionId}}-modules').on('ready.jstree', function() {
        dataCollectionSectionForm['vars']['rootTree'] = $('#{{componentId}}-{{sectionId}}-modules').jstree().get_json('#', {flat:true});

        var selected;

        $(dataCollectionSectionForm['vars']['rootTree']).each(function(i, v) {
            v.text = v.text.toLowerCase();
            if (v.data.apiid == '1' && v.data.type === 'repo' && v.text.includes('core')) {
                selected = v.id;

                $('#{{componentId}}-{{sectionId}}-modules').jstree().select_node(v.id);

                return false;
            }
        });

        dataCollectionSectionForm['funcs']['applyColorsToTreeIconsAndUpdateText'](null, false, false, false, true);
    });

    $('#{{componentId}}-{{sectionId}}-modules').on('search.jstree', function(e, res) {
        if (res.nodes.length === 0) {
            $('#{{componentId}}-{{sectionId}}-modules-tree-search-input').val('');
            $('#{{componentId}}-{{sectionId}}-modules').jstree().clear_search();
        }

        if (dataCollectionSectionForm['vars']['initJstree'] === true) {
            dataCollectionSectionForm['vars']['org_update_available'] = res.nodes.length;
            dataCollectionSectionForm['vars']['update_available'] = res.nodes.length;
            dataCollectionSectionForm['vars']['initJstree'] = false;
            PNotify.info({
                text        : res.nodes.length + ' new updates available.',
                textTrusted : true
            });
        }

        if (dataCollectionSectionForm['vars']['update_available'] > 0) {
            dataCollectionSectionForm['funcs']['toggleJstreeTool']('{{componentId}}-{{sectionId}}-modules-filter-update-available', 'warning', false);
        }
    });
    $('#{{componentId}}-{{sectionId}}-modules-tree-search-input').on('keyup', function() {
        if ($('#{{componentId}}-{{sectionId}}-modules-tree-search-input').val() === '') {
            dataCollectionSectionForm['vars']['filter'] = false;
        } else {
            dataCollectionSectionForm['vars']['filter'] = true;
        }
    });

    $('#{{componentId}}-{{sectionId}}-modules-repo-sync, ' +
      '#{{componentId}}-{{sectionId}}-modules-filter-update, ' +
      '#{{componentId}}-{{sectionId}}-modules-filter-install, ' +
      '#{{componentId}}-{{sectionId}}-modules-filter-uninstall, ' +
      '#{{componentId}}-{{sectionId}}-modules-filter-uninstall, ' +
      '#{{componentId}}-{{sectionId}}-modules-filter-queue, ' +
      '#{{componentId}}-{{sectionId}}-modules-filter-clear').off();

    $('#{{componentId}}-{{sectionId}}-modules-repo-sync').click(function(e) {
        e.preventDefault();

        dataCollectionSectionForm['funcs']['toggleJstreeTool']($(this)[0].id);

        dataCollectionSectionForm['funcs']['initSync'](
            $('#{{componentId}}-{{sectionId}}-modules').jstree().get_selected(true)[0].data.apiid
        );
    });

    $('#{{componentId}}-{{sectionId}}-modules-filter-update-available').click(function(e) {
        e.preventDefault();

        dataCollectionSectionForm['vars']['filter'] = true;
        $('#{{componentId}}-{{sectionId}}-modules').jstree().clear_search();
        $('#{{componentId}}-{{sectionId}}-modules-tree-search-input').val('update');
        $('#{{componentId}}-{{sectionId}}-modules').jstree().search('update');
        $('#{{componentId}}-{{sectionId}}-modules').jstree().deselect_all();
        dataCollectionSectionForm['funcs']['moduleinfo'](['noinfo'], []);
    });

    $('#{{componentId}}-{{sectionId}}-modules-filter-update').click(function(e) {
        e.preventDefault();

        dataCollectionSectionForm['vars']['filter'] = true;
        $('#{{componentId}}-{{sectionId}}-modules').jstree().clear_search();
        $('#{{componentId}}-{{sectionId}}-modules-tree-search-input').val(':update');
        $('#{{componentId}}-{{sectionId}}-modules').jstree().search(':update');
        $('#{{componentId}}-{{sectionId}}-modules').jstree().deselect_all();
        dataCollectionSectionForm['funcs']['moduleinfo'](['noinfo'], []);
    });

    $('#{{componentId}}-{{sectionId}}-modules-filter-install').click(function(e) {
        e.preventDefault();

        //We only need this during update so when we click on update the node is hidden from the filter tree.
        dataCollectionSectionForm['vars']['filter'] = false;
        $('#{{componentId}}-{{sectionId}}-modules').jstree().clear_search();
        $('#{{componentId}}-{{sectionId}}-modules-tree-search-input').val(':Install');
        $('#{{componentId}}-{{sectionId}}-modules').jstree().search(':Install');
        $('#{{componentId}}-{{sectionId}}-modules').jstree().deselect_all();
        dataCollectionSectionForm['funcs']['moduleinfo'](['noinfo'], []);
    });

    $('#{{componentId}}-{{sectionId}}-modules-filter-uninstall').click(function(e) {
        e.preventDefault();

        //We only need this during update so when we click on update the node is hidden from the filter tree.
        dataCollectionSectionForm['vars']['filter'] = false;
        $('#{{componentId}}-{{sectionId}}-modules').jstree().clear_search();
        $('#{{componentId}}-{{sectionId}}-modules-tree-search-input').val(':Uninstall');
        $('#{{componentId}}-{{sectionId}}-modules').jstree().search(':Uninstall');
        $('#{{componentId}}-{{sectionId}}-modules').jstree().deselect_all();
        dataCollectionSectionForm['funcs']['moduleinfo'](['noinfo'], []);
    });

    $('#{{componentId}}-{{sectionId}}-modules-filter-remove').click(function(e) {
        e.preventDefault();

        //We only need this during update so when we click on update the node is hidden from the filter tree.
        dataCollectionSectionForm['vars']['filter'] = false;
        $('#{{componentId}}-{{sectionId}}-modules').jstree().clear_search();
        $('#{{componentId}}-{{sectionId}}-modules-tree-search-input').val(':Remove');
        $('#{{componentId}}-{{sectionId}}-modules').jstree().search(':Remove');
        $('#{{componentId}}-{{sectionId}}-modules').jstree().deselect_all();
        dataCollectionSectionForm['funcs']['moduleinfo'](['noinfo'], []);
    });

    $('#{{componentId}}-{{sectionId}}-modules-filter-queue').click(function(e) {
        e.preventDefault();

        //We only need this during update so when we click on update the node is hidden from the filter tree.
        dataCollectionSectionForm['vars']['filter'] = false;
        $('#{{componentId}}-{{sectionId}}-modules').jstree().clear_search();
        $('#{{componentId}}-{{sectionId}}-modules-tree-search-input').val('in queue:');
        $('#{{componentId}}-{{sectionId}}-modules').jstree().search('in queue:');
        $('#{{componentId}}-{{sectionId}}-modules').jstree().deselect_all();
        dataCollectionSectionForm['funcs']['moduleinfo'](['noinfo'], []);
    });

    $('#{{componentId}}-{{sectionId}}-modules-filter-clear').click(function(e) {
        e.preventDefault();

        //We only need this during update so when we click on update the node is hidden from the filter tree.
        dataCollectionSectionForm['vars']['filter'] = false;
        $('#{{componentId}}-{{sectionId}}-modules').jstree().clear_search();
        $('#{{componentId}}-{{sectionId}}-modules-tree-search-input').val('');
        $('#{{componentId}}-{{sectionId}}-modules').jstree().deselect_all();
        $('#{{componentId}}-{{sectionId}}-modules').jstree().open_all();
        dataCollectionSectionForm['funcs']['moduleinfo'](['noinfo'], []);
    });
}
dataCollectionSectionForm['funcs']['jstreeReady']();//We start here

dataCollectionSectionForm['funcs']['applyColorsToTreeIconsAndUpdateText'] =
    function(nodeId = null, install = false, uninstall = false, remove = false, init = false) {
        var allNodes;

        if (nodeId) {
            allNodes = $('#{{componentId}}-{{sectionId}}-modules').jstree().get_node(nodeId);
        } else {
            allNodes = dataCollectionSectionForm['vars']['rootTree']
        }

        var updateAvailable = false;
        var nT, nD, index;

        $(allNodes).each(function(i, node) {
            if (node.id.startsWith('j')) {
                if (node.data.type === 'repo') {
                    $('#{{componentId}}-{{sectionId}}-modules').jstree().set_icon(node, 'fas fa-fw fa-cloud-arrow-down text-primary');
                }
                return true;
            }

            nD = node.data;

            nT =
                dataCollectionSectionForm['vars']['modules'][nD.apiid]['childs'][nD.apptype]['childs'][nD.moduletype]['childs'][nD.modulecategory]['childs'][nD.modulesubcategory]['childs'][node.id]['name'];

            if (install === true) {
                if (nD.update_available && nD.update_available == 1) {
                    $('#{{componentId}}-{{sectionId}}-modules').jstree().set_icon(node, 'fas fa-fw fa-circle-plus text-info');
                    $('#{{componentId}}-{{sectionId}}-modules').jstree().set_text(node, nT + ' (In Queue:Update)');
                    updateAvailable = true;
                } else {
                    $('#{{componentId}}-{{sectionId}}-modules').jstree().set_icon(node, 'fas fa-fw fa-square-plus text-info');
                    $('#{{componentId}}-{{sectionId}}-modules').jstree().set_text(node, nT + ' (In Queue:Install)');
                }
            } else if (uninstall === true) {
                $('#{{componentId}}-{{sectionId}}-modules').jstree().set_icon(node, 'fas fa-fw fa-circle-minus text-danger');
                $('#{{componentId}}-{{sectionId}}-modules').jstree().set_text(node, nT + ' (In Queue:Uninstall)');
                if (nD.update_available && nD.update_available == 1) {
                    updateAvailable = true;
                }
            } else if (remove === true) {
                $('#{{componentId}}-{{sectionId}}-modules').jstree().set_icon(node, 'fas fa-fw fa-circle-xmark text-danger');
                $('#{{componentId}}-{{sectionId}}-modules').jstree().set_text(node, nT + ' (In Queue:Remove)');
            } else {
                if (nD.installed == 1) {
                    $('#{{componentId}}-{{sectionId}}-modules').jstree().set_icon(node, 'fas fa-fw fa-circle-check text-success');
                    $('#{{componentId}}-{{sectionId}}-modules').jstree().set_text(node, nT);
                } else {
                    $('#{{componentId}}-{{sectionId}}-modules').jstree().set_icon(node, 'fa fa-fw fa-circle-dot');
                    if (nD.isnew && nD.isnew == 1) {
                        $('#{{componentId}}-{{sectionId}}-modules')
                        .jstree()
                        .set_text(
                            node,
                            nT +
                                ' <span class="text-uppercase" style="top: -1px;position: relative;"><span class="badge badge-info">NEW</span></span>'
                        );
                    } else {
                        $('#{{componentId}}-{{sectionId}}-modules').jstree().set_text(node, nT);
                    }
                }

                if (nD.update_available && nD.update_available == 1) {
                    updateAvailable = true;
                    $('#{{componentId}}-{{sectionId}}-modules').jstree().set_icon(node, 'fas fa-fw fa-circle-up text-warning');
                    $('#{{componentId}}-{{sectionId}}-modules').jstree().set_text(node, nT + ' (Update Available)');

                    if (dataCollectionSectionForm['vars']['queue']['update'][nD.moduletype] &&
                        dataCollectionSectionForm['vars']['queue']['update'][nD.moduletype].includes(nD.id.toString())
                    ) {
                        index = dataCollectionSectionForm['vars']['queue']['update'][nD.moduletype].indexOf(nD.id.toString());

                        if (index > -1) {
                            $('#{{componentId}}-{{sectionId}}-modules').jstree().set_icon(node, 'fas fa-fw fa-circle-up text-info');
                            $('#{{componentId}}-{{sectionId}}-modules').jstree().set_text(node, nT + ' (In Queue:Update)');
                        }
                    }
                }
            }
        });

        if (updateAvailable && (dataCollectionSectionForm['vars']['filter'] === true || init === true)) {
            if (init === true) {
                dataCollectionSectionForm['vars']['initJstree'] = true;
            } else {
                dataCollectionSectionForm['vars']['initJstree'] = false;
            }

            dataCollectionSectionForm['vars']['filter'] = true;
            $('#{{componentId}}-{{sectionId}}-modules-tree-search-input').val('update');
            $('#{{componentId}}-{{sectionId}}-modules').jstree().search('update');
        }
}

dataCollectionSectionForm['funcs']['jstreeSelectNode'] = function() {
    $('#{{componentId}}-{{sectionId}}-modules').off('select_node.jstree');
    $('#{{componentId}}-{{sectionId}}-modules').on('select_node.jstree', function() {
        var selected = $('#{{componentId}}-{{sectionId}}-modules').jstree().get_selected(true);

        if (selected[0].id.startsWith('j')) {
            if (selected[0].data.type !== 'repo') {
                $('#{{componentId}}-{{sectionId}}-modules').jstree().deselect_node(selected);

                dataCollectionSectionForm['funcs']['toggleJstreeTool']('{{componentId}}-{{sectionId}}-modules-repo-sync');
                dataCollectionSectionForm['funcs']['moduleinfo'](['noinfo']);
                return false;
            } else if (selected[0].data.type === 'repo') {
                dataCollectionSectionForm['funcs']['toggleJstreeTool']('{{componentId}}-{{sectionId}}-modules-repo-sync', 'primary', false);
            }

            dataCollectionSectionForm['funcs']['moduleinfo']();
        } else {
            dataCollectionSectionForm['funcs']['toggleJstreeTool']('{{componentId}}-{{sectionId}}-modules-repo-sync');
            dataCollectionSectionForm['funcs']['moduleinfo'](['loader']);
            dataCollectionSectionForm['funcs']['getSelectedModuleInfo'](selected[0].id);
        }
    });
}
dataCollectionSectionForm['funcs']['jstreeSelectNode']();//Enable selection of modules

dataCollectionSectionForm['funcs']['toggleJstreeTool'] = function(toolId, textColor = 'secondary', isDisabled = true) {
    if (isDisabled) {
        $('#' + toolId).addClass('disabled');
        $('#' + toolId).children('i').removeClass(function (index, className) {
            return (className.match (/(^|\s)text-\S+/g) || []).join(' ');
        }).addClass('text-secondary');
    } else {
        $('#' + toolId).removeClass('disabled');
        $('#' + toolId).children('i').removeClass(function (index, className) {
            return (className.match (/(^|\s)text-\S+/g) || []).join(' ');
        }).addClass('text-' + textColor);
    }
}
dataCollectionSectionForm['funcs']['moduleinfo'] = function(show = ['noinfo'], showButtons = ['cancel']) {
    if (show.length > 0) {
        var moduleinfos = ['loader', 'info', 'noinfo', 'error', 'buttons'];
        $(moduleinfos).each(function(e, moduleinfo) {
            if (show.includes(moduleinfo)) {
                $('#{{componentId}}-{{sectionId}}-moduleinfo-' + moduleinfo).attr('hidden', false);
            } else {
                $('#{{componentId}}-{{sectionId}}-moduleinfo-' + moduleinfo).attr('hidden', true);
            }
        });
    }

    if (showButtons.length > 0) {
        var modulebuttons = ['install', 'update', 'uninstall', 'remove', 'cancel', 'repo-sync'];
        $(modulebuttons).each(function(e, modulebutton) {
            if (showButtons.includes(modulebutton)) {
                $('#{{componentId}}-{{sectionId}}-moduleinfo-' + modulebutton).attr('hidden', false);
            } else {
                $('#{{componentId}}-{{sectionId}}-moduleinfo-' + modulebutton).attr('hidden', true);
            }
        });
    }
}

dataCollectionSectionForm['funcs']['getRepositoryModules'] = function(repositoryId) {
    var postData = { };
    postData[$('#security-token').attr('name')] = $('#security-token').val();
    postData['api_id'] = repositoryId;

    $.post('{{links.url("modules/getRepositoryModules")}}', postData, function(response) {
        if (response.tokenKey && response.token) {
            $('#security-token').attr('name', response.tokenKey);
            $('#security-token').val(response.token);
        }

        $('#{{componentId}}-{{sectionId}}-moduleinfo-loader').attr('hidden', true);
        $('#{{componentId}}-{{sectionId}}-moduleinfo-repo-sync').attr('disabled', false);
        $('#{{componentId}}-{{sectionId}}-moduleinfo-repo-sync').children("i").removeClass("fa-cog fa-spin").addClass("fa-sync-alt");

        if (response.responseCode == 0) {
            if (response.responseData.modules) {
                dataCollectionSectionForm['vars']['modules'] = response.responseData.modules;
            }
            if (response.responseData.modules_html && response.responseData.modules_html !== '') {
                var modulesHtml =
                    '<div id="{{componentId}}-{{sectionId}}-modules" data-bazscantype="jstree">' +
                        '<ul>' +
                            response.responseData.modules_html +
                        '</ul>' +
                    '</div>';

                $('#{{componentId}}-{{sectionId}}-modules-tree-div').empty().html(modulesHtml);
            }

            BazContentFields.init({
                'componentId'   : '{{componentId}}',
                'sectionId'     : '{{componentId}}-{{sectionId}}',
                'fieldId'       : '{{componentId}}-{{sectionId}}-modules'
            });

            dataCollectionSectionForm['funcs']['jstreeSelectNode']();
            dataCollectionSectionForm['funcs']['jstreeReady']();
        } else if (response.responseCode == 1) {
            $('#{{componentId}}-{{sectionId}}-moduleinfo-info').attr('hidden', true);
            $('#{{componentId}}-{{sectionId}}-moduleinfo-buttons').attr('hidden', true);
            $('#{{componentId}}-{{sectionId}}-moduleinfo-noinfo').attr('hidden', false);
        }
    }, 'json');
}

dataCollectionSectionForm['funcs']['getSelectedModuleInfo'] = function(selected) {
    if (!selected) {
        return false;
    }

    var splitModule, moduleType, moduleId;

    splitModule = selected.split('-');
    moduleId = splitModule[1];

    if (selected.startsWith('components')) {
        moduleType = 'components';
    } else if (selected.startsWith('packages')) {
        moduleType = 'packages';
    } else if (selected.startsWith('middlewares')) {
        moduleType = 'middlewares';
    } else if (selected.startsWith('views')) {
        moduleType = 'views';
    }

    if (moduleType && moduleId) {
        dataCollectionSectionForm['funcs']['getModuleInfo'](moduleType, moduleId);

        return true;
    }

    return false;
}

dataCollectionSectionForm['funcs']['getModuleInfo'] = function(moduleType, moduleId, sync = false) {
    var postData = { };
    postData[$('#security-token').attr('name')] = $('#security-token').val();
    postData['module_type'] = moduleType;
    postData['module_id'] = moduleId;
    if (sync) {
        postData['sync'] = true;
    }

    $.post('{{links.url("modules/getModuleInfo")}}', postData, function(response) {
        if (response.tokenKey && response.token) {
            $('#security-token').attr('name', response.tokenKey);
            $('#security-token').val(response.token);
        }
        //eslint-disable-next-line
        console.log(response);
        $('#{{componentId}}-{{sectionId}}-moduleinfo-loader').attr('hidden', true);
        $('#{{componentId}}-{{sectionId}}-moduleinfo-repo-sync').attr('disabled', false);
        $('#{{componentId}}-{{sectionId}}-moduleinfo-repo-sync').children("i").removeClass("fa-cog fa-spin").addClass("fa-sync-alt");

        if (response.responseCode == 0) {
            if (response.responseData.module) {

                dataCollectionSectionForm['vars']['module'] = response.responseData.module;

                dataCollectionSectionForm['funcs']['processModuleInfo'](response.responseData.module);
            }
        } else if (response.responseCode == 1) {
            $('#{{componentId}}-{{sectionId}}-moduleinfo-info').attr('hidden', true);
            $('#{{componentId}}-{{sectionId}}-moduleinfo-error').attr('hidden', false);
        } else if (response.responseCode == 2) {
            PNotify.error({text: response.responseMessage});
            if (response.responseData.module) {
                dataCollectionSectionForm['vars']['module'] = response.responseData.module;
                dataCollectionSectionForm['funcs']['processModuleInfo'](response.responseData.module);
            }
        }
    }, 'json');
}

dataCollectionSectionForm['funcs']['processModuleInfo'] = function(moduleInfo) {
    var moduleData = { };
    var index;

    for (var m in moduleInfo) {
        if (moduleInfo[m] === '' || moduleInfo[m] === null) {
            moduleData[m] = '-';
        } else {
            moduleData[m] = moduleInfo[m];
        }
    }

    if (moduleData['installed'] == 1) {
        moduleData['installed'] = '<span class="badge badge-success">Yes</span>';
    } else {
        moduleData['installed'] = '<span class="badge badge-secondary">No</span>';
    }

    if (moduleData['update_available'] !== '-' && moduleData['update_available'] == 1) {
        moduleData['update_available'] = '<span class="badge badge-warning">Yes</span>';
    }
    if (moduleData['update_version'] !== '-') {
        moduleData['update_version'] = '<span class="badge badge-warning">' + moduleData['update_version'] + '</span>';
    }

    moduleData['version'] = '<span class="badge badge-info">' + moduleData['version'] + '</span>';

    $('#app_type').html(moduleData.app_type);
    $('#category').html(moduleData.category);
    $('#sub_category').html(moduleData.sub_category);
    $('#update_available').html(moduleData.update_available);
    $('#update_version').html(moduleData.update_version);
    $('#updated_on').html(moduleData.updated_on);
    $('#installed').html(moduleData.installed);
    $('#version').html(moduleData.version);
    $('#updated_by').html(moduleData.updated_by);
    $('#module_type').html(moduleData.module_type);
    if (moduleData.display_name) {
        $('#display_name').html(moduleData.display_name);
        $('#display_name').html(moduleData.display_name);
    } else {
        $('#display_name').html(moduleData.name);
    }
    $('#module_id').html(moduleData.id);
    $('#description').html(moduleData.description);

    //This is for Gitea, github will change
    if (moduleData.repo_details.latestRelease && moduleData.repo_details.latestRelease.body) {
        var changelogText;
        if (moduleData.repo_details.latestRelease.prerelease === false) {
            changelogText =
                'Version: ' + moduleInfo.version +
                ' <span class="text-uppercase" style="top: -1px;position: relative;"><span class="badge badge-success">STABLE</span></span>';
        } else {
            changelogText =
                'Version: ' + moduleInfo.version +
                ' <span class="text-uppercase" style="top: -1px;position: relative;"><span class="badge badge-danger">UNSTABLE</span></span>';
        }
        $('#changelogs-version').html(changelogText);
        $('#changelogs').html(moduleData.repo_details.latestRelease.body);
    }

    $('#{{componentId}}-{{sectionId}}-auto_update')[0].checked = false;
    if (moduleInfo.auto_update !== 'null') {
        if (moduleInfo.auto_update == '0') {
            $('#{{componentId}}-{{sectionId}}-auto_update')[0].checked = false;
        } else if (moduleInfo.auto_update == '1') {
            $('#{{componentId}}-{{sectionId}}-auto_update')[0].checked = true;
        }
    }

    if (moduleInfo.level_of_update !== 'null') {
        $('#{{componentId}}-{{sectionId}}-level_of_update').val(moduleInfo.level_of_update).trigger('change');
    }

    if (moduleInfo.installed == '1') {
        if (moduleInfo.update_available == '1') {
            if (dataCollectionSectionForm['vars']['queue']['update'][moduleInfo.module_type] &&
                dataCollectionSectionForm['vars']['queue']['update'][moduleInfo.module_type].includes(moduleInfo.id)
            ) {
                dataCollectionSectionForm['funcs']['moduleinfo'](['info'], ['cancel', 'repo-sync']);
            } else {
            //eslint-disable-next-line
            console.log(moduleInfo.installed);
                dataCollectionSectionForm['funcs']['moduleinfo'](['info'], ['update', 'remove', 'repo-sync']);
            }
        } else {
            if (dataCollectionSectionForm['vars']['queue']['install'][moduleInfo.module_type] &&
                dataCollectionSectionForm['vars']['queue']['install'][moduleInfo.module_type].includes(moduleInfo.id)
            ) {
                dataCollectionSectionForm['funcs']['moduleinfo'](['info'], ['cancel', 'repo-sync']);
            } else {
                dataCollectionSectionForm['funcs']['moduleinfo'](['info'], ['uninstall', 'remove', 'repo-sync']);
            }
        }

        // if ((dataCollectionSectionForm['vars']['queue']['uninstall'][moduleInfo.module_type] &&
        //     dataCollectionSectionForm['vars']['queue']['uninstall'][moduleInfo.module_type].includes(moduleInfo.id))
        // ) {
        //     $('#{{componentId}}-{{sectionId}}-moduleinfo-uninstall').attr('hidden', true);
        //     $('#{{componentId}}-{{sectionId}}-moduleinfo-uninstall').attr('disabled', true);
        //     $('#{{componentId}}-{{sectionId}}-moduleinfo-cancel').attr('hidden', false);
        //     $('#{{componentId}}-{{sectionId}}-moduleinfo-cancel').attr('disabled', false);
        // } else {
        //     $('#{{componentId}}-{{sectionId}}-moduleinfo-uninstall').attr('hidden', false);
        //     $('#{{componentId}}-{{sectionId}}-moduleinfo-uninstall').attr('disabled', false);
        // }
    } else {
        if (dataCollectionSectionForm['vars']['queue']['install'][moduleData.module_type]) {
            index = dataCollectionSectionForm['vars']['queue']['install'][moduleData.module_type].indexOf(moduleData.id);
        }

        if (index !== 'undefined' && index > -1) {
            dataCollectionSectionForm['funcs']['moduleinfo']([], ['cancel', 'repo-sync']);
        } else {
            dataCollectionSectionForm['funcs']['moduleinfo']([], ['install', 'remove', 'repo-sync']);
        }
    }

    dataCollectionSectionForm['funcs']['moduleinfo'](['info', 'buttons'], []);

    if (moduleData['app_type'] === 'core') {
        if (moduleInfo['name'] !== 'Core') {
            dataCollectionSectionForm['funcs']['moduleinfo'](['info'], []);
        } else {
            if (dataCollectionSectionForm['vars']['queue']['update'][moduleData.module_type]) {
                index = dataCollectionSectionForm['vars']['queue']['update'][moduleData.module_type].indexOf(moduleData.id);
            }

            if (index !== 'undefined' && index > -1) {
                dataCollectionSectionForm['funcs']['moduleinfo'](['info', 'buttons'], ['cancel', 'repo-sync']);
            } else {
                dataCollectionSectionForm['funcs']['moduleinfo']([], ['update', 'repo-sync']);
            }
        }
    }

    dataCollectionSectionForm['funcs']['initModuleButtons']();
}

dataCollectionSectionForm['funcs']['initModuleButtons'] = function() {
    $('#{{componentId}}-{{sectionId}}-moduleinfo-install, ' +
      '#{{componentId}}-{{sectionId}}-moduleinfo-update, ' +
      '#{{componentId}}-{{sectionId}}-moduleinfo-uninstall, ' +
      '#{{componentId}}-{{sectionId}}-moduleinfo-remove, ' +
      '#{{componentId}}-{{sectionId}}-moduleinfo-cancel, ' +
      '#{{componentId}}-{{sectionId}}-moduleinfo-repo-sync').off();

    $('#{{componentId}}-{{sectionId}}-moduleinfo-install').click(function(e) {
        e.preventDefault();

        dataCollectionSectionForm['funcs']['moduleinfo'](['info', 'buttons'], ['cancel', 'repo-sync']);

        dataCollectionSectionForm['funcs']['updateQueue'](
            dataCollectionSectionForm['vars']['module']['id'],
            dataCollectionSectionForm['vars']['module']['module_type'],
            'install'
        );

        dataCollectionSectionForm['funcs']['toggleJstreeTool']('{{componentId}}-{{sectionId}}-modules-filter-install', 'info', false);
        dataCollectionSectionForm['funcs']['toggleJstreeTool']('{{componentId}}-{{sectionId}}-modules-filter-queue', 'purple', false);
    });

    $('#{{componentId}}-{{sectionId}}-moduleinfo-update').click(function(e) {
        e.preventDefault();

        dataCollectionSectionForm['funcs']['moduleinfo'](['info', 'buttons'], ['cancel', 'repo-sync']);

        dataCollectionSectionForm['funcs']['updateQueue'](
            dataCollectionSectionForm['vars']['module']['id'],
            dataCollectionSectionForm['vars']['module']['module_type'],
            'update'
        );

        dataCollectionSectionForm['funcs']['toggleJstreeTool']('{{componentId}}-{{sectionId}}-modules-filter-update', 'info', false);
        dataCollectionSectionForm['funcs']['toggleJstreeTool']('{{componentId}}-{{sectionId}}-modules-filter-queue', 'purple', false);
    });

    $('#{{componentId}}-{{sectionId}}-moduleinfo-uninstall').click(function(e) {
        e.preventDefault();

        $('#{{componentId}}-{{sectionId}}-moduleinfo-cancel').attr('hidden', false);
        $('#{{componentId}}-{{sectionId}}-moduleinfo-cancel').attr('disabled', false);
        $('#{{componentId}}-{{sectionId}}-install-update').attr('hidden', true);
        $('#{{componentId}}-{{sectionId}}-install-update').attr('disabled', true);
        $('#{{componentId}}-{{sectionId}}-moduleinfo-uninstall').attr('hidden', true);
        $('#{{componentId}}-{{sectionId}}-moduleinfo-uninstall').attr('disabled', true);
        dataCollectionSectionForm['funcs']['updateQueue'](dataCollectionSectionForm['vars']['module']['id'], dataCollectionSectionForm['vars']['module']['module_type'], true, true);
        dataCollectionSectionForm['funcs']['applyColorsToTreeIconsAndUpdateText'](dataCollectionSectionForm['vars']['module']['module_type'] + '-' + dataCollectionSectionForm['vars']['module']['id'], false, true);

        if ($('#{{componentId}}-{{sectionId}}-modules-tree-search-input').val() === 'update') {
            $('#{{componentId}}-{{sectionId}}-moduleinfo-buttons').attr('hidden', true);
            $('#{{componentId}}-{{sectionId}}-moduleinfo-info').attr('hidden', true);
            $('#{{componentId}}-{{sectionId}}-moduleinfo-noinfo').attr('hidden', false);
        }
    });

    $('#{{componentId}}-{{sectionId}}-moduleinfo-remove').click(function(e) {
        e.preventDefault();

        dataCollectionSectionForm['funcs']['moduleinfo'](['info', 'buttons'], ['cancel']);

        dataCollectionSectionForm['funcs']['updateQueue'](
            dataCollectionSectionForm['vars']['module']['id'],
            dataCollectionSectionForm['vars']['module']['module_type'],
            'remove'
        );

        dataCollectionSectionForm['funcs']['toggleJstreeTool']('{{componentId}}-{{sectionId}}-modules-filter-remove', 'danger', false);
        dataCollectionSectionForm['funcs']['toggleJstreeTool']('{{componentId}}-{{sectionId}}-modules-filter-queue', 'purple', false);
    });

    $('#{{componentId}}-{{sectionId}}-moduleinfo-cancel').click(function(e) {
        e.preventDefault();

        dataCollectionSectionForm['funcs']['clearQueue'](
            false,
            dataCollectionSectionForm['vars']['module']['id'],
            dataCollectionSectionForm['vars']['module']['module_type'],
            'install'
        );

        dataCollectionSectionForm['funcs']['applyColorsToTreeIconsAndUpdateText'](
            dataCollectionSectionForm['vars']['module']['module_type'] + '-' + dataCollectionSectionForm['vars']['module']['id']
        );
    });

    $('#{{componentId}}-{{sectionId}}-moduleinfo-repo-sync').click(function(e) {
        e.preventDefault();

        $(this).attr('disabled', true);
        $(this).children("i").removeClass("fa-sync-alt").addClass("fa-cog fa-spin");

        $('#{{componentId}}-{{sectionId}}-install-update').attr('hidden', true);
        $('#{{componentId}}-{{sectionId}}-install-update').attr('disabled', true);
        $('#{{componentId}}-{{sectionId}}-moduleinfo-uninstall').attr('hidden', true);
        $('#{{componentId}}-{{sectionId}}-moduleinfo-uninstall').attr('disabled', true);
        $('#{{componentId}}-{{sectionId}}-moduleinfo-cancel').attr('hidden', true);
        $('#{{componentId}}-{{sectionId}}-moduleinfo-cancel').attr('disabled', true);

        $('#{{componentId}}-{{sectionId}}-moduleinfo-loader').attr('hidden', false);
        $('#{{componentId}}-{{sectionId}}-moduleinfo-info').attr('hidden', true);
        $('#{{componentId}}-{{sectionId}}-moduleinfo-error').attr('hidden', true);
        dataCollectionSectionForm['funcs']['getModuleInfo'](dataCollectionSectionForm['vars']['module']['module_type'], dataCollectionSectionForm['vars']['module']['id'], true);
    });
}

dataCollectionSectionForm['funcs']['updateQueue'] = function(id, moduleType, addToQueue = 'install') {
    var index;

    if (!dataCollectionSectionForm['vars']['queue'][addToQueue][moduleType]) {
        dataCollectionSectionForm['vars']['queue'][addToQueue][moduleType] = [];
    }

    if (dataCollectionSectionForm['vars']['queue'][addToQueue][moduleType] &&
        dataCollectionSectionForm['vars']['queue'][addToQueue][moduleType].includes(id)
    ) {
        return;
    }

    dataCollectionSectionForm['vars']['queue'][addToQueue][moduleType].push(id);
    dataCollectionSectionForm['vars']['queue']['count'] = dataCollectionSectionForm['vars']['queue']['count'] + 1;

    $('#queue-counter').empty().html(dataCollectionSectionForm['vars']['queue']['count']);

    if (addToQueue === 'install') {
        dataCollectionSectionForm['funcs']['applyColorsToTreeIconsAndUpdateText'](moduleType + '-' + id, true);
    } else if (addToQueue === 'update') {
        dataCollectionSectionForm['funcs']['applyColorsToTreeIconsAndUpdateText'](moduleType + '-' + id);
    } else if (addToQueue === 'remove') {
        dataCollectionSectionForm['funcs']['applyColorsToTreeIconsAndUpdateText'](moduleType + '-' + id, false, false, true);
    }
}

dataCollectionSectionForm['funcs']['processQueue'] = function() {
    //
}

dataCollectionSectionForm['funcs']['clearQueue'] = function(clearAll = false, id = false, moduleType = false) {
    var index;

    if (clearAll) {
        dataCollectionSectionForm['vars']['queue'] = { };
        dataCollectionSectionForm['vars']['queue']['count'] = 0;
        dataCollectionSectionForm['vars']['queue']['install_update'] = { };
        dataCollectionSectionForm['vars']['queue']['uninstall'] = { };
        dataCollectionSectionForm['vars']['update_available'] = dataCollectionSectionForm['vars']['org_update_available'];
        $('#{{componentId}}-{{sectionId}}-process-queue').attr('disabled', true);
        $('#{{componentId}}-{{sectionId}}-clear-queue').attr('disabled', true);
        $('#{{componentId}}-{{sectionId}}-process-queue').off();
        $('#{{componentId}}-{{sectionId}}-clear-queue').off();
        $('#{{componentId}}-{{sectionId}}-moduleinfo-cancel').attr('disabled', true);
        $('#{{componentId}}-{{sectionId}}-moduleinfo-cancel').attr('hidden', true);

        if (dataCollectionSectionForm['vars']['module']['installed'] == 1) {
            if (dataCollectionSectionForm['vars']['module']['update_available'] == 1) {
                $('#{{componentId}}-{{sectionId}}-install-update').attr('hidden', false);
                $('#{{componentId}}-{{sectionId}}-install-update').attr('disabled', false);
            }
            $('#{{componentId}}-{{sectionId}}-moduleinfo-uninstall').attr('hidden', false);
            $('#{{componentId}}-{{sectionId}}-moduleinfo-uninstall').attr('disabled', false);
        } else {
            $('#{{componentId}}-{{sectionId}}-install-update').attr('hidden', false);
            $('#{{componentId}}-{{sectionId}}-install-update').attr('disabled', false);
            $('#{{componentId}}-{{sectionId}}-moduleinfo-uninstall').attr('hidden', true);
            $('#{{componentId}}-{{sectionId}}-moduleinfo-uninstall').attr('disabled', true);
        }
    } else {
        if (id && moduleType) {
            var actionTypes = ['install', 'update', 'uninstall', 'remove'];

            var foundIn;
            var disableFilterIcons = [];

            $(actionTypes).each(function(i, actionType) {
                if (dataCollectionSectionForm['vars']['queue'][actionType][moduleType]) {
                    if (dataCollectionSectionForm['vars']['queue'][actionType][moduleType].includes(id)) {
                        index = dataCollectionSectionForm['vars']['queue'][actionType][moduleType].indexOf(id);

                        if (index > -1) {
                            dataCollectionSectionForm['vars']['queue'][actionType][moduleType].splice(index, 1);

                            foundIn = actionType;
                        }
                    }

                    if (dataCollectionSectionForm['vars']['queue'][actionType][moduleType].length === 0) {
                        delete dataCollectionSectionForm['vars']['queue'][actionType][moduleType];
                    }

                    if (Object.keys(dataCollectionSectionForm['vars']['queue'][actionType]).length === 0) {
                        disableFilterIcons.push(actionType);
                    }
                }
            });
            //eslint-disable-next-line
            console.log(foundIn, disableFilterIcons);
            if (foundIn) {
                if (foundIn === 'install') {
                    dataCollectionSectionForm['funcs']['moduleinfo']([], ['install', 'remove', 'repo-sync']);
                } else if (foundIn === 'update') {
                    dataCollectionSectionForm['funcs']['moduleinfo']([], ['update', 'remove', 'repo-sync']);
                } else if (foundIn === 'uninstall') {
                    if (dataCollectionSectionForm['vars']['module']['update_available'] == '1') {
                        dataCollectionSectionForm['funcs']['moduleinfo']([], ['update', 'remove', 'repo-sync']);
                    } else {
                        dataCollectionSectionForm['funcs']['moduleinfo']([], ['uninstall', 'remove', 'repo-sync']);
                    }
                } else if (foundIn === 'remove') {
                    if (dataCollectionSectionForm['vars']['module']['update_available'] == '1') {
                        dataCollectionSectionForm['funcs']['moduleinfo']([], ['update', 'remove', 'repo-sync']);
                    } else if (dataCollectionSectionForm['vars']['module']['installed'] == '1') {
                        dataCollectionSectionForm['funcs']['moduleinfo']([], ['uninstall', 'remove', 'repo-sync']);
                    } else {
                        dataCollectionSectionForm['funcs']['moduleinfo']([], ['install', 'remove', 'repo-sync']);
                    }
                }

                if (dataCollectionSectionForm['vars']['module']['app_type'] === 'core') {
                    if (dataCollectionSectionForm['vars']['module']['name'] !== 'Core') {
                        dataCollectionSectionForm['funcs']['moduleinfo'](['info'], []);
                    } else {
                        dataCollectionSectionForm['funcs']['moduleinfo'](['info', 'buttons'], ['update', 'repo-sync']);
                    }
                }
            }

            if (disableFilterIcons.length > 0) {
                $(disableFilterIcons).each(function(i, filterIcon) {
                    dataCollectionSectionForm['funcs']['toggleJstreeTool']('{{componentId}}-{{sectionId}}-modules-filter-' + filterIcon);
                });
            }
        }

        dataCollectionSectionForm['vars']['queue']['count'] = dataCollectionSectionForm['vars']['queue']['count'] - 1;
    }

    $('#queue-counter').empty().html(dataCollectionSectionForm['vars']['queue']['count']);

    dataCollectionSectionForm['funcs']['applyColorsToTreeIconsAndUpdateText']();
}

dataCollectionSectionForm['funcs']['deleteRepo'] = function(repoName, repoId) {
    Swal.fire({
        title                       : '<i class="fa text-danger fa-lg fa-question-circle m-2">' +
                                      '</i> <span style="font-size:40px;" class="text-danger"> Delete Repo ' +
                                      repoName + '?</span>',
        icon                        : 'question',
        background                  : 'rgba(0,0,0,.8)',
        backdrop                    : 'rgba(0,0,0,.6)',
        buttonsStyling              : false,
        confirmButtonText           : 'Delete',
        customClass                 : {
            'confirmButton'             : 'btn btn-danger text-uppercase',
            'cancelButton'              : 'ml-2 btn btn-secondary text-uppercase',
        },
        showCancelButton            : true,
        keydownListenerCapture      : true,
        allowOutsideClick           : false,
        allowEscapeKey              : false,
        didOpen                     : function() {
            window.dataCollection.env.sounds.swalSound.play();
        }
    }).then((result) => {
        if (result.isConfirmed) {
            var postData = { };
            postData[$('#security-token').attr('name')] = $('#security-token').val();
            postData['id'] = repoId;

            $.post('{{links.url("system/api/remove")}}', postData,
                    function(response) {
                        if (response.responseCode == 0) {
                            $('#{{componentId}}-{{sectionId}}-repositories').find('[data-value="' + repoId + '"]').remove();
                        } else {
                            PNotify.error({
                                text        : response.responseMessage,
                                textTrusted : true
                            });
                        }
                        if (response.tokenKey && response.token) {
                            $('#security-token').attr('name', response.tokenKey);
                            $('#security-token').val(response.token);
                        }
                    },
                    'json'
                );
        }
    });
}
$('#{{componentId}}-{{sectionId}}-delete').click(function() {
    var repoName = $('#{{componentId}}-{{sectionId}}-repositories option:selected').html();
    var repoId = $('#{{componentId}}-{{sectionId}}-repositories option:selected').val();

    dataCollectionSectionForm['funcs']['deleteRepo'](repoName, repoId);
});

dataCollectionSectionForm['funcs']['initSync'] = function(val) {
    // $('#{{componentId}}-{{sectionId}}-sync').off();

    // dataCollectionSectionForm['funcs']['changeRepoButtons'](val);

    // $('#{{componentId}}-{{sectionId}}-sync').click(function() {
    //     $('#{{componentId}}-{{sectionId}}-sync, ' +
    //       '#{{componentId}}-{{sectionId}}-delete, ' +
    //       '#{{componentId}}-{{sectionId}}-add').attr('disabled', true);
    //     $('#{{componentId}}-{{sectionId}}-edit').addClass('disabled');

        $('#{{componentId}}-{{sectionId}}-modules-repo-sync').children("i").removeClass("fa-sync-alt").addClass("fa-cog fa-spin");

        var postData = { };
        postData[$('#security-token').attr('name')] = $('#security-token').val();
        postData['repoId'] = val;

        $.post('{{links.url("modules/sync")}}', postData, function(response) {
            if (response.tokenKey && response.token) {
                $('#security-token').attr('name', response.tokenKey);
                $('#security-token').val(response.token);
            }

            if (response.responseCode == 0) {
                if (response.responseData && response.responseData.register !== 'undefined' && response.responseData.update !== 'undefined') {
                    var text, registerCounter, updateCounter;

                    registerCounter = response.responseData.counter.register;
                    updateCounter = response.responseData.counter.update;

                    if (registerCounter > 0 || updateCounter > 0) {
                        if (registerCounter !== 0 && updateCounter === 0) {
                            text =
                                'Sync Complete.<br>' + registerCounter + ' new modules available.<br> No updates available.';
                        } else if (registerCounter === 0 && updateCounter !== 0) {
                            text =
                                'Sync Complete.<br>' + updateCounter + ' new updates available.<br> No new modules available.';
                        } else if (registerCounter !== 0 && updateCounter !== 0) {
                            text =
                                'Sync Complete.<br>' + updateCounter + ' new updates available.<br>' + registerCounter + ' new modules available.';
                        }

                        if (updateCounter > 0) {
                            dataCollectionSectionForm['vars']['update_available'] = updateCounter;
                            dataCollectionSectionForm['vars']['filter'] = true;
                            $('#{{componentId}}-{{sectionId}}-modules-tree-search-input').val('update');
                            $('#{{componentId}}-{{sectionId}}-modules').jstree().search('update');
                        }
                    } else {
                        text = 'Sync Complete.<br>No new modules or updates available.';
                    }

                    PNotify.info({
                        text        : text,
                        textTrusted : true
                    });
                }
            } else {
                PNotify.error({
                    text        : response.responseMessage,
                    textTrusted : true
                });
                $('#modules-data').attr('hidden', false);
                $('#modules-loader').attr('hidden', true);
                $('#repository-sync').attr('hidden', true);
                $('#{{componentId}}-{{sectionId}}-sync, #{{componentId}}-{{sectionId}}-edit, #{{componentId}}-{{sectionId}}-delete, #{{componentId}}-{{sectionId}}-add').attr('disabled', false);
            }

            $('#{{componentId}}-{{sectionId}}-modules-repo-sync').children("i").removeClass("fa-cog fa-spin").addClass("fa-sync-alt");

            if (postData['repoId'] != '1' && postData['repoId'] != '2') {
                $('#{{componentId}}-{{sectionId}}-delete').attr('disabled', false);
            }
        }, 'json');
    // });
}

$(document).ready(function() {
    BazProgress.buildProgressBar($('#installer-progress'));
});

// $('#{{componentId}}-{{sectionId}}-repositories').change(function() {
//     dataCollectionSectionForm['funcs']['initSync']($(this).val());
// });


// $('#{{componentId}}-{{sectionId}}-repositories').on('focus', function() {
//     dataCollectionSectionForm['vars']['previous'] = this.value;
// }).change(function() {
//     if (this.value == '0') {
//         dataCollectionSectionForm['vars']['previous'] = this.value;
//         $('#repo-details').attr('hidden', true);
//         return;
//     } else {
//         dataCollectionSectionForm['funcs']['processRepositorySwitch']();
//     }

//     // if (dataCollectionSectionForm['vars']['previous'] == '0') {
//     //     dataCollectionSectionForm['vars']['previous'] = this.value;
//     //     dataCollectionSectionForm['funcs']['processRepositorySwitch']();
//     //     return;
//     // }

//     // Swal.fire({
//     //     title                       : '<span class="text-warning"> Switch Repository? It will reset the queue.</span>',
//     //     icon                        : 'question',
//     //     background                  : 'rgba(0,0,0,.8)',
//     //     backdrop                    : 'rgba(0,0,0,.6)',
//     //     buttonsStyling              : false,
//     //     confirmButtonText           : 'Switch',
//     //     customClass                 : {
//     //         'confirmButton'             : 'btn btn-warning text-uppercase',
//     //         'cancelButton'              : 'ml-2 btn btn-secondary text-uppercase',
//     //     },
//     //     showCancelButton            : true,
//     //     keydownListenerCapture      : true,
//     //     allowOutsideClick           : false,
//     //     allowEscapeKey              : false,
//     //     didOpen                     : function() {
//     //         window['dataCollection'].env.sounds.swalSound.play();
//     //     }
//     // }).then((result) => {
//     //     if (result.value) {
//     //         dataCollectionSectionForm['funcs']['processRepositorySwitch']();
//     //     } else {
//     //         $('#{{componentId}}-{{sectionId}}-repositories').val(dataCollectionSectionForm['vars']['previous']);
//     //     }
//     // });
// });

// dataCollectionSectionForm['funcs']['processRepositorySwitch'] = function() {
//     var selectedRepository = $('#{{componentId}}-{{sectionId}}-repositories').find(":selected").data('value');

//     $('#repo-details').attr('hidden', false);

//     // dataCollectionSectionForm['vars']['queue'] = { };
//     // dataCollectionSectionForm['vars']['queue']['count'] = 0;
//     // dataCollectionSectionForm['vars']['queue']['install_update'] = { };
//     // dataCollectionSectionForm['vars']['queue']['uninstall'] = { };
//     $('#{{componentId}}-{{sectionId}}-process-queue').attr('disabled', true);
//     $('#{{componentId}}-{{sectionId}}-clear-queue').attr('disabled', true);
//     $('#{{componentId}}-{{sectionId}}-process-queue').off();
//     $('#{{componentId}}-{{sectionId}}-clear-queue').off();
//     $('#{{componentId}}-{{sectionId}}-moduleinfo-cancel').attr('disabled', true);
//     $('#{{componentId}}-{{sectionId}}-moduleinfo-cancel').attr('hidden', true);
//     $('#{{componentId}}-{{sectionId}}-install-update').attr('disabled', true);
//     $('#{{componentId}}-{{sectionId}}-install-update').attr('hidden', true);
//     $('#{{componentId}}-{{sectionId}}-moduleinfo-uninstall').attr('disabled', true);
//     $('#{{componentId}}-{{sectionId}}-moduleinfo-uninstall').attr('hidden', true);
//     $('#{{componentId}}-{{sectionId}}-moduleinfo-repo-sync').attr('disabled', true);
//     $('#{{componentId}}-{{sectionId}}-moduleinfo-repo-sync').attr('hidden', true);
//     $('#{{componentId}}-{{sectionId}}-moduleinfo-info').attr('hidden', true);
//     $('#{{componentId}}-{{sectionId}}-moduleinfo-noinfo').attr('hidden', false);
//     $('#queue-counter').empty().html(dataCollectionSectionForm['vars']['queue']['count']);
//     $('#{{componentId}}-{{sectionId}}-modules').jstree().destroy();
//     if ($('#{{componentId}}-{{sectionId}}-modules-empty').length > 0) {
//         $('#{{componentId}}-{{sectionId}}-modules-empty').remove();
//     }

//     $('#{{componentId}}-{{sectionId}}-modules').append(
//         '<div id="{{componentId}}-{{sectionId}}-modules-empty" class="text-center">' +
//             '<i class="fa fa-cog fa-spin"></i> Loading modules...' +
//         '</div>'
//     );

//     dataCollectionSectionForm['funcs']['getRepositoryModules'](selectedRepository);
// }

// dataCollectionSectionForm['funcs']['changeRepoButtons'] = function(val = '0') {
//     var url = "{{links.url('system/api/q/repository/true/id/')}}" + val;

//     if (val == '1' || val == '2') {
//         $('#{{componentId}}-{{sectionId}}-sync').attr('disabled', false);
//         $('#{{componentId}}-{{sectionId}}-delete').attr('disabled', true);
//         $('#{{componentId}}-{{sectionId}}-edit').removeClass('disabled');
//         $('#{{componentId}}-{{sectionId}}-edit').attr('href', url);
//     } else if (val == '0') {
//         $('#{{componentId}}-{{sectionId}}-sync, #{{componentId}}-{{sectionId}}-delete').attr('disabled', true);
//         $('#{{componentId}}-{{sectionId}}-edit').addClass('disabled');
//     } else {
//         $('#{{componentId}}-{{sectionId}}-sync, #{{componentId}}-{{sectionId}}-delete').attr('disabled', false);
//         $('#{{componentId}}-{{sectionId}}-edit').removeClass('disabled');
//         $('#{{componentId}}-{{sectionId}}-edit').attr('href', url);
//     }
// }
</script>
{% include 'modules/modal.html' %}