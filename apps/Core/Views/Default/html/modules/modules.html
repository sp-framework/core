<div class="row">
    <div id="repo" class="col">
        {% include 'modules/repositories/list.html' %}
    </div>
</div>
<div id="repo-details" class="row" hidden>
    <div class="col">
        <hr>
        <div class="row vdivide">
            <div class="col-md-3 vdivide-resizable">
                {{adminltetags.useTag('fields',
                    [
                        'component'                                 : component,
                        'componentName'                             : componentName,
                        'componentId'                               : componentId,
                        'sectionId'                                 : sectionId,
                        'fieldId'                                   : 'modules',
                        'fieldLabel'                                : 'Modules',
                        'fieldType'                                 : 'jstree',
                        'fieldHelp'                                 : true,
                        'fieldHelpTooltipContent'                   : 'Available modules on repository.',
                        'fieldRequired'                             : false,
                        'fieldBazScan'                              : true,
                        'fieldJstreeSearch'                         : true,
                        'fieldBazPostOnCreate'                      : false,
                        'fieldBazPostOnUpdate'                      : false,
                        'fieldJstreeDataSrcArr'                     : ["modules":["srcArr" : []]],
                        'fieldJstreeAdd'                            : false,
                        'fieldJstreeEdit'                           : false,
                        'fieldJstreeExpand'                         : true,
                        'fieldJstreeCollapse'                       : true,
                        'fieldJstreeFirstOpen'                      : true,
                        'fieldJstreeAllOpen'                        : true,
                        'fieldJstreeAllChecked'                     : false,
                        'fieldJstreeRootIcon'                       : 'th',
                        'fieldJstreeToggleAllChildren'              : true,
                        'fieldJstreeIncludeRootInPath'              : true,
                        'fieldJstreeSelectEndNodeOnly'              : true,
                        'fieldJstreeShowDots'                       : true,
                        'fieldJstreeDoubleClickToggle'              : true,
                        'fieldJstreeMultiple'                       : false,
                        'fieldJstreeSearchCaseSensitive'            : false,
                        'fieldJstreeSearchShowOnlyMatches'          : true,
                        'fieldJstreeSearchShowOnlyMatchesChildren'  : true,
                        'fieldJstreeHideJstreeIcons'                : false,
                        'fieldJstreeAdditionalTools'                :
                            [
                                'filter-update' :
                                    [
                                        'id'        : 'filter-update',
                                        'tooltip'   : 'Apply Filter (update)',
                                        'icon'      : 'fas fa-fw fa-circle-up text-warning'
                                    ],
                                'filter-install' :
                                    [
                                        'id'        : 'filter-install',
                                        'tooltip'   : 'Apply Filter Install/Update (:install)',
                                        'icon'      : 'fas fa-fw fa-circle-plus text-info'
                                    ],
                                'filter-uninstall' :
                                    [
                                        'id'        : 'filter-uninstall',
                                        'tooltip'   : 'Apply Filter Uninstall (:uninstall)',
                                        'icon'      : 'fas fa-fw fa-circle-minus text-danger'
                                    ],
                                'filter-queue' :
                                    [
                                        'id'        : 'filter-queue',
                                        'tooltip'   : 'Apply Filter In Queue (queue:)',
                                        'icon'      : 'fas fa-fw fa-list text-purple'
                                    ],
                                'filter-clear' :
                                    [
                                        'id'        : 'filter-clear',
                                        'tooltip'   : 'Clear all filters',
                                        'icon'      : 'fas fa-fw fa-times text-secondary'
                                    ]
                            ],
                        'fieldJstreeReplaceIdWithDataField'         : 'moduleid',
                        'fieldJstreePlugins'                        : ["search", "types"],
                        'fieldJstreeAdditionalClass'                : 'text-uppercase'
                    ]
                )}}
            </div>
            <div class="col">
                <div class="row text-center m-2" id="{{componentId}}-{{sectionId}}-moduleinfo-error" hidden>
                    <div class="col">
                        <h6><i class="fa fa-fw fa-info-circle text-danger"></i> Error loading module information. Please contact administrator.</h6>
                    </div>
                </div>
                <div class="row text-center m-2" id="{{componentId}}-{{sectionId}}-moduleinfo-noinfo" hidden>
                    <div class="col">
                        <h6><i class="fa fa-fw fa-info-circle text-info"></i> Select module from tree to see it's details.</h6>
                    </div>
                </div>
                <div class="row text-center" id="{{componentId}}-{{sectionId}}-moduleinfo-loader">
                    <div class="col">
                        <i class="fa fa-cog fa-spin"></i> Loading module information...
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <div id="{{componentId}}-{{sectionId}}-moduleinfo-info" hidden>
                            <div class="row">
                                <div class="col">
                                    <label>NAME: </label>
                                    <span class="text-uppercase" id="display_name"></span>
                                </div>
                                <div class="col">
                                    <label>INSTALLED: </label>
                                    <span class="text-uppercase" style="top: -1px;position: relative;" id="installed"></span>
                                </div>
                                <div class="col">
                                    <label>VERSION: </label>
                                    <span class="text-uppercase" style="top: -1px;position: relative;" id="version"></span>
                                </div>
                            </div>
                            <hr class="mt-1">
                            <div class="row">
                                <div class="col small">
                                    <label>APP TYPE: </label>
                                    <span class="text-uppercase" id="app_type"></span>
                                </div>
                                <div class="col small">
                                    <label>CATEGORY: </label>
                                    <span class="text-uppercase" id="category"></span>
                                </div>
                                <div class="col small">
                                    <label>SUB CATEGORY: </label>
                                    <span class="text-uppercase" id="sub_category"></span>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col small">
                                    <label>UPDATE AVAILABLE: </label>
                                    <span id="update_available"></span>
                                </div>
                                <div class="col small">
                                    <label>UPDATE VERSION: </label>
                                    <span id="update_version"></span>
                                </div>
                                <div class="col small">
                                    <label>UPDATED ON: </label>
                                    <span id="updated_on"></span>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col small">
                                    <label>INSTALLED/UPDATED BY: </label>
                                    <span id="updated_by"></span>
                                </div>
                                <div class="col small">
                                    <label>MODULE TYPE: </label>
                                    <span class="text-uppercase" id="module_type"></span>
                                </div>
                                <div class="col small">
                                    <span class="text-uppercase" id="module_id" hidden></span>
                                </div>
                            </div>
                            <hr class="mt-1">
                            <div class="row">
                                <div class="col">
                                    <p id="description"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col" id="module-buttons">
                        {{adminltetags.useTag('buttons',
                            [
                                'component'                     : component,
                                'componentName'                 : componentName,
                                'componentId'                   : componentId,
                                'sectionId'                     : sectionId,
                                'buttonType'                    : 'button',
                                'buttons'                       :
                                    [
                                        'repo-sync'        : [
                                            'title'             : false,
                                            'size'              : 'xs',
                                            'icon'              : 'sync-alt',
                                            'position'          : 'right'
                                        ],
                                        'install-update'        : [
                                            'title'             : 'Install',
                                            'size'              : 'xs',
                                            'hidden'            : true,
                                            'disabled'          : true
                                        ],
                                        'uninstall'        : [
                                            'title'             : 'Remove',
                                            'type'              : 'danger',
                                            'size'              : 'xs',
                                            'hidden'            : true,
                                            'disabled'          : true
                                        ],
                                        'cancel'        : [
                                            'title'             : 'Cancel',
                                            'type'              : 'secondary',
                                            'size'              : 'xs',
                                            'hidden'            : true,
                                            'disabled'          : true
                                        ]
                                    ]
                            ]
                        )}}
                    </div>
                </div>
            </div>
        </div>
        <hr>
        <div class="row">
            <div class="col-md-6">
                <div id="installer-progress" class="mb-3"></div>
            </div>
            <div class="col">
                <span class="text-uppercase float-right">Queue:
                    <span style="top: -2px;position: relative;" class="badge badge-info" id="queue-counter">0</span>
                </span>
            </div>
            <div class="col">
                {{adminltetags.useTag('buttons',
                    [
                        'component'                     : component,
                        'componentName'                 : componentName,
                        'componentId'                   : componentId,
                        'sectionId'                     : sectionId,
                        'buttonType'                    : 'button',
                        'buttons'                       :
                            [
                                'analyse-queue'     : [
                                    'title'             : 'Analyse Queue',
                                    'position'          : 'right',
                                    'size'              : 'xs',
                                    'icon'              : 'fa-cog fa-spin',
                                    'iconHidden'        : true,
                                    'disabled'          : true
                                ],
                                'clear-queue'       : [
                                    'title'             : 'Clear Queue',
                                    'position'          : 'right',
                                    'type'              : 'danger',
                                    'size'              : 'xs',
                                    'disabled'          : true
                                ]
                            ]
                    ]
                )}}
            </div>
        </div>
    </div>
</div>
<script>
/*global PNotify BazProgress Swal BazContentFields */
var dataCollectionComponent, dataCollectionSection, dataCollectionSectionForm;

if (!window['dataCollection']['{{componentId}}']) {
    dataCollectionComponent =
        window['dataCollection']['{{componentId}}'] = { };
} else {
    dataCollectionComponent =
        window['dataCollection']['{{componentId}}'];
}
if (!dataCollectionComponent['{{componentId}}-{{sectionId}}']) {
    dataCollectionSection =
        dataCollectionComponent['{{componentId}}-{{sectionId}}'] = { };
} else {
    dataCollectionSection =
        dataCollectionComponent['{{componentId}}-{{sectionId}}'];
}
if (!dataCollectionSection['{{componentId}}-{{sectionId}}-form']) {
    dataCollectionSectionForm =
        dataCollectionSection['{{componentId}}-{{sectionId}}-form'] = { };
} else {
    dataCollectionSectionForm =
        dataCollectionSection['{{componentId}}-{{sectionId}}-form'];
}

dataCollectionSectionForm['vars'] = { };
dataCollectionSectionForm['funcs'] = { };

dataCollectionSectionForm['vars']['modules'] = { };
dataCollectionSectionForm['vars']['module'] = { };
dataCollectionSectionForm['vars']['queue'] = { };
dataCollectionSectionForm['vars']['queue']['count'] = 0;
dataCollectionSectionForm['vars']['queue']['install_update'] = { };
dataCollectionSectionForm['vars']['queue']['uninstall'] = { };
dataCollectionSectionForm['vars']['initJstree'] = false;

$('#{{componentId}}-{{sectionId}}-repositories').on('focus', function() {
    dataCollectionSectionForm['vars']['previous'] = this.value;
}).change(function() {
    if (this.value == '0') {
        dataCollectionSectionForm['vars']['previous'] = this.value;
        $('#repo-details').attr('hidden', true);
        return;
    } else {
        dataCollectionSectionForm['funcs']['processRepositorySwitch']();
    }

    // if (dataCollectionSectionForm['vars']['previous'] == '0') {
    //     dataCollectionSectionForm['vars']['previous'] = this.value;
    //     dataCollectionSectionForm['funcs']['processRepositorySwitch']();
    //     return;
    // }

    // Swal.fire({
    //     title                       : '<span class="text-warning"> Switch Repository? It will reset the queue.</span>',
    //     icon                        : 'question',
    //     background                  : 'rgba(0,0,0,.8)',
    //     backdrop                    : 'rgba(0,0,0,.6)',
    //     buttonsStyling              : false,
    //     confirmButtonText           : 'Switch',
    //     customClass                 : {
    //         'confirmButton'             : 'btn btn-warning text-uppercase',
    //         'cancelButton'              : 'ml-2 btn btn-secondary text-uppercase',
    //     },
    //     showCancelButton            : true,
    //     keydownListenerCapture      : true,
    //     allowOutsideClick           : false,
    //     allowEscapeKey              : false,
    //     didOpen                     : function() {
    //         window['dataCollection'].env.sounds.swalSound.play();
    //     }
    // }).then((result) => {
    //     if (result.value) {
    //         dataCollectionSectionForm['funcs']['processRepositorySwitch']();
    //     } else {
    //         $('#{{componentId}}-{{sectionId}}-repositories').val(dataCollectionSectionForm['vars']['previous']);
    //     }
    // });
});

dataCollectionSectionForm['funcs']['processRepositorySwitch'] = function() {
    var selectedRepository = $('#{{componentId}}-{{sectionId}}-repositories').find(":selected").data('value');

    $('#repo-details').attr('hidden', false);

    dataCollectionSectionForm['vars']['queue'] = { };
    dataCollectionSectionForm['vars']['queue']['count'] = 0;
    dataCollectionSectionForm['vars']['queue']['install_update'] = { };
    dataCollectionSectionForm['vars']['queue']['uninstall'] = { };
    $('#{{componentId}}-{{sectionId}}-process-queue').attr('disabled', true);
    $('#{{componentId}}-{{sectionId}}-clear-queue').attr('disabled', true);
    $('#{{componentId}}-{{sectionId}}-process-queue').off();
    $('#{{componentId}}-{{sectionId}}-clear-queue').off();
    $('#{{componentId}}-{{sectionId}}-cancel').attr('disabled', true);
    $('#{{componentId}}-{{sectionId}}-cancel').attr('hidden', true);
    $('#{{componentId}}-{{sectionId}}-uninstall').attr('disabled', true);
    $('#{{componentId}}-{{sectionId}}-uninstall').attr('hidden', true);
    $('#{{componentId}}-{{sectionId}}-repo-sync').attr('disabled', true);
    $('#{{componentId}}-{{sectionId}}-repo-sync').attr('hidden', true);
    $('#{{componentId}}-{{sectionId}}-moduleinfo-info').attr('hidden', true);
    $('#{{componentId}}-{{sectionId}}-moduleinfo-noinfo').attr('hidden', false);
    $('#queue-counter').empty().html(dataCollectionSectionForm['vars']['queue']['count']);
    $('#{{componentId}}-{{sectionId}}-modules').jstree().destroy();
    if ($('#{{componentId}}-{{sectionId}}-modules-empty').length > 0) {
        $('#{{componentId}}-{{sectionId}}-modules-empty').remove();
    }

    $('#{{componentId}}-{{sectionId}}-modules').append(
        '<div id="{{componentId}}-{{sectionId}}-modules-empty" class="text-center">' +
            '<i class="fa fa-cog fa-spin"></i> Loading modules...' +
        '</div>'
    );

    dataCollectionSectionForm['funcs']['getRepositoryModules'](selectedRepository);
}

dataCollectionSectionForm['funcs']['jstreeSelectNode'] = function() {
    $('#{{componentId}}-{{sectionId}}-modules').off('select_node.jstree');
    $('#{{componentId}}-{{sectionId}}-modules').on('select_node.jstree', function() {
        var selected = $('#{{componentId}}-{{sectionId}}-modules').jstree().get_selected();

        if (selected[0].startsWith('j')) {
            return false;
        }

        $('#{{componentId}}-{{sectionId}}-moduleinfo-loader').attr('hidden', false);
        $('#{{componentId}}-{{sectionId}}-moduleinfo-info').attr('hidden', true);
        $('#{{componentId}}-{{sectionId}}-moduleinfo-error').attr('hidden', true);

        dataCollectionSectionForm['funcs']['getSelectedModuleInfo'](selected);
    });
}
dataCollectionSectionForm['funcs']['jstreeSelectNode']();

dataCollectionSectionForm['funcs']['jstreeReady'] = function() {
    $('#{{componentId}}-{{sectionId}}-modules').off('ready.jstree');
    $('#{{componentId}}-{{sectionId}}-modules').on('ready.jstree', function() {
        var coreTree = $('#{{componentId}}-{{sectionId}}-modules').jstree().get_json('#', {flat:true});

        var selected = [];

        $(coreTree).each(function(i, v) {
            v.text = v.text.toLowerCase();
            if (v.text.includes('core')) {
                selected.push(v.id);
                $('#{{componentId}}-{{sectionId}}-modules').jstree().select_node(v.id);
                return false;
            }
        });

        dataCollectionSectionForm['funcs']['applyColorsToIconsAndUpdateText'](null, false, false, true);
    });

    $('#{{componentId}}-{{sectionId}}-modules').on('search.jstree', function(e, res) {
        if (res.nodes.length === 0) {
            $('#{{componentId}}-{{sectionId}}-modules-tree-search-input').val('');
            $('#{{componentId}}-{{sectionId}}-modules').jstree().clear_search();
        }

        if (dataCollectionSectionForm['vars']['initJstree'] === true) {
            PNotify.info({
                text        : res.nodes.length + ' new updates available.',
                textTrusted : true
            });
        }
    });

    $('#{{componentId}}-{{sectionId}}-modules-filter-update').off();
    $('#{{componentId}}-{{sectionId}}-modules-filter-update').click(function(e) {
        e.preventDefault();

        dataCollectionSectionForm['vars']['filter'] = true;
        $('#{{componentId}}-{{sectionId}}-modules').jstree().clear_search();
        $('#{{componentId}}-{{sectionId}}-modules-tree-search-input').val('update');
        $('#{{componentId}}-{{sectionId}}-modules').jstree().search('update');
        $('#{{componentId}}-{{sectionId}}-modules').jstree().deselect_all();
        $('#module-buttons').attr('hidden', true);
        $('#{{componentId}}-{{sectionId}}-moduleinfo-info').attr('hidden', true);
        $('#{{componentId}}-{{sectionId}}-moduleinfo-noinfo').attr('hidden', false);
    });
    $('#{{componentId}}-{{sectionId}}-modules-filter-install').off();
    $('#{{componentId}}-{{sectionId}}-modules-filter-install').click(function(e) {
        e.preventDefault();

        //We only need this during update so when we click on update the node is hidden from the filter tree.
        dataCollectionSectionForm['vars']['filter'] = false;
        $('#{{componentId}}-{{sectionId}}-modules').jstree().clear_search();
        $('#{{componentId}}-{{sectionId}}-modules-tree-search-input').val(':Install');
        $('#{{componentId}}-{{sectionId}}-modules').jstree().search(':Install');
        $('#{{componentId}}-{{sectionId}}-modules').jstree().deselect_all();
        $('#module-buttons').attr('hidden', true);
        $('#{{componentId}}-{{sectionId}}-moduleinfo-info').attr('hidden', true);
        $('#{{componentId}}-{{sectionId}}-moduleinfo-noinfo').attr('hidden', false);
    });

    $('#{{componentId}}-{{sectionId}}-modules-filter-uninstall').off();
    $('#{{componentId}}-{{sectionId}}-modules-filter-uninstall').click(function(e) {
        e.preventDefault();

        //We only need this during update so when we click on update the node is hidden from the filter tree.
        dataCollectionSectionForm['vars']['filter'] = false;
        $('#{{componentId}}-{{sectionId}}-modules').jstree().clear_search();
        $('#{{componentId}}-{{sectionId}}-modules-tree-search-input').val(':Uninstall');
        $('#{{componentId}}-{{sectionId}}-modules').jstree().search(':Uninstall');
        $('#{{componentId}}-{{sectionId}}-modules').jstree().deselect_all();
        $('#module-buttons').attr('hidden', true);
        $('#{{componentId}}-{{sectionId}}-moduleinfo-info').attr('hidden', true);
        $('#{{componentId}}-{{sectionId}}-moduleinfo-noinfo').attr('hidden', false);
    });

    $('#{{componentId}}-{{sectionId}}-modules-filter-queue').off();
    $('#{{componentId}}-{{sectionId}}-modules-filter-queue').click(function(e) {
        e.preventDefault();

        //We only need this during update so when we click on update the node is hidden from the filter tree.
        dataCollectionSectionForm['vars']['filter'] = false;
        $('#{{componentId}}-{{sectionId}}-modules').jstree().clear_search();
        $('#{{componentId}}-{{sectionId}}-modules-tree-search-input').val('in queue:');
        $('#{{componentId}}-{{sectionId}}-modules').jstree().search('in queue:');
        $('#{{componentId}}-{{sectionId}}-modules').jstree().deselect_all();
        $('#module-buttons').attr('hidden', true);
        $('#{{componentId}}-{{sectionId}}-moduleinfo-info').attr('hidden', true);
        $('#{{componentId}}-{{sectionId}}-moduleinfo-noinfo').attr('hidden', false);
    });

    $('#{{componentId}}-{{sectionId}}-modules-filter-clear').off();
    $('#{{componentId}}-{{sectionId}}-modules-filter-clear').click(function(e) {
        e.preventDefault();

        //We only need this during update so when we click on update the node is hidden from the filter tree.
        dataCollectionSectionForm['vars']['filter'] = false;
        $('#{{componentId}}-{{sectionId}}-modules').jstree().clear_search();
        $('#{{componentId}}-{{sectionId}}-modules-tree-search-input').val('');
        $('#{{componentId}}-{{sectionId}}-modules').jstree().deselect_all();
        $('#module-buttons').attr('hidden', true);
        $('#{{componentId}}-{{sectionId}}-moduleinfo-info').attr('hidden', true);
        $('#{{componentId}}-{{sectionId}}-moduleinfo-noinfo').attr('hidden', false);
    });

    $('#{{componentId}}-{{sectionId}}-modules-tree-search-input').on('keyup', function() {
        if ($('#{{componentId}}-{{sectionId}}-modules-tree-search-input').val() === '') {
            dataCollectionSectionForm['vars']['filter'] = false;
        } else {
            dataCollectionSectionForm['vars']['filter'] = true;
        }
    });
}
dataCollectionSectionForm['funcs']['jstreeReady']();

dataCollectionSectionForm['funcs']['getRepositoryModules'] = function(repositoryId) {
    var postData = { };
    postData[$('#security-token').attr('name')] = $('#security-token').val();
    postData['api_id'] = repositoryId;

    $.post('{{links.url("modules/getRepositoryModules")}}', postData, function(response) {
        if (response.tokenKey && response.token) {
            $('#security-token').attr('name', response.tokenKey);
            $('#security-token').val(response.token);
        }

        $('#{{componentId}}-{{sectionId}}-moduleinfo-loader').attr('hidden', true);
        $('#{{componentId}}-{{sectionId}}-repo-sync').attr('disabled', false);
        $('#{{componentId}}-{{sectionId}}-repo-sync').children("i").removeClass("fa-cog fa-spin").addClass("fa-sync-alt");

        if (response.responseCode == 0) {
            if (response.responseData.modules) {
                dataCollectionSectionForm['vars']['modules'] = response.responseData.modules;
            }
            if (response.responseData.modules_html && response.responseData.modules_html !== '') {
                var modulesHtml =
                    '<div id="{{componentId}}-{{sectionId}}-modules" data-bazscantype="jstree">' +
                        '<ul>' +
                            '<li data-jstree="{&quot;icon&quot; : &quot;fa fa-fw fa-th text-sm&quot;}">' +
                                '<ul>' +
                                    response.responseData.modules_html +
                                '</ul>' +
                            '</li>' +
                        '</ul>' +
                    '</div>';

                $('#{{componentId}}-{{sectionId}}-modules-tree-div').empty().html(modulesHtml);
            }

            BazContentFields.init({
                'componentId'   : '{{componentId}}',
                'sectionId'     : '{{componentId}}-{{sectionId}}',
                'fieldId'       : '{{componentId}}-{{sectionId}}-modules'
            });

            dataCollectionSectionForm['funcs']['jstreeSelectNode']();
            dataCollectionSectionForm['funcs']['jstreeReady']();
        } else if (response.responseCode == 1) {
            $('#{{componentId}}-{{sectionId}}-moduleinfo-info').attr('hidden', true);
            $('#module-buttons').attr('hidden', true);
            $('#{{componentId}}-{{sectionId}}-moduleinfo-noinfo').attr('hidden', false);
        }
    }, 'json');
}

dataCollectionSectionForm['funcs']['getSelectedModuleInfo'] = function(selected) {
    if (selected.length === 0) {
        return false;
    }

    var splitModule, moduleType, moduleId;

    if (selected.length === 1) {
        splitModule = selected[0].split('-');
        moduleId = splitModule[1];

        if (selected[0].startsWith('components')) {
            moduleType = 'components';
        } else if (selected[0].startsWith('packages')) {
            moduleType = 'packages';
        } else if (selected[0].startsWith('middlewares')) {
            moduleType = 'middlewares';
        } else if (selected[0].startsWith('views')) {
            moduleType = 'views';
        }
    }

    if (moduleType && moduleId) {
        dataCollectionSectionForm['funcs']['getModuleInfo'](moduleType, moduleId);
    }
}

dataCollectionSectionForm['funcs']['getModuleInfo'] = function(moduleType, moduleId, sync = false) {
    var postData = { };
    postData[$('#security-token').attr('name')] = $('#security-token').val();
    postData['module_type'] = moduleType;
    postData['module_id'] = moduleId;
    if (sync) {
        postData['sync'] = true;
    }

    $.post('{{links.url("modules/getModuleInfo")}}', postData, function(response) {
        if (response.tokenKey && response.token) {
            $('#security-token').attr('name', response.tokenKey);
            $('#security-token').val(response.token);
        }
        //eslint-disable-next-line
        console.log(response);
        $('#{{componentId}}-{{sectionId}}-moduleinfo-loader').attr('hidden', true);
        $('#{{componentId}}-{{sectionId}}-repo-sync').attr('disabled', false);
        $('#{{componentId}}-{{sectionId}}-repo-sync').children("i").removeClass("fa-cog fa-spin").addClass("fa-sync-alt");

        if (response.responseCode == 0) {
            if (response.responseData.module) {

                dataCollectionSectionForm['vars']['module'] = response.responseData.module;

                dataCollectionSectionForm['funcs']['processModuleInfo'](response.responseData.module);
            }
        } else if (response.responseCode == 1) {
            $('#{{componentId}}-{{sectionId}}-moduleinfo-info').attr('hidden', true);
            $('#{{componentId}}-{{sectionId}}-moduleinfo-error').attr('hidden', false);
        } else if (response.responseCode == 2) {
            PNotify.error({text: response.responseMessage});
            if (response.responseData.module) {
                dataCollectionSectionForm['vars']['module'] = response.responseData.module;
                dataCollectionSectionForm['funcs']['processModuleInfo'](response.responseData.module);
            }
        }
    }, 'json');
}

dataCollectionSectionForm['funcs']['processModuleInfo'] = function(moduleInfo) {
    var moduleData = { };

    for (var m in moduleInfo) {
        if (moduleInfo[m] === '' || moduleInfo[m] === null) {
            moduleData[m] = '-';
        } else {
            moduleData[m] = moduleInfo[m];
        }
    }

    if (moduleData['installed'] == 1) {
        moduleData['installed'] = '<span class="badge badge-success">Yes</span>';
        if (moduleData['update_available'] == 1) {
            $('#{{componentId}}-{{sectionId}}-install-update').html('UPDATE');
            $('#{{componentId}}-{{sectionId}}-install-update').attr('hidden', false);
            $('#{{componentId}}-{{sectionId}}-install-update').attr('disabled', false);
        }
    } else {
        moduleData['installed'] = '<span class="badge badge-secondary">No</span>';
        $('#{{componentId}}-{{sectionId}}-install-update').html('INSTALL');
        $('#{{componentId}}-{{sectionId}}-install-update').attr('hidden', false);
        $('#{{componentId}}-{{sectionId}}-install-update').attr('disabled', false);
    }

    if (moduleData['update_available'] !== '-' && moduleData['update_available'] == 1) {
        moduleData['update_available'] = '<span class="badge badge-warning">Yes</span>';
    }
    if (moduleData['update_version'] !== '-') {
        moduleData['update_version'] = '<span class="badge badge-warning">' + moduleData['update_version'] + '</span>';
    }

    moduleData['version'] = '<span class="badge badge-info">' + moduleData['version'] + '</span>';

    $('#app_type').html(moduleData.app_type);
    $('#category').html(moduleData.category);
    $('#sub_category').html(moduleData.sub_category);
    $('#update_available').html(moduleData.update_available);
    $('#update_version').html(moduleData.update_version);
    $('#updated_on').html(moduleData.updated_on);
    $('#installed').html(moduleData.installed);
    $('#version').html(moduleData.version);
    $('#updated_by').html(moduleData.updated_by);
    $('#module_type').html(moduleData.module_type);
    if (moduleData.display_name) {
        $('#display_name').html(moduleData.display_name);
        $('#display_name').html(moduleData.display_name);
    } else {
        $('#display_name').html(moduleData.name);
    }
    $('#module_id').html(moduleData.id);
    $('#description').html(moduleData.description);

    dataCollectionSectionForm['vars']['queue']['uninstall']
    $('#{{componentId}}-{{sectionId}}-moduleinfo-info').attr('hidden', false);
    $('#{{componentId}}-{{sectionId}}-moduleinfo-noinfo').attr('hidden', true);
    $('#{{componentId}}-{{sectionId}}-moduleinfo-error').attr('hidden', true);
    $('#{{componentId}}-{{sectionId}}-repo-sync').attr('disabled', false);
    $('#{{componentId}}-{{sectionId}}-repo-sync').attr('hidden', false);

    if ((dataCollectionSectionForm['vars']['queue']['install_update'][moduleInfo.module_type] &&
        dataCollectionSectionForm['vars']['queue']['install_update'][moduleInfo.module_type].includes(moduleInfo.id)) ||
        moduleInfo.installed == '1'
    ) {
        if (moduleInfo.update_available == '1') {
            if (dataCollectionSectionForm['vars']['queue']['install_update'][moduleInfo.module_type] &&
                dataCollectionSectionForm['vars']['queue']['install_update'][moduleInfo.module_type].includes(moduleInfo.id)
            ) {
                $('#{{componentId}}-{{sectionId}}-install-update').attr('hidden', true);
                $('#{{componentId}}-{{sectionId}}-install-update').attr('disabled', true);
            } else {
                $('#{{componentId}}-{{sectionId}}-install-update').attr('hidden', false);
                $('#{{componentId}}-{{sectionId}}-install-update').attr('disabled', false);
            }
        } else {
            if (dataCollectionSectionForm['vars']['queue']['install_update'][moduleInfo.module_type] &&
                dataCollectionSectionForm['vars']['queue']['install_update'][moduleInfo.module_type].includes(moduleInfo.id)
            ) {
                $('#{{componentId}}-{{sectionId}}-install-update').attr('hidden', true);
                $('#{{componentId}}-{{sectionId}}-install-update').attr('disabled', true);
                $('#{{componentId}}-{{sectionId}}-uninstall').attr('hidden', true);
                $('#{{componentId}}-{{sectionId}}-uninstall').attr('disabled', true);
            } else {
                $('#{{componentId}}-{{sectionId}}-install-update').attr('hidden', true);
                $('#{{componentId}}-{{sectionId}}-install-update').attr('disabled', true);
                $('#{{componentId}}-{{sectionId}}-uninstall').attr('hidden', false);
                $('#{{componentId}}-{{sectionId}}-uninstall').attr('disabled', false);
            }
        }

        if ((dataCollectionSectionForm['vars']['queue']['uninstall'][moduleInfo.module_type] &&
            dataCollectionSectionForm['vars']['queue']['uninstall'][moduleInfo.module_type].includes(moduleInfo.id))
        ) {
            $('#{{componentId}}-{{sectionId}}-uninstall').attr('hidden', true);
            $('#{{componentId}}-{{sectionId}}-uninstall').attr('disabled', true);
            $('#{{componentId}}-{{sectionId}}-cancel').attr('hidden', false);
            $('#{{componentId}}-{{sectionId}}-cancel').attr('disabled', false);
        } else {
            $('#{{componentId}}-{{sectionId}}-uninstall').attr('hidden', false);
            $('#{{componentId}}-{{sectionId}}-uninstall').attr('disabled', false);
        }
    } else {
        $('#{{componentId}}-{{sectionId}}-install-update').attr('hidden', false);
        $('#{{componentId}}-{{sectionId}}-install-update').attr('disabled', false);
        $('#{{componentId}}-{{sectionId}}-uninstall').attr('hidden', true);
        $('#{{componentId}}-{{sectionId}}-uninstall').attr('disabled', true);
    }

    $('#{{componentId}}-{{sectionId}}-cancel').attr('hidden', true);
    $('#{{componentId}}-{{sectionId}}-cancel').attr('disabled', true);
    $('#module-buttons').attr('hidden', false);

    if (moduleData['app_type'] === 'core') {
        if (moduleInfo['name'] === 'Core') {
            $('#{{componentId}}-{{sectionId}}-repo-sync').attr('disabled', false);
            $('#{{componentId}}-{{sectionId}}-repo-sync').attr('hidden', false);
            $('#{{componentId}}-{{sectionId}}-uninstall').attr('hidden', true);
            $('#{{componentId}}-{{sectionId}}-uninstall').attr('disabled', true);
        } else {
            $('#module-buttons').attr('hidden', true);
        }
    }


    dataCollectionSectionForm['funcs']['initModuleButtons']();
}

dataCollectionSectionForm['funcs']['initModuleButtons'] = function() {
    $('#{{componentId}}-{{sectionId}}-install-update').off();
    $('#{{componentId}}-{{sectionId}}-install-update').click(function(e) {
        e.preventDefault();

        $('#{{componentId}}-{{sectionId}}-cancel').attr('hidden', false);
        $('#{{componentId}}-{{sectionId}}-cancel').attr('disabled', false);
        $('#{{componentId}}-{{sectionId}}-install-update').attr('hidden', true);
        $('#{{componentId}}-{{sectionId}}-install-update').attr('disabled', true);
        // $('#{{componentId}}-{{sectionId}}-uninstall').attr('hidden', true);
        // $('#{{componentId}}-{{sectionId}}-uninstall').attr('disabled', true);
        dataCollectionSectionForm['funcs']['updateQueue'](dataCollectionSectionForm['vars']['module']['id'], dataCollectionSectionForm['vars']['module']['module_type']);
        dataCollectionSectionForm['funcs']['applyColorsToIconsAndUpdateText'](dataCollectionSectionForm['vars']['module']['module_type'] + '-' + dataCollectionSectionForm['vars']['module']['id'], true);

        if ($('#{{componentId}}-{{sectionId}}-modules-tree-search-input').val() === 'update') {
            $('#module-buttons').attr('hidden', true);
            $('#{{componentId}}-{{sectionId}}-moduleinfo-info').attr('hidden', true);
            $('#{{componentId}}-{{sectionId}}-moduleinfo-noinfo').attr('hidden', false);
        }
    });

    $('#{{componentId}}-{{sectionId}}-uninstall').off();
    $('#{{componentId}}-{{sectionId}}-uninstall').click(function(e) {
        e.preventDefault();

        $('#{{componentId}}-{{sectionId}}-cancel').attr('hidden', false);
        $('#{{componentId}}-{{sectionId}}-cancel').attr('disabled', false);
        $('#{{componentId}}-{{sectionId}}-install-update').attr('hidden', true);
        $('#{{componentId}}-{{sectionId}}-install-update').attr('disabled', true);
        $('#{{componentId}}-{{sectionId}}-uninstall').attr('hidden', true);
        $('#{{componentId}}-{{sectionId}}-uninstall').attr('disabled', true);
        dataCollectionSectionForm['funcs']['updateQueue'](dataCollectionSectionForm['vars']['module']['id'], dataCollectionSectionForm['vars']['module']['module_type'], true, true);
        dataCollectionSectionForm['funcs']['applyColorsToIconsAndUpdateText'](dataCollectionSectionForm['vars']['module']['module_type'] + '-' + dataCollectionSectionForm['vars']['module']['id'], false, true);

        if ($('#{{componentId}}-{{sectionId}}-modules-tree-search-input').val() === 'update') {
            $('#module-buttons').attr('hidden', true);
            $('#{{componentId}}-{{sectionId}}-moduleinfo-info').attr('hidden', true);
            $('#{{componentId}}-{{sectionId}}-moduleinfo-noinfo').attr('hidden', false);
        }
    });

    $('#{{componentId}}-{{sectionId}}-cancel').off();
    $('#{{componentId}}-{{sectionId}}-cancel').click(function(e) {
        e.preventDefault();

        if (dataCollectionSectionForm['vars']['module']['installed'] == '1') {
            $('#{{componentId}}-{{sectionId}}-uninstall').attr('hidden', false);
            $('#{{componentId}}-{{sectionId}}-uninstall').attr('disabled', false);
            if (dataCollectionSectionForm['vars']['module']['update_available'] == '1') {
                $('#{{componentId}}-{{sectionId}}-install-update').attr('hidden', false);
                $('#{{componentId}}-{{sectionId}}-install-update').attr('disabled', false);
            }
        } else {
            $('#{{componentId}}-{{sectionId}}-install-update').attr('hidden', false);
            $('#{{componentId}}-{{sectionId}}-install-update').attr('disabled', false);
        }
        $('#{{componentId}}-{{sectionId}}-cancel').attr('hidden', true);
        $('#{{componentId}}-{{sectionId}}-cancel').attr('disabled', true);
        dataCollectionSectionForm['funcs']['updateQueue'](dataCollectionSectionForm['vars']['module']['id'], dataCollectionSectionForm['vars']['module']['module_type'], false, false);
        dataCollectionSectionForm['funcs']['applyColorsToIconsAndUpdateText'](dataCollectionSectionForm['vars']['module']['module_type'] + '-' + dataCollectionSectionForm['vars']['module']['id'], false, false);
    });

    $('#{{componentId}}-{{sectionId}}-repo-sync').off();
    $('#{{componentId}}-{{sectionId}}-repo-sync').click(function(e) {
        e.preventDefault();

        $(this).attr('disabled', true);
        $(this).children("i").removeClass("fa-sync-alt").addClass("fa-cog fa-spin");

        $('#{{componentId}}-{{sectionId}}-install-update').attr('hidden', true);
        $('#{{componentId}}-{{sectionId}}-install-update').attr('disabled', true);
        $('#{{componentId}}-{{sectionId}}-uninstall').attr('hidden', true);
        $('#{{componentId}}-{{sectionId}}-uninstall').attr('disabled', true);
        $('#{{componentId}}-{{sectionId}}-cancel').attr('hidden', true);
        $('#{{componentId}}-{{sectionId}}-cancel').attr('disabled', true);

        $('#{{componentId}}-{{sectionId}}-moduleinfo-loader').attr('hidden', false);
        $('#{{componentId}}-{{sectionId}}-moduleinfo-info').attr('hidden', true);
        $('#{{componentId}}-{{sectionId}}-moduleinfo-error').attr('hidden', true);
        dataCollectionSectionForm['funcs']['getModuleInfo'](dataCollectionSectionForm['vars']['module']['module_type'], dataCollectionSectionForm['vars']['module']['id'], true);
    });
}

dataCollectionSectionForm['funcs']['updateQueue'] = function(id, type, install = true, uninstall = false) {
    var index;
    var swap = false;

    if (uninstall === true) {
        if (!dataCollectionSectionForm['vars']['queue']['uninstall'][type]) {
            dataCollectionSectionForm['vars']['queue']['uninstall'][type] = [];
        }

        if (dataCollectionSectionForm['vars']['queue']['install_update'][type] &&
            dataCollectionSectionForm['vars']['queue']['install_update'][type].includes(id)
        ) {
            index = dataCollectionSectionForm['vars']['queue']['install_update'][type].indexOf(id);

            if (index > -1) {
                dataCollectionSectionForm['vars']['queue']['install_update'][type].splice(index, 1);
            }

            swap = true;
        }

        dataCollectionSectionForm['vars']['queue']['uninstall'][type].push(id);
    } else if (install === true) {
        if (!dataCollectionSectionForm['vars']['queue']['install_update'][type]) {
            dataCollectionSectionForm['vars']['queue']['install_update'][type] = [];
        }

        if (dataCollectionSectionForm['vars']['queue']['uninstall'][type] &&
            dataCollectionSectionForm['vars']['queue']['uninstall'][type].includes(id)
        ) {
            index = dataCollectionSectionForm['vars']['queue']['uninstall'][type].indexOf(id);

            if (index > -1) {
                dataCollectionSectionForm['vars']['queue']['uninstall'][type].splice(index, 1);
            }

            swap = true;
        }

        dataCollectionSectionForm['vars']['queue']['install_update'][type].push(id);
    } else if (install === false && uninstall === false) {//Cancel button
        if (dataCollectionSectionForm['vars']['queue']['install_update'][type] &&
            dataCollectionSectionForm['vars']['queue']['install_update'][type].includes(id)
        ) {
            index = dataCollectionSectionForm['vars']['queue']['install_update'][type].indexOf(id);

            if (index > -1) {
                dataCollectionSectionForm['vars']['queue']['install_update'][type].splice(index, 1);
            }
        } else if (dataCollectionSectionForm['vars']['queue']['uninstall'][type] &&
                   dataCollectionSectionForm['vars']['queue']['uninstall'][type].includes(id)
        ) {
            index = dataCollectionSectionForm['vars']['queue']['uninstall'][type].indexOf(id);

            if (index > -1) {
                dataCollectionSectionForm['vars']['queue']['uninstall'][type].splice(index, 1);
            }
        }
    }

    if ((install === true || uninstall === true) && swap === false) {
        dataCollectionSectionForm['vars']['queue']['count'] = dataCollectionSectionForm['vars']['queue']['count'] + 1;
    } else if (install === false && uninstall === false) {
        dataCollectionSectionForm['vars']['queue']['count'] = dataCollectionSectionForm['vars']['queue']['count'] - 1;
    }

    $('#queue-counter').empty().html(dataCollectionSectionForm['vars']['queue']['count']);

    if (dataCollectionSectionForm['vars']['queue']['count'] > 0) {
        $('#{{componentId}}-{{sectionId}}-process-queue').attr('disabled', false);
        $('#{{componentId}}-{{sectionId}}-clear-queue').attr('disabled', false);

        $('#{{componentId}}-{{sectionId}}-process-queue').off();
        $('#{{componentId}}-{{sectionId}}-process-queue').click(function(e) {
            e.preventDefault();

            dataCollectionSectionForm['funcs']['processQueue']();
        });
        $('#{{componentId}}-{{sectionId}}-clear-queue').off();
        $('#{{componentId}}-{{sectionId}}-clear-queue').click(function(e) {
            e.preventDefault();

            $('#{{componentId}}-{{sectionId}}-modules').jstree().deselect_all();
            $('#module-buttons').attr('hidden', true);
            $('#{{componentId}}-{{sectionId}}-moduleinfo-info').attr('hidden', true);
            $('#{{componentId}}-{{sectionId}}-moduleinfo-noinfo').attr('hidden', false);
            dataCollectionSectionForm['funcs']['clearQueue']();
        });
    } else {
        $('#{{componentId}}-{{sectionId}}-process-queue').attr('disabled', true);
        $('#{{componentId}}-{{sectionId}}-clear-queue').attr('disabled', true);

        $('#{{componentId}}-{{sectionId}}-process-queue').off();
        $('#{{componentId}}-{{sectionId}}-clear-queue').off();
    }
}

dataCollectionSectionForm['funcs']['processQueue'] = function() {
    //
}

dataCollectionSectionForm['funcs']['clearQueue'] = function() {
    dataCollectionSectionForm['vars']['queue'] = { };
    dataCollectionSectionForm['vars']['queue']['count'] = 0;
    dataCollectionSectionForm['vars']['queue']['install_update'] = { };
    dataCollectionSectionForm['vars']['queue']['uninstall'] = { };
    $('#{{componentId}}-{{sectionId}}-process-queue').attr('disabled', true);
    $('#{{componentId}}-{{sectionId}}-clear-queue').attr('disabled', true);
    $('#{{componentId}}-{{sectionId}}-process-queue').off();
    $('#{{componentId}}-{{sectionId}}-clear-queue').off();
    $('#{{componentId}}-{{sectionId}}-cancel').attr('disabled', true);
    $('#{{componentId}}-{{sectionId}}-cancel').attr('hidden', true);

    if (dataCollectionSectionForm['vars']['module']['installed'] == 1) {
        if (dataCollectionSectionForm['vars']['module']['update_available'] == 1) {
            $('#{{componentId}}-{{sectionId}}-install-update').html('UPDATE');
            $('#{{componentId}}-{{sectionId}}-install-update').attr('hidden', false);
            $('#{{componentId}}-{{sectionId}}-install-update').attr('disabled', false);
        }
        $('#{{componentId}}-{{sectionId}}-uninstall').attr('hidden', false);
        $('#{{componentId}}-{{sectionId}}-uninstall').attr('disabled', false);
    } else {
        $('#{{componentId}}-{{sectionId}}-install-update').html('INSTALL');
        $('#{{componentId}}-{{sectionId}}-install-update').attr('hidden', false);
        $('#{{componentId}}-{{sectionId}}-install-update').attr('disabled', false);
        $('#{{componentId}}-{{sectionId}}-uninstall').attr('hidden', true);
        $('#{{componentId}}-{{sectionId}}-uninstall').attr('disabled', true);
    }

    $('#queue-counter').empty().html(dataCollectionSectionForm['vars']['queue']['count']);
    dataCollectionSectionForm['funcs']['applyColorsToIconsAndUpdateText']();
}

dataCollectionSectionForm['funcs']['applyColorsToIconsAndUpdateText'] =
    function(nodeId = null, installUpdate = false, uninstall = false, init = false) {
        var allNodes;

        if (nodeId) {
            allNodes = $('#{{componentId}}-{{sectionId}}-modules').jstree().get_node(nodeId);
        } else {
            allNodes = $('#{{componentId}}-{{sectionId}}-modules').jstree().get_json('#', {'flat':true});
        }

        var updateAvailable = false;
        var nT, nD;

        $(allNodes).each(function(i, node) {
            if (node.id.startsWith('j')) {
                return true;
            }
            nD = node.data;

            nT =
                dataCollectionSectionForm['vars']['modules'][nD.apptype]['childs'][nD.moduletype]['childs'][nD.modulecategory]['childs'][nD.modulesubcategory]['childs'][node.id]['name'];

            if (uninstall === true) {
                $('#{{componentId}}-{{sectionId}}-modules').jstree().set_icon(node, 'fas fa-fw fa-circle-minus text-danger');
                $('#{{componentId}}-{{sectionId}}-modules').jstree().set_text(node, nT + ' (In Queue:Uninstall)');
                if (nD.update_available && nD.update_available == 1) {
                    updateAvailable = true;
                }
            } else if (installUpdate === true) {
                $('#{{componentId}}-{{sectionId}}-modules').jstree().set_text(node, nT + ' (In Queue:Install)');
                if (nD.update_available && nD.update_available == 1) {
                    $('#{{componentId}}-{{sectionId}}-modules').jstree().set_icon(node, 'fas fa-fw fa-circle-plus text-info');
                    updateAvailable = true;
                } else {
                    $('#{{componentId}}-{{sectionId}}-modules').jstree().set_icon(node, 'fas fa-fw fa-square-plus text-info');
                }
            } else if (nodeId && uninstall === false && installUpdate === false && init === false) {
                $('#{{componentId}}-{{sectionId}}-modules').jstree().set_icon(node, 'fa fa-fw fa-circle-dot');
                $('#{{componentId}}-{{sectionId}}-modules').jstree().set_text(node, nT);
            } else {
                if (nD.installed == 1) {
                    $('#{{componentId}}-{{sectionId}}-modules').jstree().set_icon(node, 'fas fa-fw fa-circle-check text-success');
                    $('#{{componentId}}-{{sectionId}}-modules').jstree().set_text(node, nT);
                } else {
                    $('#{{componentId}}-{{sectionId}}-modules').jstree().set_icon(node, 'fa fa-fw fa-circle-dot');
                    if (nD.isnew && nD.isnew == 1) {
                        $('#{{componentId}}-{{sectionId}}-modules')
                        .jstree()
                        .set_text(
                            node,
                            nT +
                                ' <span class="text-uppercase" style="top: -2px;position: relative;"><span class="badge badge-info">NEW</span></span>'
                        );
                    } else {
                        $('#{{componentId}}-{{sectionId}}-modules').jstree().set_text(node, nT);
                    }
                }

                if (nD.update_available && nD.update_available == 1) {
                    updateAvailable = true;
                    $('#{{componentId}}-{{sectionId}}-modules').jstree().set_icon(node, 'fas fa-fw fa-circle-up text-warning');
                    $('#{{componentId}}-{{sectionId}}-modules').jstree().set_text(node, nT + ' (Update)');
                }
            }
        });

        if (updateAvailable && (dataCollectionSectionForm['vars']['filter'] === true || init === true)) {
            if (init === true) {
                dataCollectionSectionForm['vars']['initJstree'] = true;
            }
            dataCollectionSectionForm['vars']['filter'] = true;
            $('#{{componentId}}-{{sectionId}}-modules-tree-search-input').val('update');
            $('#{{componentId}}-{{sectionId}}-modules').jstree().search('update');
        }
    }

dataCollectionSectionForm['funcs']['changeRepoButtons'] = function(val = '0') {
    var url = "{{links.url('system/api/q/repository/true/id/')}}" + val;

    if (val == '1' || val == '2') {
        $('#{{componentId}}-{{sectionId}}-sync').attr('disabled', false);
        $('#{{componentId}}-{{sectionId}}-delete').attr('disabled', true);
        $('#{{componentId}}-{{sectionId}}-edit').removeClass('disabled');
        $('#{{componentId}}-{{sectionId}}-edit').attr('href', url);
    } else if (val == '0') {
        $('#{{componentId}}-{{sectionId}}-sync, #{{componentId}}-{{sectionId}}-delete').attr('disabled', true);
        $('#{{componentId}}-{{sectionId}}-edit').addClass('disabled');
    } else {
        $('#{{componentId}}-{{sectionId}}-sync, #{{componentId}}-{{sectionId}}-delete').attr('disabled', false);
        $('#{{componentId}}-{{sectionId}}-edit').removeClass('disabled');
        $('#{{componentId}}-{{sectionId}}-edit').attr('href', url);
    }
}

dataCollectionSectionForm['funcs']['deleteRepo'] = function(repoName, repoId) {
    Swal.fire({
        title                       : '<i class="fa text-danger fa-lg fa-question-circle m-2">' +
                                      '</i> <span style="font-size:40px;" class="text-danger"> Delete Repo ' +
                                      repoName + '?</span>',
        icon                        : 'question',
        background                  : 'rgba(0,0,0,.8)',
        backdrop                    : 'rgba(0,0,0,.6)',
        buttonsStyling              : false,
        confirmButtonText           : 'Delete',
        customClass                 : {
            'confirmButton'             : 'btn btn-danger text-uppercase',
            'cancelButton'              : 'ml-2 btn btn-secondary text-uppercase',
        },
        showCancelButton            : true,
        keydownListenerCapture      : true,
        allowOutsideClick           : false,
        allowEscapeKey              : false,
        didOpen                     : function() {
            window.dataCollection.env.sounds.swalSound.play();
        }
    }).then((result) => {
        if (result.isConfirmed) {
            var postData = { };
            postData[$('#security-token').attr('name')] = $('#security-token').val();
            postData['id'] = repoId;

            $.post('{{links.url("system/api/remove")}}', postData,
                    function(response) {
                        if (response.responseCode == 0) {
                            $('#{{componentId}}-{{sectionId}}-repositories').find('[data-value="' + repoId + '"]').remove();
                        } else {
                            PNotify.error({
                                text        : response.responseMessage,
                                textTrusted : true
                            });
                        }
                        if (response.tokenKey && response.token) {
                            $('#security-token').attr('name', response.tokenKey);
                            $('#security-token').val(response.token);
                        }
                    },
                    'json'
                );
        }
    });
}
$('#{{componentId}}-{{sectionId}}-delete').click(function() {
    var repoName = $('#{{componentId}}-{{sectionId}}-repositories option:selected').html();
    var repoId = $('#{{componentId}}-{{sectionId}}-repositories option:selected').val();

    dataCollectionSectionForm['funcs']['deleteRepo'](repoName, repoId);
});

dataCollectionSectionForm['funcs']['initSync'] = function(val) {
    $('#{{componentId}}-{{sectionId}}-sync').off();

    dataCollectionSectionForm['funcs']['changeRepoButtons'](val);

    $('#{{componentId}}-{{sectionId}}-sync').click(function() {
        $('#{{componentId}}-{{sectionId}}-sync, ' +
          '#{{componentId}}-{{sectionId}}-delete, ' +
          '#{{componentId}}-{{sectionId}}-add').attr('disabled', true);
        $('#{{componentId}}-{{sectionId}}-edit').addClass('disabled');

        $('#{{componentId}}-{{sectionId}}-sync').children("i").removeClass("fa-sync-alt").addClass("fa-cog fa-spin");

        var postData = { };
        postData[$('#security-token').attr('name')] = $('#security-token').val();
        postData['repoId'] = $('#{{componentId}}-{{sectionId}}-repositories option:selected').val();

        $.post('{{links.url("modules/sync")}}', postData, function(response) {
            if (response.tokenKey && response.token) {
                $('#security-token').attr('name', response.tokenKey);
                $('#security-token').val(response.token);
            }

            if (response.responseCode == 0) {
                if (response.responseData && response.responseData.register !== 'undefined' && response.responseData.update !== 'undefined') {
                    var text, registerCounter, updateCounter;

                    registerCounter = response.responseData.counter.register;
                    updateCounter = response.responseData.counter.update;

                    if (registerCounter > 0 || updateCounter > 0) {
                        if (registerCounter !== 0 && updateCounter === 0) {
                            text =
                                'Sync Complete.<br>' + registerCounter + ' new modules available.<br> No updates available.';
                        } else if (registerCounter === 0 && updateCounter !== 0) {
                            text =
                                'Sync Complete.<br>' + updateCounter + ' new updates available.<br> No new modules available.';
                        } else if (registerCounter !== 0 && updateCounter !== 0) {
                            text =
                                'Sync Complete.<br>' + updateCounter + ' new updates available.<br>' + registerCounter + ' new modules available.';
                        }

                        if (updateCounter > 0) {
                            dataCollectionSectionForm['vars']['filter'] = true;
                            $('#{{componentId}}-{{sectionId}}-modules-tree-search-input').val('update');
                            $('#{{componentId}}-{{sectionId}}-modules').jstree().search('update');
                        }
                    } else {
                        text = 'Sync Complete.<br>No new modules or updates available.';
                    }

                    PNotify.info({
                        text        : text,
                        textTrusted : true
                    });
                }
            } else {
                PNotify.error({
                    text        : response.responseMessage,
                    textTrusted : true
                });
                $('#modules-data').attr('hidden', false);
                $('#modules-loader').attr('hidden', true);
                $('#repository-sync').attr('hidden', true);
                $('#{{componentId}}-{{sectionId}}-sync, #{{componentId}}-{{sectionId}}-edit, #{{componentId}}-{{sectionId}}-delete, #{{componentId}}-{{sectionId}}-add').attr('disabled', false);
            }

            $('#{{componentId}}-{{sectionId}}-sync').children("i").removeClass("fa-cog fa-spin").addClass("fa-sync-alt");
            $('#{{componentId}}-{{sectionId}}-sync, ' +
              '#{{componentId}}-{{sectionId}}-add').attr('disabled', false);
            $('#{{componentId}}-{{sectionId}}-edit').removeClass('disabled');

            if (postData['repoId'] != '1' && postData['repoId'] != '2') {
                $('#{{componentId}}-{{sectionId}}-delete').attr('disabled', false);
            }
        }, 'json');
    });
}
$('#{{componentId}}-{{sectionId}}-repositories').change(function() {
    dataCollectionSectionForm['funcs']['initSync']($(this).val());
});

$(document).ready(function() {
    BazProgress.buildProgressBar($('#installer-progress'));
});
</script>
{% include 'modules/modal.html' %}