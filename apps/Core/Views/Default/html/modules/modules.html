{% set fieldJstreeEmptyText = false %}
{% if modulesError is defined %}
    {% set fieldJstreeEmptyText = modulesError %}
{% endif %}
<div class="row vdivide">
    <div class="col-md-4 vdivide-resizable">
        {{adminltetags.useTag('fields',
            [
                'component'                                 : component,
                'componentName'                             : componentName,
                'componentId'                               : componentId,
                'sectionId'                                 : sectionId,
                'fieldId'                                   : 'modules',
                'fieldLabel'                                : 'Modules',
                'fieldType'                                 : 'jstree',
                'fieldHelp'                                 : true,
                'fieldHelpTooltipContent'                   : 'Available modules on repository.',
                'fieldRequired'                             : false,
                'fieldBazScan'                              : true,
                'fieldJstreeSearch'                         : true,
                'fieldBazPostOnCreate'                      : false,
                'fieldBazPostOnUpdate'                      : false,
                'fieldJstreeDataSrcArr'                     : ["modules":["srcArr" : modules]],
                'fieldJstreeAdd'                            : false,
                'fieldJstreeEdit'                           : false,
                'fieldJstreeExpand'                         : true,
                'fieldJstreeCollapse'                       : true,
                'fieldJstreeFirstOpen'                      : true,
                'fieldJstreeAllOpen'                        : true,
                'fieldJstreeAllChecked'                     : false,
                'fieldJstreeRootIcon'                       : 'th',
                'fieldJstreeToggleAllChildren'              : true,
                'fieldJstreeIncludeRootInPath'              : false,
                'fieldJstreeSelectEndNodeOnly'              : false,
                'fieldJstreeShowDots'                       : true,
                'fieldJstreeDoubleClickToggle'              : true,
                'fieldJstreeMultiple'                       : false,
                'fieldJstreeSearchCaseSensitive'            : false,
                'fieldJstreeSearchShowOnlyMatches'          : true,
                'fieldJstreeSearchShowOnlyMatchesChildren'  : true,
                'fieldJstreeEmptyText'                      : fieldJstreeEmptyText,
                'fieldJstreeHideJstreeIcons'                : false,
                'fieldJstreeAdditionalTools'                :
                    [
                        'repo-add' :
                            [
                                'id'        : 'repo-add',
                                'tooltip'   : 'Repo Add',
                                'icon'      : 'circle-plus',
                                'iconColor' : 'success',
                                'disabled'  : true,
                                'url'       : links.url('system/api/client/services')
                            ],
                        'repo-update' :
                            [
                                'id'        : 'repo-update',
                                'tooltip'   : 'Repo Update',
                                'icon'      : 'edit',
                                'iconColor' : 'warning',
                                'disabled'  : true,
                                'url'       : links.url('system/api/client/services/q/id/')
                            ],
                        'repo-sync' :
                            [
                                'id'        : 'repo-sync',
                                'tooltip'   : 'Repo Sync',
                                'icon'      : 'sync-alt',
                                'iconColor' : 'secondary',
                                'disabled'  : true
                            ],
                        '0'       :
                            [
                                'id'        : 'divider'
                            ],
                        'filter-update-available' :
                            [
                                'id'        : 'filter-update-available',
                                'tooltip'   : 'Apply Filter (update)',
                                'icon'      : 'circle-up',
                                'iconColor' : 'secondary',
                                'disabled'  : true
                            ],
                        'filter-new-available' :
                            [
                                'id'        : 'filter-new-available',
                                'tooltip'   : 'Apply Filter (new)',
                                'icon'      : 'star',
                                'iconColor' : 'secondary',
                                'disabled'  : true
                            ],
                        '1'       :
                            [
                                'id'        : 'divider'
                            ],
                        'filter-update' :
                            [
                                'id'        : 'filter-update',
                                'tooltip'   : 'Apply Filter (:update)',
                                'icon'      : 'circle-up',
                                'iconColor' : 'secondary',
                                'disabled'  : true
                            ],
                        'filter-install' :
                            [
                                'id'        : 'filter-install',
                                'tooltip'   : 'Apply Filter Install/Update (:install)',
                                'icon'      : 'circle-plus',
                                'iconColor' : 'secondary',
                                'disabled'  : true
                            ],
                        'filter-uninstall' :
                            [
                                'id'        : 'filter-uninstall',
                                'tooltip'   : 'Apply Filter Uninstall (:uninstall)',
                                'icon'      : 'circle-minus',
                                'iconColor' : 'secondary',
                                'disabled'  : true
                            ],
                        'filter-remove' :
                            [
                                'id'        : 'filter-remove',
                                'tooltip'   : 'Apply Filter Remove (:remove)',
                                'icon'      : 'circle-xmark',
                                'iconColor' : 'secondary',
                                'disabled'  : true
                            ],
                        '2'       :
                            [
                                'id'        : 'divider'
                            ],
                        'filter-queue' :
                            [
                                'id'        : 'filter-queue',
                                'tooltip'   : 'Apply Filter In Queue (queue:)',
                                'icon'      : 'list',
                                'iconColor' : 'secondary',
                                'disabled'  : true
                            ],
                        'filter-clear' :
                            [
                                'id'        : 'filter-clear',
                                'tooltip'   : 'Clear all filters',
                                'icon'      : 'times',
                                'iconColor' : 'primary'
                            ]
                    ],
                'fieldJstreeReplaceIdWithDataField'         : 'moduleid',
                'fieldJstreePlugins'                        : ["search", "types"],
                'fieldJstreeAdditionalClass'                : 'text-uppercase'
            ]
        )}}
    </div>
    <div class="col">
        <div class="row text-center m-2" id="{{componentId}}-{{sectionId}}-moduleinfo-error" hidden>
            <div class="col">
                <h6><i class="fa fa-fw fa-info-circle text-danger"></i> Error loading module information. Please contact administrator.</h6>
            </div>
        </div>
        <div class="row text-center m-2" id="{{componentId}}-{{sectionId}}-moduleinfo-noinfo">
            <div class="col">
                <h6><i class="fa fa-fw fa-info-circle text-info"></i> Select module from the tree to see it's details.</h6>
            </div>
        </div>
        <div class="row text-center" id="{{componentId}}-{{sectionId}}-moduleinfo-loader" hidden>
            <div class="col">
                <i class="fa fa-cog fa-spin"></i> Loading module information...
            </div>
        </div>
        <div class="row" id="{{componentId}}-{{sectionId}}-moduleinfo-info" hidden>
            <div class="col">
                {{adminltetags.useTag('tabs',
                    [
                        'component'                     : component,
                        'componentName'                 : componentName,
                        'componentId'                   : componentId,
                        'sectionId'                     : sectionId,
                        'tabsId'                        : 'tabs',
                        'tabsStyle'                     : 'card-outline-tabs',
                        'tabsData'                      :
                            [
                                'info'   :
                                [
                                    'tabTitle'          : 'Info',
                                    'tabInclude'        : 'modules/modules/info'
                                ],
                                'description'   :
                                [
                                    'tabTitle'          : 'Description',
                                    'tabInclude'        : 'modules/modules/description'
                                ],
                                'changelogs'   :
                                [
                                    'tabTitle'          : 'Change logs',
                                    'tabInclude'        : 'modules/modules/changelogs'
                                ],
                                'settings'   :
                                [
                                    'tabTitle'          : 'Settings',
                                    'tabInclude'        : 'modules/modules/settings'
                                ],
                                'bundlemodules'   :
                                [
                                    'tabTitle'          : 'Bundle Modules',
                                    'tabInclude'        : 'modules/modules/bundlemodules'
                                ]
                            ]
                    ]
                )}}
            </div>
        </div>
    </div>
</div>
<hr>
<div class="row">
    <div class="col">
        {{adminltetags.useTag('fields',
            [
                'component'                      : component,
                'componentName'                  : componentName,
                'componentId'                    : componentId,
                'sectionId'                      : sectionId,
                'fieldId'                        : 'queue_id',
                'fieldLabel'                     : 'Queue ID',
                'fieldType'                      : 'input',
                'fieldHelp'                      : true,
                'fieldHelpTooltipContent'        : 'Queue ID',
                'fieldRequired'                  : true,
                'fieldBazScan'                   : true,
                'fieldBazPostOnCreate'           : false,
                'fieldBazPostOnUpdate'           : false,
                'fieldHidden'                    : true,
                'fieldDisabled'                  : true,
                'fieldValue'                     : queue['id']
            ]
        )}}
    </div>
</div>
<div class="row">
    <div class="col">
        <span class="text-uppercase">Queue:
            <span style="top: -2px;position: relative;" class="badge badge-info" id="queue-counter">{{queue['total']}}</span>
        </span>
    </div>
    {% set analyseDisabled = true %}
    {% set clearDisabled = true %}
    {% if queue['total'] > 0 %}
        {% set analyseDisabled = false %}
        {% set clearDisabled = false %}
    {% endif %}
    <div class="col">
        {{adminltetags.useTag('buttons',
            [
                'component'                     : component,
                'componentName'                 : componentName,
                'componentId'                   : componentId,
                'sectionId'                     : sectionId,
                'buttonType'                    : 'button',
                'buttons'                       :
                    [
                        'analyse-queue'     : [
                            'title'             : 'Analyse Queue',
                            'position'          : 'right',
                            'size'              : 'xs',
                            'url'               : links.url('modules/q/queue/true'),
                            'disabled'          : analyseDisabled
                        ],
                        'clear-queue'       : [
                            'title'             : 'Clear Queue',
                            'position'          : 'right',
                            'type'              : 'danger',
                            'size'              : 'xs',
                            'disabled'          : clearDisabled
                        ]
                    ]
            ]
        )}}
    </div>
</div>
{% set queue = json_encode(queue, 16) %}
{% set modules = json_encode(modules, 16) %}
<script>
/*global BazProgress Swal BazContentFields BazHelpers BazContentLoader Pace BazCore paginatedPNotify */
var dataCollectionComponent, dataCollectionSection, dataCollectionSectionForm;

if (!window['dataCollection']['{{componentId}}']) {
    dataCollectionComponent =
        window['dataCollection']['{{componentId}}'] = { };
} else {
    dataCollectionComponent =
        window['dataCollection']['{{componentId}}'];
}
if (!dataCollectionComponent['{{componentId}}-{{sectionId}}']) {
    dataCollectionSection =
        dataCollectionComponent['{{componentId}}-{{sectionId}}'] = { };
} else {
    dataCollectionSection =
        dataCollectionComponent['{{componentId}}-{{sectionId}}'];
}
if (!dataCollectionSection['{{componentId}}-{{sectionId}}-form']) {
    dataCollectionSectionForm =
        dataCollectionSection['{{componentId}}-{{sectionId}}-form'] = { };
} else {
    dataCollectionSectionForm =
        dataCollectionSection['{{componentId}}-{{sectionId}}-form'];
}

dataCollectionSection =
    $.extend(dataCollectionSection, {
        '{{componentId}}-{{sectionId}}-level_of_update'             : {
            placeholder: 'SELECT LEVEL OF UPDATE'
        },
        '{{componentId}}-{{sectionId}}-auto_update'                 : {
            afterInit: function() {
                $('#{{componentId}}-{{sectionId}}-save-settings').off();
                $('#{{componentId}}-{{sectionId}}-save-settings').click(function() {
                    $('#{{componentId}}-{{sectionId}}-save-settings').attr('disabled', true);
                    $('#{{componentId}}-{{sectionId}}-save-settings').children("i").removeClass("fa-save").addClass("fa-cog fa-spin");

                    var postData = { };
                    postData[$('#security-token').attr('name')] = $('#security-token').val();
                    postData['module_id'] = dataCollectionSectionForm['vars']['module']['id'];
                    postData['module_type'] = dataCollectionSectionForm['vars']['module']['module_type'];
                    postData['level_of_update'] = $('#{{componentId}}-{{sectionId}}-level_of_update').val();
                    postData['auto_update'] = '0';
                    if ($('#{{componentId}}-{{sectionId}}-auto_update')[0].checked === true) {
                        postData['auto_update'] = '1';
                    }

                    $.post('{{links.url("modules/saveModuleSettings")}}', postData, function(response) {
                        if (response.tokenKey && response.token) {
                            $('#security-token').attr('name', response.tokenKey);
                            $('#security-token').val(response.token);
                        }

                        if (response.responseCode == 0) {
                            paginatedPNotify('success', {text: response.responseMessage});
                        } else if (response.responseCode == 1) {
                            paginatedPNotify('error', {text: response.responseMessage});
                        }

                        $('#{{componentId}}-{{sectionId}}-save-settings').attr('disabled', false);
                        $('#{{componentId}}-{{sectionId}}-save-settings').children("i").removeClass("fa-cog fa-spin").addClass("fa-save");
                    }, 'json');
                });
            }
        },
        '{{componentId}}-{{sectionId}}-queue_id'                    : { },
        '{{componentId}}-{{sectionId}}-form'                        : {
            rules: { },
            messages: { }
        }
    });

dataCollectionSectionForm['vars'] = { };
dataCollectionSectionForm['vars']['sync'] = false;
dataCollectionSectionForm['vars']['rootTree'] = [];
dataCollectionSectionForm['vars']['org_update_available'] = 0;
dataCollectionSectionForm['vars']['update_available'] = 0;
dataCollectionSectionForm['vars']['new_available'] = 0;
dataCollectionSectionForm['vars']['modules'] = JSON.parse('{{modules}}');
dataCollectionSectionForm['vars']['module'] = { };
dataCollectionSectionForm['vars']['queue'] = JSON.parse('{{queue}}');
// dataCollectionSectionForm['vars']['queue_data'] = { };
// dataCollectionSectionForm['vars']['queue_data']['install'] = { };
// dataCollectionSectionForm['vars']['queue_data']['uninstall'] = { };
// dataCollectionSectionForm['vars']['queue_data']['update'] = { };
// dataCollectionSectionForm['vars']['queue_data']['remove'] = { };
dataCollectionSectionForm['vars']['initJstree'] = false;
dataCollectionSectionForm['vars']['syncInfo'] = '';

dataCollectionSectionForm['funcs'] = { };

dataCollectionSectionForm['funcs']['jstreeReady'] = function() {
    $('#{{componentId}}-{{sectionId}}-modules').off('ready.jstree');
    $('#{{componentId}}-{{sectionId}}-modules').on('ready.jstree', function(e) {
        dataCollectionSectionForm['vars']['rootTree'] = $('#{{componentId}}-{{sectionId}}-modules').jstree().get_json('#', {flat:true});

        var selected;

        $(dataCollectionSectionForm['vars']['rootTree']).each(function(i, v) {
            v.text = v.text.toLowerCase();
            if (v.data.apiid == '1' && v.data.type === 'repo' && v.text.includes('core')) {
                selected = v.id;

                $('#{{componentId}}-{{sectionId}}-modules').jstree().select_node(v.id);

                return false;
            }
        });

        dataCollectionSectionForm['funcs']['applyColorsToTreeIconsAndUpdateText'](null, false, false, false, true);
    });

    $('#{{componentId}}-{{sectionId}}-modules').on('search.jstree', function(e, res) {
        if (dataCollectionSectionForm['vars']['syncInfo'] === '') {
            $(res.nodes).each(function(i, node) {
                var updateNode = $('#{{componentId}}-{{sectionId}}-modules').jstree().get_node(node);
                var apiNode = updateNode.parents[updateNode.parents.length - 2];
                var apiNodeObj = $('#{{componentId}}-{{sectionId}}-modules').jstree().get_node(apiNode);
                var update = 'update';
                if (res.nodes.length > 1) {
                    update = 'updates';
                }
                dataCollectionSectionForm['vars']['syncInfo'] += apiNodeObj.text + ' has ' + res.nodes.length + ' new ' + update + ' available.<br>';
            });
        }

        if (dataCollectionSectionForm['vars']['initJstree'] === true) {
            dataCollectionSectionForm['vars']['org_update_available'] = res.nodes.length;
            dataCollectionSectionForm['vars']['update_available'] = res.nodes.length;
            dataCollectionSectionForm['vars']['initJstree'] = false;
            paginatedPNotify('info', {
                text        : dataCollectionSectionForm['vars']['syncInfo'],
                textTrusted : true
            });
        }

        dataCollectionSectionForm['vars']['syncInfo'] = '';

        if (dataCollectionSectionForm['vars']['update_available'] > 0) {
            dataCollectionSectionForm['funcs']['toggleJstreeTool']('{{componentId}}-{{sectionId}}-modules-filter-update-available', 'info', false);
        }
    });

    dataCollectionSectionForm['funcs']['initJstreeButtons']();
}
dataCollectionSectionForm['funcs']['initJstreeButtons'] = function() {
    $('#{{componentId}}-{{sectionId}}-modules-repo-sync, ' +
      '#{{componentId}}-{{sectionId}}-modules-filter-update-available, ' +
      '#{{componentId}}-{{sectionId}}-modules-filter-new-available, ' +
      '#{{componentId}}-{{sectionId}}-modules-filter-update, ' +
      '#{{componentId}}-{{sectionId}}-modules-filter-install, ' +
      '#{{componentId}}-{{sectionId}}-modules-filter-uninstall, ' +
      '#{{componentId}}-{{sectionId}}-modules-filter-uninstall, ' +
      '#{{componentId}}-{{sectionId}}-modules-filter-queue, ' +
      '#{{componentId}}-{{sectionId}}-modules-filter-clear').off();

    $('#{{componentId}}-{{sectionId}}-modules-repo-sync, ' +
      '#{{componentId}}-{{sectionId}}-modules-filter-update-available, ' +
      '#{{componentId}}-{{sectionId}}-modules-filter-new-available, ' +
      '#{{componentId}}-{{sectionId}}-modules-filter-update, ' +
      '#{{componentId}}-{{sectionId}}-modules-filter-install, ' +
      '#{{componentId}}-{{sectionId}}-modules-filter-uninstall, ' +
      '#{{componentId}}-{{sectionId}}-modules-filter-remove, ' +
      '#{{componentId}}-{{sectionId}}-modules-filter-queue, ' +
      '#{{componentId}}-{{sectionId}}-modules-filter-clear').tooltip('dispose');
    $('#{{componentId}}-{{sectionId}}-modules-repo-sync, ' +
      '#{{componentId}}-{{sectionId}}-modules-filter-update-available, ' +
      '#{{componentId}}-{{sectionId}}-modules-filter-new-available, ' +
      '#{{componentId}}-{{sectionId}}-modules-filter-update, ' +
      '#{{componentId}}-{{sectionId}}-modules-filter-install, ' +
      '#{{componentId}}-{{sectionId}}-modules-filter-uninstall, ' +
      '#{{componentId}}-{{sectionId}}-modules-filter-remove, ' +
      '#{{componentId}}-{{sectionId}}-modules-filter-queue, ' +
      '#{{componentId}}-{{sectionId}}-modules-filter-clear').tooltip('enable');

    $('#{{componentId}}-{{sectionId}}-modules-repo-sync, ' +
      '#{{componentId}}-{{sectionId}}-modules-filter-update-available, ' +
      '#{{componentId}}-{{sectionId}}-modules-filter-new-available, ' +
      '#{{componentId}}-{{sectionId}}-modules-filter-update, ' +
      '#{{componentId}}-{{sectionId}}-modules-filter-install, ' +
      '#{{componentId}}-{{sectionId}}-modules-filter-uninstall, ' +
      '#{{componentId}}-{{sectionId}}-modules-filter-remove, ' +
      '#{{componentId}}-{{sectionId}}-modules-filter-queue, ' +
      '#{{componentId}}-{{sectionId}}-modules-filter-clear')
    .click(function(e) {
        e.preventDefault();

        if (dataCollectionSectionForm['vars']['sync'] === true) {
            return;
        }

        if ($(this)[0].id === '{{componentId}}-{{sectionId}}-modules-repo-sync') {
            dataCollectionSectionForm['funcs']['toggleJstreeTool']($(this)[0].id);

            dataCollectionSectionForm['funcs']['initSync'](
                $('#{{componentId}}-{{sectionId}}-modules').jstree().get_selected(true)[0].data.apiid
            );

            return;
        }

        dataCollectionSectionForm['vars']['filter'] = false;

        $('#{{componentId}}-{{sectionId}}-modules').jstree().clear_search();
        $('#{{componentId}}-{{sectionId}}-modules').jstree().deselect_all();

        if ($(this)[0].id === '{{componentId}}-{{sectionId}}-modules-filter-update-available' ||
            $(this)[0].id === '{{componentId}}-{{sectionId}}-modules-filter-update'
        ) {
            dataCollectionSectionForm['vars']['filter'] = true;
            $('#{{componentId}}-{{sectionId}}-modules-tree-search-input').val('update');
            $('#{{componentId}}-{{sectionId}}-modules').jstree().search('update');
        } else if ($(this)[0].id === '{{componentId}}-{{sectionId}}-modules-filter-new-available') {
            $('#{{componentId}}-{{sectionId}}-modules-tree-search-input').val('new');
            $('#{{componentId}}-{{sectionId}}-modules').jstree().search('new');
        } else if ($(this)[0].id === '{{componentId}}-{{sectionId}}-modules-filter-install') {
            $('#{{componentId}}-{{sectionId}}-modules-tree-search-input').val(':Install');
            $('#{{componentId}}-{{sectionId}}-modules').jstree().search(':Install');
        } else if ($(this)[0].id === '{{componentId}}-{{sectionId}}-modules-filter-uninstall') {
            $('#{{componentId}}-{{sectionId}}-modules-tree-search-input').val(':Uninstall');
            $('#{{componentId}}-{{sectionId}}-modules').jstree().search(':Uninstall');
        } else if ($(this)[0].id === '{{componentId}}-{{sectionId}}-modules-filter-remove') {
            $('#{{componentId}}-{{sectionId}}-modules-tree-search-input').val(':Remove');
            $('#{{componentId}}-{{sectionId}}-modules').jstree().search(':Remove');
        } else if ($(this)[0].id === '{{componentId}}-{{sectionId}}-modules-filter-queue') {
            $('#{{componentId}}-{{sectionId}}-modules-tree-search-input').val('in queue:');
            $('#{{componentId}}-{{sectionId}}-modules').jstree().search('in queue:');
        } else if ($(this)[0].id === '{{componentId}}-{{sectionId}}-modules-filter-clear') {
            $('#{{componentId}}-{{sectionId}}-modules-tree-search-input').val('');
            $('#{{componentId}}-{{sectionId}}-modules').jstree().open_all();
        }
        dataCollectionSectionForm['funcs']['toggleJstreeTool']('{{componentId}}-{{sectionId}}-modules-repo-update');
        dataCollectionSectionForm['funcs']['toggleJstreeTool']('{{componentId}}-{{sectionId}}-modules-repo-sync');

        dataCollectionSectionForm['funcs']['moduleinfo'](['noinfo'], []);
    });
}

dataCollectionSectionForm['funcs']['jstreeReady']();//We start here

dataCollectionSectionForm['funcs']['applyColorsToTreeIconsAndUpdateText'] =
    function(nodeId = null, install = false, uninstall = false, remove = false, init = false) {
        var allNodes;

        if (nodeId) {
            allNodes = $('#{{componentId}}-{{sectionId}}-modules').jstree().get_node(nodeId);
        } else {
            allNodes = dataCollectionSectionForm['vars']['rootTree']
        }

        var updateAvailable = false;
        var nT, nD, index;
        var orgInstall = install;
        var orgUninstall = uninstall;
        var orgRemove = remove;

        $(allNodes).each(function(i, node) {
            install = orgInstall;
            uninstall = orgUninstall;
            remove = orgRemove;

            if (node.id.startsWith('j')) {
                if (node.data.type === 'repo') {
                    $('#{{componentId}}-{{sectionId}}-modules').jstree().set_icon(node, 'fas fa-fw fa-cloud-arrow-down text-primary');
                }
                return true;
            }

            nD = node.data;

            if (dataCollectionSectionForm['vars']['modules'][nD.apiid]['childs'][nD.apptype]['childs'][nD.moduletype]['childs'][nD.modulecategory]) {
                nT =
                    dataCollectionSectionForm['vars']['modules'][nD.apiid]['childs'][nD.apptype]['childs'][nD.moduletype]['childs'][nD.modulecategory]['childs'][node.id]['name'];
            } else if (dataCollectionSectionForm['vars']['modules'][nD.apiid]['childs'][nD.apptype]['childs'][nD.moduletype]['childs'][node.id]) {
                nT =
                    dataCollectionSectionForm['vars']['modules'][nD.apiid]['childs'][nD.apptype]['childs'][nD.moduletype]['childs'][node.id]['name'];
            }

            if (dataCollectionSectionForm['vars']['queue']['total'] > 0) {
                var tasks = ['install', 'update', 'uninstall', 'remove'];

                $(tasks).each(function(i, task) {
                    if (Object.keys(dataCollectionSectionForm['vars']['queue']['tasks'][task]).length > 0) {
                        if (dataCollectionSectionForm['vars']['queue']['tasks'][task][nD.moduletype] &&
                            BazHelpers.getKeyByValue(dataCollectionSectionForm['vars']['queue']['tasks'][task][nD.moduletype], nD.id) > -1
                        ) {
                            if (task === 'install') {
                                install = true;
                                dataCollectionSectionForm['funcs']['toggleJstreeTool']('{{componentId}}-{{sectionId}}-modules-filter-install', 'primary', false);
                            } else if (task === 'uninstall') {
                                uninstall = true;
                                dataCollectionSectionForm['funcs']['toggleJstreeTool']('{{componentId}}-{{sectionId}}-modules-filter-uninstall', 'warning', false);
                            } else if (task === 'remove') {
                                remove = true;
                                dataCollectionSectionForm['funcs']['toggleJstreeTool']('{{componentId}}-{{sectionId}}-modules-filter-remove', 'danger', false);
                            }

                            return;
                        }
                    }
                });
                dataCollectionSectionForm['funcs']['initQueueButtons']();
            } else {
                dataCollectionSectionForm['funcs']['initQueueButtons'](false);
            }

            if (install === true) {
                $('#{{componentId}}-{{sectionId}}-modules').jstree().set_icon(node, 'fas fa-fw fa-circle-plus text-primary');

                if (nD.update_available && nD.update_available == 1) {
                    $('#{{componentId}}-{{sectionId}}-modules').jstree().set_text(node, nT + ' (In Queue:Update)');
                    updateAvailable = true;
                    dataCollectionSectionForm['funcs']['toggleJstreeTool']('{{componentId}}-{{sectionId}}-modules-filter-update-available', 'info', false);
                } else {
                    if (nD.isnew && nD.isnew == 1) {
                        $('#{{componentId}}-{{sectionId}}-modules').jstree().set_text(
                            node,
                            nT +
                            ' (In Queue:Install) ' +
                            ' <span class="text-uppercase" style="top: -1px;position: relative;"><span class="badge badge-primary">NEW</span></span>'
                        );
                        dataCollectionSectionForm['vars']['new_available'] = 1;
                    } else {
                        $('#{{componentId}}-{{sectionId}}-modules').jstree().set_text(node, nT + ' (In Queue:Install)');
                    }
                }
            } else if (uninstall === true) {
                $('#{{componentId}}-{{sectionId}}-modules').jstree().set_icon(node, 'fas fa-fw fa-circle-minus text-warning');
                $('#{{componentId}}-{{sectionId}}-modules').jstree().set_text(node, nT + ' (In Queue:Uninstall)');
            } else if (remove === true) {
                $('#{{componentId}}-{{sectionId}}-modules').jstree().set_icon(node, 'fas fa-fw fa-circle-xmark text-danger');
                $('#{{componentId}}-{{sectionId}}-modules').jstree().set_text(node, nT + ' (In Queue:Remove)');
            } else {
                if (nD.installed == 1) {
                    $('#{{componentId}}-{{sectionId}}-modules').jstree().set_icon(node, 'fas fa-fw fa-circle-check text-success');
                    $('#{{componentId}}-{{sectionId}}-modules').jstree().set_text(node, nT);
                } else {
                    if (nD.isnew && nD.isnew == 1) {
                        $('#{{componentId}}-{{sectionId}}-modules').jstree().set_icon(node, 'fa fa-fw fa-star text-primary');
                        $('#{{componentId}}-{{sectionId}}-modules')
                        .jstree()
                        .set_text(
                            node,
                            nT +
                                ' <span class="text-uppercase" style="top: -1px;position: relative;"><span class="badge badge-primary">NEW</span></span>'
                        );
                        dataCollectionSectionForm['vars']['new_available'] = 1;
                    } else {
                        $('#{{componentId}}-{{sectionId}}-modules').jstree().set_icon(node, 'fa fa-fw fa-circle-dot text-primary');
                        $('#{{componentId}}-{{sectionId}}-modules').jstree().set_text(node, nT);
                    }
                }

                if (nD.update_available && nD.update_available == 1) {
                    updateAvailable = true;
                    dataCollectionSectionForm['funcs']['toggleJstreeTool']('{{componentId}}-{{sectionId}}-modules-filter-update-available', 'info', false);
                    $('#{{componentId}}-{{sectionId}}-modules').jstree().set_icon(node, 'fas fa-fw fa-circle-up text-info');
                    $('#{{componentId}}-{{sectionId}}-modules').jstree().set_text(node, nT + ' (Update Available)');

                    if (dataCollectionSectionForm['vars']['queue']['tasks']['update'][nD.moduletype] &&
                        BazHelpers.getKeyByValue(dataCollectionSectionForm['vars']['queue']['tasks']['update'][nD.moduletype], nD.id) > -1
                    ) {
                        index = BazHelpers.getKeyByValue(dataCollectionSectionForm['vars']['queue']['tasks']['update'][nD.moduletype], nD.id)

                        $('#{{componentId}}-{{sectionId}}-modules').jstree().set_icon(node, 'fas fa-fw fa-circle-up text-info');
                        $('#{{componentId}}-{{sectionId}}-modules').jstree().set_text(node, nT + ' (In Queue:Update)');
                        dataCollectionSectionForm['funcs']['toggleJstreeTool']('{{componentId}}-{{sectionId}}-modules-filter-update', 'info', false);
                    }
                }
            }
        });

        if (updateAvailable && (dataCollectionSectionForm['vars']['filter'] === true || init === true)) {
            if (init === true) {
                dataCollectionSectionForm['vars']['initJstree'] = true;
            } else {
                dataCollectionSectionForm['vars']['initJstree'] = false;
            }

            dataCollectionSectionForm['vars']['filter'] = true;
            $('#{{componentId}}-{{sectionId}}-modules-tree-search-input').val('update');
            $('#{{componentId}}-{{sectionId}}-modules').jstree().search('update');
        } else if (dataCollectionSectionForm['vars']['new_available'] == 1) {
            dataCollectionSectionForm['vars']['filter'] = true;
            $('#{{componentId}}-{{sectionId}}-modules-tree-search-input').val('new');
            $('#{{componentId}}-{{sectionId}}-modules').jstree().search('new');
        }

        if (dataCollectionSectionForm['vars']['queue']['total'] > 0) {
            dataCollectionSectionForm['funcs']['toggleJstreeTool']('{{componentId}}-{{sectionId}}-modules-filter-queue', 'purple', false);
            dataCollectionSectionForm['funcs']['toggleJstreeTool']('{{componentId}}-{{sectionId}}-modules-filter-clear', 'primary', false);
        }

        if (dataCollectionSectionForm['vars']['new_available'] > 0) {
            dataCollectionSectionForm['funcs']['toggleJstreeTool']('{{componentId}}-{{sectionId}}-modules-filter-new-available', 'primary', false);
            dataCollectionSectionForm['funcs']['toggleJstreeTool']('{{componentId}}-{{sectionId}}-modules-filter-clear', 'primary', false);
        }
}

dataCollectionSectionForm['funcs']['jstreeSelectNode'] = function() {
    $('#{{componentId}}-{{sectionId}}-modules').off('select_node.jstree');
    $('#{{componentId}}-{{sectionId}}-modules').on('select_node.jstree', function() {
        var selected = $('#{{componentId}}-{{sectionId}}-modules').jstree().get_selected(true);

        if (selected[0].id.startsWith('j')) {
            if (selected[0].data.type !== 'repo') {
                $('#{{componentId}}-{{sectionId}}-modules').jstree().deselect_node(selected);

                dataCollectionSectionForm['funcs']['toggleJstreeTool']('{{componentId}}-{{sectionId}}-modules-repo-add');
                dataCollectionSectionForm['funcs']['toggleJstreeTool']('{{componentId}}-{{sectionId}}-modules-repo-update');
                dataCollectionSectionForm['funcs']['toggleJstreeTool']('{{componentId}}-{{sectionId}}-modules-repo-sync');
                dataCollectionSectionForm['funcs']['moduleinfo'](['noinfo']);
                return false;
            } else if (selected[0].data.type === 'repo') {
                dataCollectionSectionForm['funcs']['toggleJstreeTool']('{{componentId}}-{{sectionId}}-modules-repo-add', 'success', false);
                dataCollectionSectionForm['funcs']['toggleJstreeTool']('{{componentId}}-{{sectionId}}-modules-repo-update', 'warning', false);
                $('#{{componentId}}-{{sectionId}}-modules-repo-update').attr(
                    'href', '{{links.url("system/api/client/services/q/id/' + selected[0].data.apiid + '")}}'
                );
                dataCollectionSectionForm['funcs']['toggleJstreeTool']('{{componentId}}-{{sectionId}}-modules-repo-sync', 'primary', false);
            }

            dataCollectionSectionForm['funcs']['moduleinfo']();
        } else {
            if (selected[0].data.type !== 'repo') {
                dataCollectionSectionForm['funcs']['toggleJstreeTool']('{{componentId}}-{{sectionId}}-modules-repo-add');
                dataCollectionSectionForm['funcs']['toggleJstreeTool']('{{componentId}}-{{sectionId}}-modules-repo-update');
                dataCollectionSectionForm['funcs']['toggleJstreeTool']('{{componentId}}-{{sectionId}}-modules-repo-sync');
            }

            dataCollectionSectionForm['funcs']['toggleJstreeTool']('{{componentId}}-{{sectionId}}-modules-repo-sync');
            dataCollectionSectionForm['funcs']['moduleinfo'](['loader']);
            dataCollectionSectionForm['funcs']['getSelectedModuleInfo'](selected[0].id);
        }
    });
}
dataCollectionSectionForm['funcs']['jstreeSelectNode']();//Enable selection of modules

dataCollectionSectionForm['funcs']['toggleJstreeTool'] = function(toolId, textColor, isDisabled = true) {
    if (textColor === 'undefined') {
        textColor = 'secondary';
    }

    if (isDisabled) {
        $('#' + toolId).addClass('disabled');
        if (textColor !== null) {
            $('#' + toolId).children('i').removeClass(function (index, className) {
                return (className.match (/(^|\s)text-\S+/g) || []).join(' ');
            }).addClass('text-secondary');
            $('#' + toolId).find('.badge').removeClass(function (index, className) {
                return (className.match (/(^|\s)badge-\S+/g) || []).join(' ');
            }).addClass('badge-secondary');
        }
    } else {
        $('#' + toolId).removeClass('disabled');
        if (textColor !== null) {
            $('#' + toolId).children('i').removeClass(function (index, className) {
                return (className.match (/(^|\s)text-\S+/g) || []).join(' ');
            }).addClass('text-' + textColor);
            $('#' + toolId).find('.badge').removeClass(function (index, className) {
                return (className.match (/(^|\s)badge-\S+/g) || []).join(' ');
            }).addClass('badge-' + textColor);
        }
    }
}
dataCollectionSectionForm['funcs']['moduleinfo'] = function(show = ['noinfo'], showButtons = ['cancel'], showSettings = true, showBundleModules = false) {
    $('#{{componentId}}-{{sectionId}}-tabs-tabLinks a').removeClass('active');
    $('#{{componentId}}-{{sectionId}}-tabs-tabContent .tab-pane').removeClass('active show');
    $('#{{componentId}}-{{sectionId}}-tabs-info').addClass('active show');
    $('a[href*="#{{componentId}}-{{sectionId}}-tabs-info"]').addClass('active');

    if (!showSettings) {
        $('a[href*="#{{componentId}}-{{sectionId}}-tabs-settings"]').parent().addClass('d-none');
    } else {
        $('a[href*="#{{componentId}}-{{sectionId}}-tabs-settings"]').parent().removeClass('d-none');
    }
    if (!showBundleModules) {
        $('a[href*="#{{componentId}}-{{sectionId}}-tabs-bundlemodules"]').parent().addClass('d-none');
    } else {
        $('a[href*="#{{componentId}}-{{sectionId}}-tabs-bundlemodules"]').parent().removeClass('d-none');
    }

    if (show.length > 0) {
        var moduleinfos = ['loader', 'info', 'noinfo', 'error', 'buttons'];
        $(moduleinfos).each(function(e, moduleinfo) {
            if (show.includes(moduleinfo)) {
                $('#{{componentId}}-{{sectionId}}-moduleinfo-' + moduleinfo).attr('hidden', false);
            } else {
                $('#{{componentId}}-{{sectionId}}-moduleinfo-' + moduleinfo).attr('hidden', true);
            }
        });
    }

    if (showButtons.length > 0) {
        var modulebuttons = ['install', 'update', 'uninstall', 'remove', 'cancel', 'repo-sync'];
        $(modulebuttons).each(function(e, modulebutton) {
            if (showButtons.includes(modulebutton)) {
                $('#{{componentId}}-{{sectionId}}-moduleinfo-' + modulebutton).attr('hidden', false);
            } else {
                $('#{{componentId}}-{{sectionId}}-moduleinfo-' + modulebutton).attr('hidden', true);
            }
        });
    }
}

dataCollectionSectionForm['funcs']['getSelectedModuleInfo'] = function(selected) {
    if (!selected) {
        return false;
    }

    var splitModule, moduleType, moduleId;

    splitModule = selected.split('-');
    moduleId = splitModule[1];

    if (selected.startsWith('components')) {
        moduleType = 'components';
    } else if (selected.startsWith('packages')) {
        moduleType = 'packages';
    } else if (selected.startsWith('middlewares')) {
        moduleType = 'middlewares';
    } else if (selected.startsWith('views')) {
        moduleType = 'views';
    } else if (selected.startsWith('bundles')) {
        moduleType = 'bundles';
    }

    if (moduleType && moduleId) {
        dataCollectionSectionForm['funcs']['getModuleInfo'](moduleType, moduleId);

        return true;
    }

    return false;
}

dataCollectionSectionForm['funcs']['getModuleInfo'] = function(moduleType, moduleId, sync = false) {
    var postData = { };
    postData[$('#security-token').attr('name')] = $('#security-token').val();
    postData['module_type'] = moduleType;
    postData['module_id'] = moduleId;
    if (sync) {
        dataCollectionSectionForm['vars']['sync'] = true;
        postData['sync'] = true;
    }

    $.post('{{links.url("modules/getModuleInfo")}}', postData, function(response) {
        if (response.tokenKey && response.token) {
            $('#security-token').attr('name', response.tokenKey);
            $('#security-token').val(response.token);
        }

        $('#{{componentId}}-{{sectionId}}-moduleinfo-repo-sync').attr('disabled', false);
        $('#{{componentId}}-{{sectionId}}-moduleinfo-repo-sync').children("i").removeClass("fa-cog fa-spin").addClass("fa-sync-alt");

        if (response.responseCode == 0) {
            if (response.responseData.module) {

                dataCollectionSectionForm['vars']['module'] = response.responseData.module;

                dataCollectionSectionForm['funcs']['processModuleInfo'](response.responseData.module);
            }
        } else if (response.responseCode == 1) {
            dataCollectionSectionForm['funcs']['moduleinfo'](['error']);
        } else if (response.responseCode == 2) {
            paginatedPNotify('error', {text: response.responseMessage});
            if (response.responseData.module) {
                dataCollectionSectionForm['vars']['module'] = response.responseData.module;
                dataCollectionSectionForm['funcs']['processModuleInfo'](response.responseData.module);
            }
        }
        dataCollectionSectionForm['vars']['sync'] = false;
    }, 'json');
}

dataCollectionSectionForm['funcs']['processModuleInfo'] = function(moduleInfo) {
    var moduleData = { };
    var index;

    for (var m in moduleInfo) {
        if (moduleInfo[m] === '' || moduleInfo[m] === null) {
            moduleData[m] = '-';
        } else {
            moduleData[m] = moduleInfo[m];
        }
    }

    if (moduleData['installed'] == 1) {
        moduleData['installed'] = '<span class="badge badge-success text-xs">Yes</span>';
    } else {
        moduleData['installed'] = '<span class="badge badge-secondary text-xs">No</span>';
    }

    if (moduleData['update_available'] !== '-' && moduleData['update_available'] == 1) {
        moduleData['update_available'] = '<span class="badge badge-info text-xs">Yes</span>';
    }
    if (moduleData['update_version'] !== '-') {
        moduleData['update_version'] = '<span class="badge badge-info text-xs">' + moduleData['update_version'] + '</span>';
    }

    moduleData['version'] = '<span class="badge badge-info text-xs">' + moduleData['version'] + '</span>';

    $('#app_type').html(moduleData.app_type);
    $('#category').html(moduleData.category);
    $('#update_available').html(moduleData.update_available);
    $('#update_version').html(moduleData.update_version);
    $('#updated_on').html(moduleData.updated_on);
    $('#installed').html(moduleData.installed);
    $('#version').html(moduleData.version);
    $('#updated_by').html(moduleData.updated_by);
    $('#module_type').html(moduleData.module_type);
    if (moduleData.display_name) {
        $('#display_name').html(moduleData.display_name);
        $('#display_name').html(moduleData.display_name);
    } else {
        $('#display_name').html(moduleData.name);
    }
    $('#module_id').html(moduleData.id);
    $('#description').html(moduleData.description);

    if (moduleData.repo_details.latestRelease && moduleData.repo_details.latestRelease.body) {
        var changelogText;
        if (moduleData.repo_details.latestRelease.prerelease === false) {
            changelogText =
                'VERSION: ' + moduleData.repo_details.latestRelease.name +
                ' <span class="text-uppercase" style="top: -1px;position: relative;"><span class="badge badge-success text-xs">STABLE</span></span>';
        } else {
            changelogText =
                'VERSION: ' + moduleData.repo_details.latestRelease.name +
                ' <span class="text-uppercase" style="top: -1px;position: relative;"><span class="badge badge-danger text-xs">UNSTABLE</span></span>';
        }
        $('#changelogs-version').html(changelogText);
        $('#changelogs').html(moduleData.repo_details.latestRelease.body);
    }

    $('#{{componentId}}-{{sectionId}}-auto_update')[0].checked = false;
    if (moduleInfo.auto_update !== 'null') {
        if (moduleInfo.auto_update == '0') {
            $('#{{componentId}}-{{sectionId}}-auto_update')[0].checked = false;
        } else if (moduleInfo.auto_update == '1') {
            $('#{{componentId}}-{{sectionId}}-auto_update')[0].checked = true;
        }
    }

    if (moduleInfo.level_of_update !== 'null') {
        $('#{{componentId}}-{{sectionId}}-level_of_update').val(moduleInfo.level_of_update).trigger('change');
    }

    if (moduleInfo.installed == '1') {
        if (moduleInfo.update_available == '1') {
            if (dataCollectionSectionForm['vars']['queue']['tasks']['update'][moduleInfo.module_type] &&
                (BazHelpers.getKeyByValue(dataCollectionSectionForm['vars']['queue']['tasks']['update'][moduleInfo.module_type], moduleInfo.id) > -1)
            ) {
                dataCollectionSectionForm['funcs']['moduleinfo'](['info'], ['cancel', 'repo-sync']);
            } else {
                dataCollectionSectionForm['funcs']['moduleinfo'](['info'], ['update', 'remove', 'repo-sync']);
            }
        } else {
            if (dataCollectionSectionForm['vars']['queue']['tasks']['install'][moduleInfo.module_type] &&
                (BazHelpers.getKeyByValue(dataCollectionSectionForm['vars']['queue']['tasks']['install'][moduleInfo.module_type], moduleInfo.id) > -1)
            ) {
                dataCollectionSectionForm['funcs']['moduleinfo'](['info'], ['cancel', 'repo-sync']);
            } else {
                dataCollectionSectionForm['funcs']['moduleinfo'](['info'], ['uninstall', 'remove', 'repo-sync']);
            }
        }
    } else {
        if (dataCollectionSectionForm['vars']['queue']['tasks']['install'][moduleData.module_type]) {
            index = BazHelpers.getKeyByValue(dataCollectionSectionForm['vars']['queue']['tasks']['install'][moduleData.module_type], moduleData.id);
        }
        if (!index && dataCollectionSectionForm['vars']['queue']['tasks']['remove'][moduleData.module_type]) {
            index = BazHelpers.getKeyByValue(dataCollectionSectionForm['vars']['queue']['tasks']['remove'][moduleData.module_type], moduleData.id);
        }

        if (index > -1) {
            dataCollectionSectionForm['funcs']['moduleinfo']([], ['cancel', 'repo-sync']);
        } else {
            dataCollectionSectionForm['funcs']['moduleinfo']([], ['install', 'remove', 'repo-sync']);
        }
    }

    if (moduleData['module_type'] === 'bundles') {
        var bundleModuleHtml = '';

        if (moduleData.bundle_modules && Object.keys(moduleData.bundle_modules).length > 0) {
            for (var bundleModuleType in moduleData.bundle_modules) {
                if (bundleModuleType === 'core' || bundleModuleType === 'apptype') {
                    bundleModuleHtml +=
                    '       <tr>' +
                    '           <td>' +  moduleData.bundle_modules[bundleModuleType]['name'] + '</td>' +
                    '           <td>' +  bundleModuleType + '</td>' +
                    '           <td>' +  moduleData.bundle_modules[bundleModuleType]['version'] + '</td>' +
                    '           <td>' +  moduleData.bundle_modules[bundleModuleType]['repo'] + '</td>' +
                    '       </tr>';
                } else {
                    if (Array.isArray(moduleData.bundle_modules[bundleModuleType]) && moduleData.bundle_modules[bundleModuleType].length > 0) {
                        $(moduleData.bundle_modules[bundleModuleType]).each(function(i, v) {
                            bundleModuleHtml +=
                            '       <tr>' +
                            '           <td>' +  v['name'] + '</td>' +
                            '           <td>' +  bundleModuleType + '</td>' +
                            '           <td>' +  v['version'] + '</td>' +
                            '           <td>' +  v['repo'] + '</td>' +
                            '       </tr>';
                        });
                    }
                }
            }
        }

        $('#{{componentId}}-{{sectionId}}-bundle-table tbody').empty().html(bundleModuleHtml);

        $(document).ready(function() {
            if (!$.fn.DataTable.isDataTable('#{{componentId}}-{{sectionId}}-bundle-table')) {
                $('#{{componentId}}-{{sectionId}}-bundle-table').DataTable({
                      columns: [
                        null,
                        null,
                        null,
                        null,
                      ]
                    }
                );
            }
        });
        dataCollectionSectionForm['funcs']['moduleinfo'](['info', 'buttons'], [], true, true);
    } else {
        dataCollectionSectionForm['funcs']['moduleinfo'](['info', 'buttons'], []);

        if (moduleData['app_type'] === 'core') {
            if (moduleInfo['name'] !== 'Core') {
                dataCollectionSectionForm['funcs']['moduleinfo'](['info'], [], false);
            } else {
                if (dataCollectionSectionForm['vars']['queue']['tasks']['update'][moduleData.module_type]) {
                    index = BazHelpers.getKeyByValue(dataCollectionSectionForm['vars']['queue']['tasks']['update'][moduleData.module_type], moduleData.id);
                }

                if (index !== 'undefined' && index > -1) {
                    dataCollectionSectionForm['funcs']['moduleinfo'](['info', 'buttons'], ['cancel', 'repo-sync']);
                } else {
                    if (moduleInfo.update_available == '1') {
                        dataCollectionSectionForm['funcs']['moduleinfo']([], ['update', 'repo-sync']);
                    } else {
                        dataCollectionSectionForm['funcs']['moduleinfo']([], ['repo-sync']);
                    }
                }
            }
        }
    }

    dataCollectionSectionForm['funcs']['initModuleButtons']();
}

dataCollectionSectionForm['funcs']['initModuleButtons'] = function() {
    $('#{{componentId}}-{{sectionId}}-moduleinfo-install, ' +
      '#{{componentId}}-{{sectionId}}-moduleinfo-update, ' +
      '#{{componentId}}-{{sectionId}}-moduleinfo-uninstall, ' +
      '#{{componentId}}-{{sectionId}}-moduleinfo-remove, ' +
      '#{{componentId}}-{{sectionId}}-moduleinfo-cancel, ' +
      '#{{componentId}}-{{sectionId}}-moduleinfo-repo-sync').off();

    $('#{{componentId}}-{{sectionId}}-moduleinfo-install').click(function(e) {
        e.preventDefault();

        dataCollectionSectionForm['funcs']['updateQueue'](
            dataCollectionSectionForm['vars']['module']['id'],
            dataCollectionSectionForm['vars']['module']['module_type'],
            'install'
        );
    });

    $('#{{componentId}}-{{sectionId}}-moduleinfo-update').click(function(e) {
        e.preventDefault();

        dataCollectionSectionForm['funcs']['updateQueue'](
            dataCollectionSectionForm['vars']['module']['id'],
            dataCollectionSectionForm['vars']['module']['module_type'],
            'update'
        );
    });

    $('#{{componentId}}-{{sectionId}}-moduleinfo-uninstall').click(function(e) {
        e.preventDefault();

        dataCollectionSectionForm['funcs']['updateQueue'](
            dataCollectionSectionForm['vars']['module']['id'],
            dataCollectionSectionForm['vars']['module']['module_type'],
            'uninstall'
        );
    });

    $('#{{componentId}}-{{sectionId}}-moduleinfo-remove').click(function(e) {
        e.preventDefault();

        dataCollectionSectionForm['funcs']['updateQueue'](
            dataCollectionSectionForm['vars']['module']['id'],
            dataCollectionSectionForm['vars']['module']['module_type'],
            'remove'
        );
    });

    $('#{{componentId}}-{{sectionId}}-moduleinfo-cancel').click(function(e) {
        e.preventDefault();

        dataCollectionSectionForm['funcs']['updateQueue'](
            dataCollectionSectionForm['vars']['module']['id'],
            dataCollectionSectionForm['vars']['module']['module_type'],
            'cancel'
        );
    });

    $('#{{componentId}}-{{sectionId}}-moduleinfo-repo-sync').click(function(e) {
        e.preventDefault();

        $(this).attr('disabled', true);
        $(this).children("i").removeClass("fa-sync-alt").addClass("fa-cog fa-spin");

        dataCollectionSectionForm['funcs']['moduleinfo'](['loader', 'buttons'], ['repo-sync']);

        dataCollectionSectionForm['funcs']['getModuleInfo'](
            dataCollectionSectionForm['vars']['module']['module_type'],
            dataCollectionSectionForm['vars']['module']['id'],
            true
        );
    });
}

dataCollectionSectionForm['funcs']['updateQueue'] = function(id, moduleType, task) {
    var postData = { };
    postData[$('#security-token').attr('name')] = $('#security-token').val();
    postData['task'] = task;
    postData['id'] = id;
    postData['moduleType'] = moduleType;

    $.post('{{links.url("modules/modifyQueue")}}', postData, function(response) {
        if (response.tokenKey && response.token) {
            $('#security-token').attr('name', response.tokenKey);
            $('#security-token').val(response.token);
        }

        if (response.responseCode == 0) {
            paginatedPNotify('success', {
                text        : response.responseMessage,
            });

            var index;

            if (response.responseData.queue.tasks != null && response.responseData.queue.total != null) {
                dataCollectionSectionForm['vars']['queue']['tasks'] = response.responseData.queue.tasks;
                dataCollectionSectionForm['vars']['queue']['total'] = response.responseData.queue.total;
            } else {
                paginatedPNotify('error', {
                    text        : 'Incorrect information received from queue manager. Please contact administrator.',
                });
            }

            // if (task !== 'cancel' && task !== 'clearQueue') {
            //     if (!dataCollectionSectionForm['vars']['queue_data'][task][moduleType]) {
            //         dataCollectionSectionForm['vars']['queue_data'][task][moduleType] = { };
            //     }

            //     dataCollectionSectionForm['vars']['queue_data'][task][moduleType][id] = dataCollectionSectionForm['vars']['module'];
            // }

            $('#queue-counter').empty().html(dataCollectionSectionForm['vars']['queue']['total']);

            if (task === 'install') {
                dataCollectionSectionForm['funcs']['moduleinfo'](['info', 'buttons'], ['cancel', 'repo-sync']);
                dataCollectionSectionForm['funcs']['toggleJstreeTool']('{{componentId}}-{{sectionId}}-modules-filter-install', 'primary', false);
                dataCollectionSectionForm['funcs']['toggleJstreeTool']('{{componentId}}-{{sectionId}}-modules-filter-queue', 'purple', false);
                dataCollectionSectionForm['funcs']['applyColorsToTreeIconsAndUpdateText'](moduleType + '-' + id, true);
            } else if (task === 'update') {
                dataCollectionSectionForm['funcs']['moduleinfo'](['info', 'buttons'], ['cancel', 'repo-sync']);
                dataCollectionSectionForm['funcs']['toggleJstreeTool']('{{componentId}}-{{sectionId}}-modules-filter-update', 'info', false);
                dataCollectionSectionForm['funcs']['toggleJstreeTool']('{{componentId}}-{{sectionId}}-modules-filter-queue', 'purple', false);
                dataCollectionSectionForm['funcs']['applyColorsToTreeIconsAndUpdateText'](moduleType + '-' + id);
            } else if (task === 'uninstall') {
                dataCollectionSectionForm['funcs']['moduleinfo'](['info', 'buttons'], ['cancel', 'repo-sync']);
                dataCollectionSectionForm['funcs']['toggleJstreeTool']('{{componentId}}-{{sectionId}}-modules-filter-uninstall', 'warning', false);
                dataCollectionSectionForm['funcs']['toggleJstreeTool']('{{componentId}}-{{sectionId}}-modules-filter-queue', 'purple', false);
                dataCollectionSectionForm['funcs']['applyColorsToTreeIconsAndUpdateText'](moduleType + '-' + id, false, true);
            } else if (task === 'remove') {
                dataCollectionSectionForm['funcs']['moduleinfo'](['info', 'buttons'], ['cancel']);
                dataCollectionSectionForm['funcs']['toggleJstreeTool']('{{componentId}}-{{sectionId}}-modules-filter-remove', 'danger', false);
                dataCollectionSectionForm['funcs']['toggleJstreeTool']('{{componentId}}-{{sectionId}}-modules-filter-queue', 'purple', false);
                dataCollectionSectionForm['funcs']['applyColorsToTreeIconsAndUpdateText'](moduleType + '-' + id, false, false, true);
            } else if (task === 'cancel') {
                dataCollectionSectionForm['funcs']['processModuleInfo'](dataCollectionSectionForm['vars']['module']);

                for (var queueTask in dataCollectionSectionForm['vars']['queue']['tasks']) {
                    if (dataCollectionSectionForm['vars']['queue']['tasks'][queueTask].length === 0) {
                        dataCollectionSectionForm['funcs']['toggleJstreeTool']('{{componentId}}-{{sectionId}}-modules-filter-' + queueTask);
                    }
                }

                dataCollectionSectionForm['funcs']['applyColorsToTreeIconsAndUpdateText'](
                    dataCollectionSectionForm['vars']['module']['module_type'] + '-' + dataCollectionSectionForm['vars']['module']['id']
                );
            } else if (task === 'clearQueue') {
                dataCollectionSectionForm['funcs']['clearQueue']();
            }
        } else {
            paginatedPNotify('error', {
                text        : response.responseMessage,
            });
        }
    }, 'json');
}

dataCollectionSectionForm['funcs']['initQueueButtons'] = function(init = true) {
    if (init) {
        $('#{{componentId}}-{{sectionId}}-analyse-queue').removeClass('disabled');
        $('#{{componentId}}-{{sectionId}}-clear-queue').attr('disabled', false);

        $('#{{componentId}}-{{sectionId}}-analyse-queue, ' +
          '#{{componentId}}-{{sectionId}}-clear-queue'
          ).off();

        $('#{{componentId}}-{{sectionId}}-clear-queue').click(function(e) {
            e.preventDefault();

            dataCollectionSectionForm['funcs']['updateQueue'](0, 'all', 'clearQueue');
        });

        $('#{{componentId}}-{{sectionId}}-analyse-queue').click(function(e) {
            e.preventDefault();

            BazContentLoader.loadAjax($('#{{componentId}}-{{sectionId}}-analyse-queue'), {
                ajaxBefore                      : function () {
                                                    Pace.restart();
                                                    $("#baz-content").empty();
                                                    $("#loader").attr('hidden', false);
                                                },
                ajaxFinished                    : function () {
                                                    BazCore.updateBreadcrumb();
                                                    $("#loader").attr('hidden', true);
                                                },
                ajaxError                       : function () {
                                                    $("#loader").attr('hidden', true);
                                                    BazCore.updateBreadcrumb();
                                                }
            });
            // dataCollectionSectionForm['funcs']['analyseQueue']();
        });

        // $('#{{componentId}}-{{sectionId}}-perform-precheck').click(function(e) {
        //     e.preventDefault();

        //     dataCollectionSectionForm['funcs']['processQueue']();
        // });

        // $('#{{componentId}}-{{sectionId}}-process-queue').click(function(e) {
        //     e.preventDefault();

        //     dataCollectionSectionForm['funcs']['processQueue']('process');
        // });
    } else {
        $('#{{componentId}}-{{sectionId}}-analyse-queue').addClass('disabled');
        $('#{{componentId}}-{{sectionId}}-clear-queue').attr('disabled', true);
    }
}
// dataCollectionSectionForm['funcs']['analyseQueue'] = function() {
//     var error = false;
//     var postData = { };
//     postData[$('#security-token').attr('name')] = $('#security-token').val();

//     $.post('{{links.url("modules/analyseActiveQueue")}}', postData, function(response) {
//         if (response.tokenKey && response.token) {
//             $('#security-token').attr('name', response.tokenKey);
//             $('#security-token').val(response.token);
//         }

//         if (response.responseCode == 0) {
//             if (response.responseData && response.responseData.queueTasks && response.responseData.queueTasksCounter) {
//                 var moduleHtml = '';
//                 for (var q in response.responseData.queueTasks) {
//                     if (q === 'install' || q === 'uninstall' || q === 'update' || q === 'remove') {
//                         if (Object.keys(response.responseData.queueTasks[q]).length > 0) {
//                             for (var installTypes in response.responseData.queueTasks[q]) {
//                                 if (Object.keys(response.responseData.queueTasks[q][installTypes]).length > 0) {
//                                     for (var installType in response.responseData.queueTasks[q][installTypes]) {
//                                         var color = 'primary';

//                                         if (q === 'update') {
//                                             color = 'info';
//                                         } else if (q === 'uninstall') {
//                                             color = 'warning';
//                                         } else if (q === 'remove') {
//                                             color = 'danger';
//                                         }

//                                         if (response.responseData.queueTasks[q][installTypes][installType]['error']) {
//                                             error = true;
//                                         moduleHtml +=
//                                         '       <tr class="bg-danger">';
//                                         } else {
//                                         moduleHtml +=
//                                         '       <tr>';
//                                         }
//                                         moduleHtml +=
//                                         '           <td>' +  response.responseData.queueTasks[q][installTypes][installType]['name'] + '</td>' +
//                                         '           <td>' +  response.responseData.queueTasks[q][installTypes][installType]['module_type'] + '</td>' +
//                                         '           <td>' +  response.responseData.queueTasks[q][installTypes][installType]['version'] + '</td>' +
//                                         '           <td>' +  response.responseData.queueTasks[q][installTypes][installType]['repo'] + '</td>' +
//                                         '           <td>' +  '<span class="badge badge-' + color + ' mt-1 text-xs text-uppercase">' + q + '</span></td>' +
//                                         '           <td id="{{componentId}}-{{sectionId}}-analyse-queue-modules-precheck-' + response.responseData.queueTasks[q][installTypes][installType]['id'] + '"></td>' +
//                                         '           <td id="{{componentId}}-{{sectionId}}-analyse-queue-modules-completed-' + response.responseData.queueTasks[q][installTypes][installType]['id'] + '"></td>';
//                                         if (response.responseData.queueTasks[q][installTypes][installType]['error']) {
//                                         moduleHtml +=
//                                         '           <td id="{{componentId}}-{{sectionId}}-analyse-queue-modules-logs-' + response.responseData.queueTasks[q][installTypes][installType]['id'] + '">Error: ' + response.responseData.queueTasks[q][installTypes][installType]['error'] + '</td>' +
//                                         '       </tr>';
//                                         } else {
//                                         moduleHtml +=
//                                         '           <td id="{{componentId}}-{{sectionId}}-analyse-queue-modules-logs-' + response.responseData.queueTasks[q][installTypes][installType]['id'] + '"></td>' +
//                                         '       </tr>';
//                                         }
//                                     }
//                                 }
//                             }
//                         }
//                     }
//                     if (response.responseData.queueTasksCounter[q]) {
//                         $('#{{componentId}}-{{sectionId}}-queue-' + q).children('span').html(response.responseData.queueTasksCounter[q]);
//                     }
//                 }

//                 $('#{{componentId}}-{{sectionId}}-queue-table tbody').empty().html(moduleHtml);
//                 $('#{{componentId}}-{{sectionId}}-queue-analyse-modal').modal('show');
//             }
//             if (error) {
//                 $('#{{componentId}}-{{sectionId}}-perform-precheck').attr('disabled', true);
//             } else {
//                 $('#{{componentId}}-{{sectionId}}-perform-precheck').attr('disabled', false);
//             }
//         } else {
//             paginatedPNotify('error', {
//                 text        : response.responseMessage,
//                 textTrusted : true
//             });
//         }
//     }, 'json');
// }
dataCollectionSectionForm['funcs']['clearQueue'] = function() {
    // var index;
    //This should be done via modifyQueue
    // if (clearAll) {
        dataCollectionSectionForm['vars']['sync'] = false;
        dataCollectionSectionForm['vars']['initJstree'] = false;
        dataCollectionSectionForm['vars']['filter'] = false;
        dataCollectionSectionForm['vars']['module'] = { };
        dataCollectionSectionForm['vars']['update_available'] = 0;
        dataCollectionSectionForm['vars']['new_available'] = 0;
        // dataCollectionSectionForm['vars']['queue_data'] = { };
        // dataCollectionSectionForm['vars']['queue_data']['install'] = { };
        // dataCollectionSectionForm['vars']['queue_data']['uninstall'] = { };
        // dataCollectionSectionForm['vars']['queue_data']['update'] = { };
        // dataCollectionSectionForm['vars']['queue_data']['remove'] = { };
        dataCollectionSectionForm['vars']['syncInfo'] = '';
        dataCollectionSectionForm['funcs']['initQueueButtons'](false);
        dataCollectionSectionForm['funcs']['applyColorsToTreeIconsAndUpdateText'](null, false, false, false, true);
        dataCollectionSectionForm['funcs']['toggleJstreeTool']('{{componentId}}-{{sectionId}}-modules-filter-install');
        dataCollectionSectionForm['funcs']['toggleJstreeTool']('{{componentId}}-{{sectionId}}-modules-filter-update');
        dataCollectionSectionForm['funcs']['toggleJstreeTool']('{{componentId}}-{{sectionId}}-modules-filter-remove');
        dataCollectionSectionForm['funcs']['toggleJstreeTool']('{{componentId}}-{{sectionId}}-modules-filter-uninstall');
        dataCollectionSectionForm['funcs']['toggleJstreeTool']('{{componentId}}-{{sectionId}}-modules-filter-queue');
        dataCollectionSectionForm['funcs']['moduleinfo'](['noinfo']);
        $('#{{componentId}}-{{sectionId}}-modules').jstree().deselect_all();
    // } else {
    //     if (id && moduleType) {
    //         var actionTypes = ['install', 'update', 'uninstall', 'remove'];

    //         var foundIn;
    //         var disableFilterIcons = [];

    //         $(actionTypes).each(function(i, actionType) {
    //             if (dataCollectionSectionForm['vars']['queue']['tasks'][actionType][moduleType]) {
    //                 if (dataCollectionSectionForm['vars']['queue']['tasks'][actionType][moduleType].includes(id)) {
    //                     index = BazHelpers.getKeyByValue(dataCollectionSectionForm['vars']['queue']['tasks'][actionType][moduleType], id);

    //                     if (index > -1) {
    //                         dataCollectionSectionForm['vars']['queue']['tasks'][actionType][moduleType].splice(index, 1);

    //                         foundIn = actionType;
    //                     }
    //                 }

    //                 if (dataCollectionSectionForm['vars']['queue']['tasks'][actionType][moduleType].length === 0) {
    //                     delete dataCollectionSectionForm['vars']['queue']['tasks'][actionType][moduleType];
    //                 }

    //                 if (Object.keys(dataCollectionSectionForm['vars']['queue']['tasks'][actionType]).length === 0) {
    //                     disableFilterIcons.push(actionType);
    //                 }
    //             }

    //             if (dataCollectionSectionForm['vars']['queue_data'][actionType][moduleType] &&
    //                 dataCollectionSectionForm['vars']['queue_data'][actionType][moduleType][id]
    //             ) {
    //                 delete dataCollectionSectionForm['vars']['queue_data'][actionType][moduleType][id];

    //                 if (Object.keys(dataCollectionSectionForm['vars']['queue_data'][actionType][moduleType]).length === 0) {
    //                     delete dataCollectionSectionForm['vars']['queue_data'][actionType][moduleType];
    //                 }
    //             }
    //         });

    //         if (foundIn) {
    //             if (foundIn === 'install') {
    //                 dataCollectionSectionForm['funcs']['moduleinfo']([], ['install', 'remove', 'repo-sync']);
    //             } else if (foundIn === 'update') {
    //                 dataCollectionSectionForm['funcs']['moduleinfo']([], ['update', 'remove', 'repo-sync']);
    //             } else if (foundIn === 'uninstall') {
    //                 if (dataCollectionSectionForm['vars']['module']['update_available'] == '1') {
    //                     dataCollectionSectionForm['funcs']['moduleinfo']([], ['update', 'remove', 'repo-sync']);
    //                 } else {
    //                     dataCollectionSectionForm['funcs']['moduleinfo']([], ['uninstall', 'remove', 'repo-sync']);
    //                 }
    //             } else if (foundIn === 'remove') {
    //                 if (dataCollectionSectionForm['vars']['module']['update_available'] == '1') {
    //                     dataCollectionSectionForm['funcs']['moduleinfo']([], ['update', 'remove', 'repo-sync']);
    //                 } else if (dataCollectionSectionForm['vars']['module']['installed'] == '1') {
    //                     dataCollectionSectionForm['funcs']['moduleinfo']([], ['uninstall', 'remove', 'repo-sync']);
    //                 } else {
    //                     dataCollectionSectionForm['funcs']['moduleinfo']([], ['install', 'remove', 'repo-sync']);
    //                 }
    //             }

    //             if (dataCollectionSectionForm['vars']['module']['app_type'] === 'core') {
    //                 if (dataCollectionSectionForm['vars']['module']['name'] !== 'Core') {
    //                     dataCollectionSectionForm['funcs']['moduleinfo'](['info'], []);
    //                 } else {
    //                     dataCollectionSectionForm['funcs']['moduleinfo'](['info', 'buttons'], ['update', 'repo-sync']);
    //                 }
    //             }
    //         }

    //         if (disableFilterIcons.length > 0) {
    //             $(disableFilterIcons).each(function(i, filterIcon) {
    //                 dataCollectionSectionForm['funcs']['toggleJstreeTool']('{{componentId}}-{{sectionId}}-modules-filter-' + filterIcon);
    //             });
    //         }
    //     }

    //     dataCollectionSectionForm['vars']['queue']['count'] = dataCollectionSectionForm['vars']['queue']['count'] - 1;
    // }

    // $('#queue-counter').empty().html(dataCollectionSectionForm['vars']['queue']['count']);

    dataCollectionSectionForm['funcs']['applyColorsToTreeIconsAndUpdateText']();
}
// dataCollectionSectionForm['funcs']['processQueue'] = function(task = 'precheck') {
//     var postData = { };
//     postData[$('#security-token').attr('name')] = $('#security-token').val();
//     postData['queue'] = dataCollectionSectionForm['vars']['queue']['tasks'];
//     postData['process'] = 'runprecheck';
//     if (task === 'process') {
//         postData['process'] = 'runprocess';
//     }

//     $.post('{{links.url("modules/processQueue")}}', postData, function(response) {
//         if (response.tokenKey && response.token) {
//             $('#security-token').attr('name', response.tokenKey);
//             $('#security-token').val(response.token);
//         }

//         if (response.responseCode == 0) {
//             paginatedPNotify('success', {
//                 text        : response.responseMessage,
//                 textTrusted : true
//             });
//         } else {
//             paginatedPNotify('error', {
//                 text        : response.responseMessage,
//                 textTrusted : true
//             });
//         }
//     }, 'json');
// }

dataCollectionSectionForm['funcs']['initSync'] = function(val) {
    dataCollectionSectionForm['vars']['sync'] = true;
    $('#{{componentId}}-{{sectionId}}-modules-repo-sync').children("i").removeClass("fa-sync-alt").addClass("fa-cog fa-spin");

    dataCollectionSectionForm['funcs']['toggleJstreeTool']('{{componentId}}-{{sectionId}}-modules-filter-update-available', null, true);
    dataCollectionSectionForm['funcs']['toggleJstreeTool']('{{componentId}}-{{sectionId}}-modules-filter-new-available', null, true);
    dataCollectionSectionForm['funcs']['toggleJstreeTool']('{{componentId}}-{{sectionId}}-modules-filter-install', null, true);
    dataCollectionSectionForm['funcs']['toggleJstreeTool']('{{componentId}}-{{sectionId}}-modules-filter-update', null, true);
    dataCollectionSectionForm['funcs']['toggleJstreeTool']('{{componentId}}-{{sectionId}}-modules-filter-remove', null, true);
    dataCollectionSectionForm['funcs']['toggleJstreeTool']('{{componentId}}-{{sectionId}}-modules-filter-uninstall', null, true);
    dataCollectionSectionForm['funcs']['toggleJstreeTool']('{{componentId}}-{{sectionId}}-modules-filter-queue', null, true);
    dataCollectionSectionForm['funcs']['toggleJstreeTool']('{{componentId}}-{{sectionId}}-modules-filter-clear', null, true);

    $('#{{componentId}}-{{sectionId}}-modules').children('ul').hide();

    if ($('#{{componentId}}-{{sectionId}}-modules-empty').length > 0) {
        $('#{{componentId}}-{{sectionId}}-modules-empty').remove();
    }

    $('#{{componentId}}-{{sectionId}}-modules').append(
        '<div id="{{componentId}}-{{sectionId}}-modules-empty" class="text-center">' +
            '<i class="fa fa-cog fa-spin"></i> Syncing modules...' +
        '</div>'
    );

    var postData = { };
    postData[$('#security-token').attr('name')] = $('#security-token').val();
    postData['api_id'] = val;
    postData['get_repository_modules'] = true;

    $.post('{{links.url("modules/sync")}}', postData, function(response) {
        dataCollectionSectionForm['vars']['sync'] = false;
        if (response.tokenKey && response.token) {
            $('#security-token').attr('name', response.tokenKey);
            $('#security-token').val(response.token);
        }

        if (response.responseCode == 0) {
            $('#{{componentId}}-{{sectionId}}-modules').jstree().destroy();

            if (response.responseData) {
                var text = 'Sync Complete.<br>';
                var newCounter = 0;
                var updatesCounter = 0;
                var newModule = 'new module';
                var update = 'update';

                if (response.responseData.counter.new && response.responseData.counter.new.count) {
                    newCounter = response.responseData.counter.new.count;

                    if (response.responseData.counter.new.api && response.responseData.counter.new.api.name) {
                            text += response.responseData.counter.new.api.name + ' has '
                    }
                }

                if (response.responseData.counter.updates && response.responseData.counter.updates.count) {
                    updatesCounter = response.responseData.counter.updates.count;

                    if (response.responseData.counter.updates.api && response.responseData.counter.updates.api.name) {
                        text += response.responseData.counter.updates.api.name + ' has '
                    }
                }

                if (newCounter > 0 || updatesCounter > 0) {
                    if (newCounter > 1) {
                        newModule = 'new modules';
                    }
                    if (updatesCounter > 1) {
                        update = 'updates';
                    }
                    if (newCounter !== 0 && updatesCounter === 0) {
                        dataCollectionSectionForm['vars']['new_available'] = newCounter;
                        text += newCounter + ' ' + newModule + ' available.<br> No ' + update + ' available.';
                    } else if (newCounter === 0 && updatesCounter !== 0) {
                        text += updatesCounter + ' new ' + update + ' available.<br> No ' + newModule + ' available.';
                    } else if (newCounter !== 0 && updatesCounter !== 0) {
                        text += updatesCounter + ' new ' + update + ' available.<br>' + newCounter + ' ' + newModule + ' available.';
                    }
                } else {
                    text = 'Sync Complete.<br>No ' + newModule + ' or ' + update + ' available.';
                }

                if (response.responseData.modules) {
                    dataCollectionSectionForm['vars']['modules'] = response.responseData.modules;
                }
                if (response.responseData.modules_html && response.responseData.modules_html !== '') {
                    var modulesHtml =
                        '<div id="{{componentId}}-{{sectionId}}-modules" data-bazscantype="jstree">' +
                            '<ul>' +
                                response.responseData.modules_html +
                            '</ul>' +
                        '</div>';

                    $('#{{componentId}}-{{sectionId}}-modules-tree-div').empty().html(modulesHtml);
                }

                BazContentFields.init({
                    'componentId'   : '{{componentId}}',
                    'sectionId'     : '{{componentId}}-{{sectionId}}',
                    'fieldId'       : '{{componentId}}-{{sectionId}}-modules'
                });

                dataCollectionSectionForm['funcs']['jstreeSelectNode']();
                dataCollectionSectionForm['funcs']['jstreeReady']();

                dataCollectionSectionForm['vars']['syncInfo'] = text;

                if (updatesCounter > 0) {
                    dataCollectionSectionForm['vars']['update_available'] = 1;
                    dataCollectionSectionForm['vars']['filter'] = true;
                    dataCollectionSectionForm['vars']['initJstree'] = false;
                    // $('#{{componentId}}-{{sectionId}}-modules-tree-search-input').val('update');
                    // $('#{{componentId}}-{{sectionId}}-modules').jstree().search('update');
                } else {
                    paginatedPNotify('info', {
                        text        : dataCollectionSectionForm['vars']['syncInfo'],
                        textTrusted : true
                    });
                }
            }
        } else {
            paginatedPNotify('error', {
                text        : response.responseMessage,
                textTrusted : true
            });

            if ($('#{{componentId}}-{{sectionId}}-modules-empty').length > 0) {
                $('#{{componentId}}-{{sectionId}}-modules-empty').remove();
            }

            $('#{{componentId}}-{{sectionId}}-modules').children('ul').show();
        }
        dataCollectionSectionForm['funcs']['toggleJstreeTool']('{{componentId}}-{{sectionId}}-modules-repo-sync', 'primary', false);
        $('#{{componentId}}-{{sectionId}}-modules-repo-sync').children("i").removeClass("fa-cog fa-spin").addClass("fa-sync-alt");
    }, 'json');
}

$(document).ready(function() {
    // BazProgress.buildProgressBar($('#installer-progress'));

    $('#{{componentId}}-{{sectionId}}-modules-tree-search-input').on('keyup', function() {
        var term = $(this).val();
        if (term === '') {
            dataCollectionSectionForm['vars']['filter'] = false;
            $('#{{componentId}}-{{sectionId}}-modules').jstree().clear_search();
        } else {
            dataCollectionSectionForm['vars']['filter'] = true;
            $('#{{componentId}}-{{sectionId}}-modules').jstree().search(term);
        }
    });
});
</script>