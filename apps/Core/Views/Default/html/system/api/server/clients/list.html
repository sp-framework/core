{% set canAddButton = null %}
{% if canAdd %}
    {% set canAddButton = {
                    'componentId'           : componentId,
                    'sectionId'             : 'listing',
                    'buttonType'            : 'button',
                    'buttons'               :
                        {
                            'add-client' : {
                                'title'                   : 'Add New Client',
                                'size'                    : 'sm',
                                'type'                    : 'primary',
                                'icon'                    : 'plus',
                                'buttonAdditionalClass'   : 'contentAjaxLink',
                                'position'                : 'right',
                                'url'                     : links.url('system/api/server/clients/q/id/0')
                            }
                        }
                }
    %}
{% endif %}
{{adminltetags.useTag('content',
    [
        'component'             : table['component'],
        'componentName'         : componentName,
        'componentId'           : componentId,
        'parentComponentId'     : parent,
        'sectionId'             : 'listing',
        'contentType'           : 'sectionWithListing',
        'cardHeader'            : true,
        'cardType'              : 'primary',
        'cardIcon'              : 'sitemap',
        'cardTitle'             : componentName,
        'cardAdditionalClass'   : 'rounded-0',
        'cardShowTools'         : ['maximize'],
        'dtFilter'              : true,
        'dtFilters'             : table['filters'],
        'dtFilterColumns'       : table['filterColumns'],
        'dtFixedHeader'         : true,
        'dtPrimaryButtons'      : canAddButton,
        'dtTable'               : table,
        'dtColumns'             : table['columns'],
        'dtPostUrl'             : table['postUrl'],
        'dtPostUrlParams'       : table['postUrlParams'],
        'dtStriped'             : true,
        'dtStateSave'           : false,
        'dtBordered'            : false,
        'dtHideIdColumn'        : true,
        'dtNoOfColumnsToShow'   : 8,
        'dtTableCompact'        : true,
        'dtZeroRecords'         : 'No clients data available. Add client by clicking the Add new client button.'
    ]
)}}
<script>
/* globals Swal PNotify BazContentLoader BazCore */
window["dataCollection"]["{{componentId}}"]["{{componentId}}-listing"]["customFunctions"]["afterTableInit"] = function() {
    initFuncs();
    $('.tooltip').remove();
    $('[data-toggle="tooltip"]').tooltip();
}
window["dataCollection"]["{{componentId}}"]["{{componentId}}-listing"]["customFunctions"]["afterRedraw"] = function() {
    initFuncs();
    $('.tooltip').remove();
    $('[data-toggle="tooltip"]').tooltip();
}

function initFuncs() {
    $('.rowRevoke, .rowRevokeRegen, .rowResetCallsCount').each(function(index,row) {
        $(row).off();
        $(row).click(function(e) {
            e.preventDefault();

            var thisButton = this;
            var url = $(this).attr('href');
            if ($(thisButton).hasClass('rowRevoke')) {
                $(thisButton).children('i').removeClass('fa-times-circle').addClass('fa-spin fa-cog');
            } else {
                $(thisButton).children('i').removeClass('fa-sync-alt').addClass('fa-spin fa-cog');
            }
            $(thisButton).addClass('disabled');

            var text;
            if ($(thisButton).hasClass('rowRevokeRegen')) {
                text = 'Regenerate API Client Keys for client ID ' + $(thisButton).parents('tr').children('.data-client_id').html() + '?';
            } else if ($(thisButton).hasClass('rowResetCallsCount')) {
                text = 'Reset counters for for client ID ' + $(thisButton).parents('tr').children('.data-client_id').html() + '?';
            } else {
                text = 'Revoke API Client Keys for client ID ' + $(thisButton).parents('tr').children('.data-client_id').html() + '?';
            }
            Swal.fire({
                title                       : '<span class="text-danger">' + text + '</span>',
                icon                        : 'question',
                width                       : '100%',
                background                  : 'rgba(0,0,0,.8)',
                backdrop                    : 'rgba(0,0,0,.6)',
                buttonsStyling              : false,
                confirmButtonText           : 'Yes',
                customClass                 : {
                    'confirmButton'             : 'btn btn-danger text-uppercase',
                    'cancelButton'              : 'ml-2 btn btn-secondary text-uppercase',
                    'inputLabel'                : 'text-white',
                    'input'                     : 'text-white'
                },
                showCancelButton            : true,
                keydownListenerCapture      : true,
                allowOutsideClick           : false,
                allowEscapeKey              : false,
                didOpen                     : function() {
                    window.dataCollection.env.sounds.swalSound.play();
                }
            }).then((result) => {
                if (result.isConfirmed === true &&
                    result.value !== ''
                ) {
                    if ($(thisButton).hasClass('rowRevokeRegen')) {
                        runAjax(thisButton, url, false, true);
                    } else if ($(thisButton).hasClass('rowResetCallsCount')) {
                        runAjax(thisButton, url);
                    } else {
                        runAjax(thisButton, url, true);
                    }
                } else {
                    $(thisButton).children('i').removeClass('fa-spin fa-cog').addClass('fa-times-circle');
                    $(thisButton).removeClass('disabled');
                }
            });
        });

        function runAjax(thisButton, url, forceRevoke = false, forceRegen = false) {
            var dataToSend = { };
            dataToSend[$('#security-token').attr('name')] = $('#security-token').val();
            dataToSend.id = window["dataCollection"]["{{componentId}}"]["{{componentId}}-listing"]['datatable'].row($(thisButton).parents('tr')).id();
            if ($(thisButton).hasClass('rowRevoke') && forceRevoke) {
                dataToSend['forceRevoke'] = 'true';
            } else if ($(thisButton).hasClass('rowRevokeRegen') && forceRegen) {
                dataToSend['forceRegen'] = 'true';
            }

            $.ajax({
                url         : url,
                method      : 'post',
                dataType    : 'json',
                data        : dataToSend,
                success     : function(response) {
                    if (response.responseCode === 0) {
                        window["dataCollection"]["{{componentId}}"]["{{componentId}}-listing"]['BazContentSectionWithListing']._filterRunAjax();
                    } else {
                        PNotify.error({
                            title           : response.responseMessage,
                        });
                    }

                    if ($(thisButton).hasClass('rowRevoke')) {
                        $(thisButton).children('i').removeClass('fa-spin fa-cog').addClass('fa-times-circle');
                    } else {
                        $(thisButton).children('i').removeClass('fa-spin fa-cog').addClass('fa-sync-alt');
                    }
                    $(thisButton).removeClass('disabled');

                    if (response.tokenKey && response.token) {
                        $('#security-token').attr('name', response.tokenKey);
                        $('#security-token').val(response.token);
                    }
                }
            });
        }
    });
}
</script>