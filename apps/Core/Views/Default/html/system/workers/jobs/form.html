{% if job['id'] is defined %}
    {% set jobResult = '' %}
    {% if job['response_code'] is defined and job['response_code'] !== '' %}
        {% set jobResult = jobResult ~ '<div id="' ~ componentId ~ '-' ~ sectionId ~ '-code"><strong class="text-uppercase">Code:</strong> ' ~ job['response_code'] ~ '</div><br>' %}
    {% else %}
        {% set jobResult = jobResult ~ '<div id="' ~ componentId ~ '-' ~ sectionId ~ '-code"><strong class="text-uppercase">Code:</strong> -</div><br>' %}
    {% endif %}
    {% if job['response_message'] is defined and job['response_message'] !== '' %}
        {% set jobResult = jobResult ~ '<div id="' ~ componentId ~ '-' ~ sectionId ~ '-message"><strong class="text-uppercase">Message:</strong> ' ~ job['response_message'] ~ '</div><br>' %}
    {% else %}
        {% set jobResult = jobResult ~ '<div id="' ~ componentId ~ '-' ~ sectionId ~ '-message"><strong class="text-uppercase">Message:</strong> -</div><br>' %}
    {% endif %}
    {% if job['response_data'] is defined and job['response_data'] !== '' %}
        {% set jobResult = jobResult ~ '<div id="' ~ componentId ~ '-' ~ sectionId ~ '-data"><strong class="text-uppercase">Data:</strong> ' ~ job['response_data'] ~ '</div><br>' %}
        {% set jobResult = jobResult ~ '<button class="btn btn-xs btn-info mr-1" id="' ~ componentId ~ '-' ~ sectionId ~ '-format-data" data-toggle="tooltip" data-html="true" data-placement="auto" title="" role="button"><i class="fas fa-fw fa-magic"></i> FORMAT DATA</button><br><br>' %}
    {% else %}
        {% set jobResult = jobResult ~ '<div id="' ~ componentId ~ '-' ~ sectionId ~ '-data"><strong class="text-uppercase">Data:</strong> -</div><br>' %}
    {% endif %}
    {% if job['calls'] is defined and job['calls']|length > 0 %}
        {% set jobCallsArr = json_encode(job['calls'], 16) %}
        {% set rows = '' %}
        {% for jobCall in job['calls'] %}
            {% set rows = rows ~ '<tr>' %}
                {% set columns = '<td>' ~ jobCall['called_at'] ~ '</td><td>' ~ jobCall['call_method'] ~ '</td>' %}
                {% if jobCall['call_response_code'] != '200' %}
                    {% set columns = columns ~ '<td><span class="badge badge-danger text-uppercase">' ~ jobCall['call_response_code'] ~ '</span></td>' %}
                {% else %}
                    {% set columns = columns ~ '<td><span class="badge badge-success text-uppercase">' ~ jobCall['call_response_code'] ~ '</span></td>' %}
                {% endif %}
                {% set columns = columns ~ '<td>' ~ jobCall['call_exec_time'] ~ '</td>' %}
                {% set rows = rows ~ columns %}
            {% set rows = rows ~ '</tr>' %}
            {% if jobCall['call_stats'] is defined and jobCall['call_stats'] !== '' %}
                {% set rows = rows ~ '<tr>' %}
                    {% set button = '<br><br><button class="btn btn-xs btn-info mr-1" id="' ~ componentId ~ '-' ~ sectionId ~ '-format-call-stat-' ~ jobCall['id'] ~'" data-id="' ~ jobCall['id'] ~ '" data-toggle="tooltip" data-html="true" data-placement="auto" title="" role="button"><i class="fas fa-fw fa-magic"></i> FORMAT CALL DATA</button><br>' %}
                    {% set rows = rows ~  '<td id="' ~ componentId ~ '-' ~ sectionId ~ '-call-stat-' ~ jobCall['id'] ~ '" colspan="4" class="text-wrap text-truncate" style="max-width: 200px;">' ~ jobCall['call_stats'] ~ button ~ '</td>' %}
                {% set rows = rows ~ '</tr>' %}
            {% endif %}
            {% if jobCall['call_error'] is defined and jobCall['call_error'] !== '' %}
                {% set rows = rows ~ '<tr>' %}
                    {% set button = '<br><br><button class="btn btn-xs btn-info mr-1" id="' ~ componentId ~ '-' ~ sectionId ~ '-format-call-stat-' ~ jobCall['id'] ~'" data-id="' ~ jobCall['id'] ~ '" data-toggle="tooltip" data-html="true" data-placement="auto" title="" role="button"><i class="fas fa-fw fa-magic"></i> FORMAT CALL DATA</button><br>' %}
                    {% set rows = rows ~  '<td id="' ~ componentId ~ '-' ~ sectionId ~ '-call-stat-' ~ jobCall['id'] ~ '" colspan="4" class="text-wrap text-truncate" style="max-width: 200px;">' ~ jobCall['call_error'] ~ button ~ '</td>' %}
                {% set rows = rows ~ '</tr>' %}
            {% endif %}
        {% endfor %}
        {% set jobResult = jobResult ~ '<div id="' ~ componentId ~ '-' ~ sectionId ~ '-calls" class="mb-1"><strong class="text-uppercase">Total # of API Calls <span class="badge badge-success text-uppercase" style="top: -2px;position: relative;">' ~ job['calls']|length ~ '</span></strong></div>
            <div class="table-responsive p-0" style="height:600px">
                <table id="' ~ componentId ~ '-' ~ sectionId ~ '-call-details-table" class="table table-head-fixed table-hover table-striped table-sm text-nowrap">
                    <thead>
                        <tr>
                            <th>CALLED AT</th>
                            <th>METHOD</th>
                            <th>RESPONSE CODE</th>
                            <th>EXECUTION TIME</th>
                        </tr>
                    </thead>
                    <tbody>'
                        ~ rows ~
                    '</tbody>
                </table>
            </div>'
        %}
    {% else %}
        {% set jobCallsArr = json_encode('[]', 64) %}
    {% endif %}
    <form data-validateon="section" id="{{componentId}}-{{sectionId}}-form">
        <fieldset id="{{componentId}}-{{sectionId}}-fieldset">
            <div class="row">
                <div class="col">
                    {{adminltetags.useTag('fields',
                        [
                            'component'                      : component,
                            'componentName'                  : componentName,
                            'componentId'                    : componentId,
                            'sectionId'                      : sectionId,
                            'fieldId'                        : 'result',
                            'fieldLabel'                     : 'Result',
                            'fieldType'                      : 'html',
                            'fieldHelp'                      : true,
                            'fieldHelpTooltipContent'        : 'Result of the job',
                            'fieldRequired'                  : false,
                            'fieldBazScan'                   : true,
                            'fieldHtmlAdditionalClass'       : 'border p-3',
                            'fieldHtmlContent'               : jobResult
                        ]
                    )}}
                </div>
            </div>
        </fieldset>
    </form>
    <script>
/* globals BazHelpers */
var dataCollectionComponent, dataCollectionSection, dataCollectionSectionForm;

if (!window['dataCollection']['{{componentId}}']) {
    dataCollectionComponent =
        window['dataCollection']['{{componentId}}'] = { };
} else {
    dataCollectionComponent =
        window['dataCollection']['{{componentId}}'];
}
if (!dataCollectionComponent['{{componentId}}-{{sectionId}}']) {
    dataCollectionSection =
        dataCollectionComponent['{{componentId}}-{{sectionId}}'] = { };
} else {
    dataCollectionSection =
        dataCollectionComponent['{{componentId}}-{{sectionId}}'];
}
if (!dataCollectionSection['{{componentId}}-{{sectionId}}-form']) {
    dataCollectionSectionForm =
        dataCollectionSection['{{componentId}}-{{sectionId}}-form'] = { };
} else {
    dataCollectionSectionForm =
        dataCollectionSection['{{componentId}}-{{sectionId}}-form'];
}
var jobCallsArr = '{{jobCallsArr}}';

//eslint-disable-next-line
var jobCalls = jobCallsArr.replaceAll('\"', '"');
//eslint-disable-next-line
jobCalls = jobCalls.replaceAll('\\/', '/');
jobCalls = jobCalls.replaceAll('"{', '{');
jobCalls = jobCalls.replaceAll('}"', '}');
jobCalls = JSON.parse(jobCalls);

dataCollectionSection =
    $.extend(dataCollectionSection, {
        '{{componentId}}-{{sectionId}}-result'                  : {
            afterInit: function() {
                $('#{{componentId}}-{{sectionId}}-format-data').click(function(e) {
                    e.preventDefault();

                    var html = '{{job["response_data"]}}';
                    var regex = /{.*}/g;
                    var found = html.match(regex);

                    if (found) {
                        //eslint-disable-next-line
                        var data = found[0].replaceAll('\"', '"');
                        //eslint-disable-next-line
                        data = data.replaceAll('\\', '\\\\\\\\');
                        var obj = JSON.parse(data);

                        if (obj) {
                            $('#{{componentId}}-{{sectionId}}-data').html('Data: ' + BazHelpers.createHtmlList({'obj': obj}));
                        }
                    }

                    $(this).attr('hidden', true);
                });

                if (typeof jobCalls === 'object' && jobCalls !== null) {
                    for (var call in jobCalls) {
                        if ($('#{{componentId}}-{{sectionId}}-format-call-stat-' + call)) {
                            $('#{{componentId}}-{{sectionId}}-format-call-stat-' + call).click(function(e) {
                                e.preventDefault();

                                var callId = $(this).data('id');

                                var html;

                                if (jobCalls[callId]['call_stats']) {
                                    html = jobCalls[callId]['call_stats'];
                                } else if (jobCalls[callId]['call_error']) {
                                    html = jobCalls[callId]['call_error'];
                                }

                                $('#{{componentId}}-{{sectionId}}-call-stat-' + callId).html(BazHelpers.createHtmlList({'obj': html}));

                                $(this).attr('hidden', true);
                            });
                        }
                    }
                }
            }
        },
        '{{componentId}}-{{sectionId}}-form'                    : {
            rules: {
            },
            messages: {
            }
        }
    });
</script>
{% endif %}