<div class="row vdivide">
    <div id="repo" class="col">
        {% include 'repositories/list.html' %}
    </div>
    <div id="filter" class="col">
        {% include 'modules/filter' with ['filters': filters] %}
    </div>
</div>
<hr>
{% if modulesData is defined %}
    {% include 'modules/modulesdata' with ['modulesData' : modulesData] %}
{% else %}
    <div class="row">
        <div id="modules-data" class="col">
            <h5 class="text-center">
                Select repository and click sync with remote repository or Select filter
            </h5>
        </div>
    </div>
{% endif %}
<div class="row m-2" id="repository-sync" hidden>
    <div class="col text-center">
        <div class="fa-2x">
            <i class="fa fa-cog fa-spin"></i> Syncing...
        </div>
    </div>
</div>
<div class="row m-2" id="modules-loader" hidden>
    <div class="col">
        <div class="fa-2x">
            <i class="fa fa-cog fa-spin"></i> Loading...
        </div>
    </div>
</div>
<script>
/*global PNotify */
$('#filter-options-filter').change(function() {
    var filterVal = $('#filter-options-filter option:selected').val();

    if (filterVal != 0) {
        $('#modules-loader').attr('hidden', false);
        $('#modules-data').empty();
        var url = 'modules/q/filter/' + filterVal;
        $.get(url, function(data) {
            $('#modules-loader').attr('hidden', true);
            $('#modules-data').html(data);
        });
    } else if (filterVal == 0) {
        $('#modules-data').empty().append(
            '<h5 class="text-center">' +
                'Select filter or sync with remote repository' +
            '</h5>'
        );
    }
    initModuleButtons();
});

function initModuleButtons() {
    $('.btn-settings, .btn-update, .btn-view, .btn-uninstall').off();

    $('.btn-settings, .btn-update, .btn-view, .btn-uninstall').click(function(e) {
        e.preventDefault();

        $('#modal-save').off();

        var title = $(this).parents('.card-footer').siblings('.card-header').children('label').html();

        var submitData;
        var that = this;

        submitData = $(this).data();
        submitData['url'] = $(this).attr('href');

        if (submitData.process === 'view') {

            submitData['layout'] = false;

            if (submitData.subprocess === 'install') {
                $.get(submitData.url + '/q/id/' + submitData.id + '/type/' + submitData.type, function(data) {
                    if (data) {
                        $('#modal-title').html(title + ' Information');
                        $('#modal .modal-body').empty().html(data);
                        $('#modal').modal('show');
                        $('#modal-save-text').html('Install ' + submitData['name'] + ' & its dependencies');

                        $('#modal-save').click(function() {
                            $('#modal-save-spinner').attr('hidden', false);
                            submitData.process = 'install';
                            delete submitData.subprocess;
                            $.post(submitData.url + '/install', submitData, function(data) {
                                if (data && data.responseCode === 0) {
                                    location.reload();
                                } else if (data && data.responseCode === 1) {
                                    PNotify.error({
                                      text          : data.responseMessage,
                                      textTrusted   : true
                                    });
                                    $('#modal-save-spinner').attr('hidden', true);
                                    submitData.process = 'view';
                                    submitData.subprocess = 'install';
                                }
                            }, 'json');
                        });
                    } else {
                        //
                    }
                });
            } else if (submitData.subprocess === 'update') {
                $.get(submitData.url, submitData, function(data) {
                    if (data) {
                        $('#modal-title').html(title + ' Information');
                        $('#modal .modal-body').empty().html(data);
                        $('#modal').modal('show');
                        if (submitData.type === 'core') {
                            $('#modal-save-text').html('Update ' + submitData['name']);
                        } else {
                            $('#modal-save-text').html('Update ' + submitData['name'] + ' & its dependencies');
                        }

                        $('#modal-save').click(function() {
                            $('#modal-save-spinner').attr('hidden', false);
                            submitData.process = 'update';
                            delete submitData.subprocess;
                            $.post(submitData.url + '/update', submitData, function(data) {
                                if (data && data.responseCode === 0) {
                                    PNotify.success({
                                      text          : data.responseMessage,
                                      textTrusted   : true
                                    });
                                    location.reload();
                                } else if (data && data.responseCode === 1) {
                                    PNotify.error({
                                      text          : data.responseMessage,
                                      textTrusted   : true
                                    });
                                    $('#modal-save-spinner').attr('hidden', true);
                                    submitData.process = 'view';
                                    submitData.subprocess = 'update';
                                }
                            }, 'json');
                        });
                    } else {
                        //
                    }
                });
            }
        } else if (submitData.process === 'uninstall') {
            //
        } else if (submitData.process === 'settings') {
            submitData['layout'] = false;
            $.get(submitData.url + '/q/id/' + submitData.id + '/type/' + submitData.type, function(data) {
                if (data) {
                    $('#modal-title').html(title + ' Settings');
                    $('#modal .modal-body').empty().html(data);
                    $('#modal').modal('show');
                } else {
                    //
                }
            });
        }
    });
}
initModuleButtons();
</script>
{% include 'modules/modal.html' %}