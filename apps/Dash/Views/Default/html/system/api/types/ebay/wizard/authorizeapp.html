<div class="row">
    <div class="col">
        <h5>Click the button below to start App authorization process.</h5>
        {{adminltetags.useTag('buttons',
            [
                'componentId'           : componentId,
                'sectionId'             : sectionId,
                'buttonType'            : 'button',
                'buttons'               :
                    [
                        'begin-app-autho' : [
                            'title'                   : 'Begin App Authorization',
                            'size'                    : 'sm',
                            'type'                    : 'primary',
                            'icon'                    : 'cog fa-spin',
                            'iconHidden'              : true
                        ]
                    ]
            ]
        )}}
    </div>
</div>
<script>
/* globals PNotify */
$('#{{componentId}}-{{sectionId}}-begin-app-autho').click(function(e) {
    e.preventDefault();

    $(this).removeClass('btn-success').addClass('btn-primary');

    $(this).html(
        '<i class="fas fa-fw fa-cog fa-spin" hidden="hidden"></i> RUNNING AUTHORIZATION. PLEASE WAIT...'
    );

    $(this).attr('disabled', true);

    $('#{{componentId}}-{{sectionId}}-begin-app-autho').children().attr('hidden', false);

    var registerFormId;

    if ($('#{{componentId}}-{{sectionId}}-id').val() != '') {
        registerFormId = $('#{{componentId}}-{{sectionId}}-id').val();
    } else {
        registerFormId = window['dataCollection']["{{componentId}}"]["{{componentId}}-{{sectionId}}"]["steps"]['1']['responseData']['id'];
    }

    var postData = { };
    postData['api_id'] = registerFormId;
    postData[$('#security-token').attr('name')] = $('#security-token').val();

    $.post('{{links.url("system/api/getEbayAppToken")}}', postData, function(response) {
        if (response.tokenKey && response.token) {
            $('#security-token').attr('name', response.tokenKey);
            $('#security-token').val(response.token);
        }

        $('#{{componentId}}-{{sectionId}}-begin-app-autho').children().attr('hidden', true);
        if (response.responseCode == '0') {
            PNotify.success({
                title   : response.responseMessage,
            });
            $('#{{componentId}}-{{sectionId}}-next').attr('disabled', false);
            $('#{{componentId}}-{{sectionId}}-begin-app-autho').removeClass('btn-primary').addClass('btn-success');
            $('#{{componentId}}-{{sectionId}}-begin-app-autho').html(
                '<i class="fas fa-fw fa-cog fa-spin" hidden="hidden"></i> AUTHORIZED! CLICK TO RE-AUTHORIZATION'
            );
        } else {
            PNotify.error({
                title   : response.responseMessage,
            });
            $('#{{componentId}}-{{sectionId}}-begin-app-autho').html(
                '<i class="fas fa-fw fa-cog fa-spin" hidden="hidden"></i> AUTHORIZATION ERROR! TRY AGAIN?'
            );
        }
        $('#{{componentId}}-{{sectionId}}-begin-app-autho').attr('disabled', false);
    }, 'json');
});
</script>