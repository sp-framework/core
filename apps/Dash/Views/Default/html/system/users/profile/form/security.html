<div class="row">
    <div class="col">
        {{adminltetags.useTag('fields',
            [
                'component'                             : component,
                'componentName'                         : componentName,
                'componentId'                           : componentId,
                'sectionId'                             : sectionId,
                'fieldId'                               : 'pwreset',
                'fieldLabel'                            : 'Password Reset',
                'fieldLabelLegend'                      : true,
                'fieldHidden'                           : false,
                'fieldType'                             : 'html',
                'fieldBazScan'                          : false,
                'fieldBazPostOnCreate'                  : false,
                'fieldBazPostOnUpdate'                  : false,
                'fieldBazJstreeSearch'                  : true,
                'fieldHtmlContent'                      : ''
            ]
        )}}
        <div class="row">
            <div class="col">
                {{adminltetags.useTag('fields',
                    [
                        'component'                             : component,
                        'componentName'                         : componentName,
                        'componentId'                           : componentId,
                        'sectionId'                             : sectionId,
                        'fieldId'                               : 'current_password',
                        'fieldLabel'                            : 'Current Password',
                        'fieldHidden'                           : false,
                        'fieldType'                             : 'input',
                        'fieldInputType'                        : 'password',
                        'fieldRequired'                         : true,
                        'fieldBazScan'                          : true,
                        'fieldBazPostOnCreate'                  : false,
                        'fieldBazPostOnUpdate'                  : false
                    ]
                )}}
            </div>
            <div class="col">
                {{adminltetags.useTag('fields',
                    [
                        'component'                             : component,
                        'componentName'                         : componentName,
                        'componentId'                           : componentId,
                        'sectionId'                             : sectionId,
                        'fieldId'                               : 'new_password',
                        'fieldLabel'                            : 'New Password',
                        'fieldHidden'                           : false,
                        'fieldType'                             : 'input',
                        'fieldInputType'                        : 'password',
                        'fieldRequired'                         : true,
                        'fieldBazScan'                          : true,
                        'fieldBazPostOnCreate'                  : false,
                        'fieldBazPostOnUpdate'                  : false,
                        'fieldGroupPostAddonButtons'     :
                            {
                                'password_generate'   : {
                                    'title'                         : false,
                                    'icon'                          : 'wand-magic-sparkles',
                                    'noMargin'                      : true,
                                    'buttonAdditionalClass'         : 'rounded-0'
                                }
                            },
                        'fieldAdditionalClass'           : 'mb-0'
                    ]
                )}}
                {{adminltetags.useTag('fields',
                    [
                        'component'                             : component,
                        'componentName'                         : componentName,
                        'componentId'                           : componentId,
                        'sectionId'                             : sectionId,
                        'fieldId'                               : 'strength-meter',
                        'fieldLabel'                            : false,
                        'fieldHidden'                           : false,
                        'fieldType'                             : 'html',
                        'fieldRequired'                         : false,
                        'fieldBazScan'                          : true,
                        'fieldBazPostOnCreate'                  : false,
                        'fieldBazPostOnUpdate'                  : false
                    ]
                )}}
            </div>
            <div class="col">
                {{adminltetags.useTag('fields',
                    [
                        'component'                             : component,
                        'componentName'                         : componentName,
                        'componentId'                           : componentId,
                        'sectionId'                             : sectionId,
                        'fieldId'                               : 'confirm_password',
                        'fieldLabel'                            : 'Confirm Password',
                        'fieldHidden'                           : false,
                        'fieldType'                             : 'input',
                        'fieldInputType'                        : 'password',
                        'fieldBazScan'                          : true,
                        'fieldRequired'                         : true,
                        'fieldBazPostOnCreate'                  : false,
                        'fieldBazPostOnUpdate'                  : false
                    ]
                )}}
            </div>
        </div>
    </div>
</div>
<div class="row">
    <div class="col">
        {{adminltetags.useTag('buttons',
            [
                'component'                 : component,
                'componentName'             : componentName,
                'componentId'               : componentId,
                'sectionId'                 : sectionId,
                'buttonType'                : 'button',
                'buttons'                   :
                    {
                        'pwreset-button' : {
                            'title'                   : 'Reset',
                            'size'                    : 'sm',
                            'type'                    : 'primary',
                            'icon'                    : 'cog fa-spin',
                            'iconHidden'              : true,
                            'position'                : 'right'
                        }
                    }
            ]
        )}}
    </div>
</div>
<hr>
<div class="row">
    <div class="col">
        {{adminltetags.useTag('fields',
            [
                'component'                             : component,
                'componentName'                         : componentName,
                'componentId'                           : componentId,
                'sectionId'                             : sectionId,
                'fieldId'                               : 'twofa',
                'fieldLabel'                            : 'Two Factor Authentication',
                'fieldLabelLegend'                      : true,
                'fieldHidden'                           : false,
                'fieldType'                             : 'html',
                'fieldBazScan'                          : false,
                'fieldBazPostOnCreate'                  : false,
                'fieldBazPostOnUpdate'                  : false,
                'fieldBazJstreeSearch'                  : true,
                'fieldHtmlContent'                      : 'Two Factor Authentication (2FA) is an extended method of authentication which uses an authenticator app like Google Authenticator or Authy.'
            ]
        )}}
    </div>
</div>
{% if account['two_fa_status'] == '1' %}
    {% set disableHidden = false %}
    {% set enableHidden = true %}
{% else %}
    {% set disableHidden = true %}
    {% set enableHidden = false %}
{% endif %}
<div class="row">
    <div class="col">
        {{adminltetags.useTag('buttons',
            [
                'component'                 : component,
                'componentName'             : componentName,
                'componentId'               : componentId,
                'sectionId'                 : sectionId,
                'buttonType'                : 'button',
                'buttons'                   :
                    {
                        'enable-twofa-button' : {
                            'title'                   : 'Enable Two Factor Authentication',
                            'size'                    : 'sm',
                            'type'                    : 'primary',
                            'icon'                    : 'cog fa-spin',
                            'iconHidden'              : true,
                            'hidden'                  : enableHidden
                        },
                        'disable-twofa-button' : {
                            'title'                   : 'Disable Two Factor Authentication',
                            'size'                    : 'sm',
                            'type'                    : 'danger',
                            'icon'                    : 'cog fa-spin',
                            'iconHidden'              : true,
                            'hidden'                  : disableHidden
                        }
                    }
            ]
        )}}
    </div>
</div>
<br>
<div id="twofa-details" class="row vdivide" hidden>
    <div class="col-md-3 d-flex justify-content-center">
        <div id="twofa-qrcode"></div>
    </div>
    <div class="col">
        <div id="twofa-instructions">
            <h5>INSTRUCTIONS:</h5>
            <ul>
                <li>Scan the shown QR Code on your authenticator app.</li>
                <li>If, for any reason, you cannot scan the QR Code, you can type in this secret code manually. <br>Secret Code: <span class="font-weight-bold" id="twofa-secret"></span></li>
                <li>Once successfully added into your app, enter the generated code from the app and click verify.</li>
            </ul>
        </div>
        <div id="twofa-verification">
            <h5>VERIFICATION:</h5>
            {{adminltetags.useTag('fields',
                [
                    'component'                             : component,
                    'componentName'                         : componentName,
                    'componentId'                           : componentId,
                    'sectionId'                             : sectionId,
                    'fieldId'                               : 'verification',
                    'fieldLabel'                            : 'Generated Code',
                    'fieldType'                             : 'input',
                    'fieldGroupPostAddonButtons'          :
                        [
                            'verify'   : [
                                'title'                   : 'Verify',
                                'icon'                    : 'cog fa-spin',
                                'iconHidden'              : true,
                                'noMargin'                : true,
                                'disabled'                : true,
                                'buttonAdditionalClass'   : 'rounded-0 text-white',
                                'position'                : 'right'
                            ]
                        ],
                    'fieldInputTypeTextFilter'              : 'positiveInt',
                    'fieldHelp'                             : true,
                    'fieldHelpTooltipContent'               : 'Code generated via the authenticator app.',
                    'fieldBazScan'                          : false,
                    'fieldBazPostOnCreate'                  : false,
                    'fieldBazPostOnUpdate'                  : false,
                    'fieldBazJstreeSearch'                  : false,
                    'fieldDataInputMinLength'               : 6,
                    'fieldDataInputMaxLength'               : 6
                ]
            )}}
        </div>
    </div>
</div>
<script>
/* global PNotify Swal */
$('#{{componentId}}-{{sectionId}}-strength-meter').strengthMeter({
    "url" : '{{links.url("system/users/profile/checkPwStrength")}}'
});

$('#{{componentId}}-{{sectionId}}-password_generate').click(function(e) {
    e.preventDefault();

    var postData = { };
    postData[$('#security-token').attr('name')] = $('#security-token').val();

    $.post('{{links.url("system/users/profile/generatePw")}}', postData, function(response) {
        if (response.responseCode == 0) {
            if (response.responseData) {
                $('#{{componentId}}-{{sectionId}}-new_password').val(response.responseData).trigger('change');
                $('#{{componentId}}-{{sectionId}}-confirm_password').val(response.responseData);
                $('#{{componentId}}-{{sectionId}}-new_password').attr('type', 'text');
                $('#{{componentId}}-{{sectionId}}-confirm_password').attr('type', 'text');
            }
        } else {
            PNotify.error(response.responseMessage);
        }
        if (response.tokenKey && response.token) {
            $("#security-token").attr("name", response.tokenKey);
            $("#security-token").val(response.token);
        }

        $('#{{componentId}}-{{sectionId}}-new_password, #{{componentId}}-{{sectionId}}-confirm_password').keyup(function() {
            if ($(this).val() === '') {
                $('#{{componentId}}-{{sectionId}}-confirm_password').val('');
                $(this).attr('type', 'password');
            }
        });
    }, 'json');
});

$('#{{componentId}}-{{sectionId}}-pwreset-button').click(function(e) {
    e.preventDefault();

    var postData = {
        'pass'              : $('#{{componentId}}-{{sectionId}}-current_password').val().trim(),
        'newpass'           : $('#{{componentId}}-{{sectionId}}-new_password').val().trim(),
        'confirmnewpass'    : $('#{{componentId}}-{{sectionId}}-confirm_password').val().trim()
    }
    postData[$('#security-token').attr('name')] = $('#security-token').val();

    $.post('{{links.url("system/users/profile/pwreset")}}', postData, function(response) {
        if (response.responseCode == 0) {
            if (response.redirectUrl) {
                window.location = response.redirectUrl;
            }
        } else {
            PNotify.error(response.responseMessage);
        }
        if (response.tokenKey && response.token) {
            $("#security-token").attr("name", response.tokenKey);
            $("#security-token").val(response.token);
        }
    }, 'json');
});

$('#{{componentId}}-{{sectionId}}-enable-twofa-button').click(function(e) {
    e.preventDefault();

    $(this).attr('disabled', true);
    $(this).children('i').attr('hidden', false);

    var postData = { };
    postData[$('#security-token').attr('name')] = $('#security-token').val();

    var url = '{{links.url("system/users/profile/enabletwofa")}}';

    $.post(url, postData, function(response) {
        if (response.responseCode === 0) {
            $('#twofa-qrcode').empty().append(
                '<img src="' + response.qrcode + '" />'
            );
            $('#twofa-details').attr('hidden', false);
            $('#twofa-secret').empty().append(response.secret);
            $('#{{componentId}}-{{sectionId}}-enable-twofa-button').html(
                '<i class="fas fa-fw fa-cog fa-spin" hidden="hidden"></i> REGENERATE TWO FACTOR AUTHENTICATION QR CODE'
            );
        } else {
            PNotify.error({
                'title' : response.responseMessage
            });
        }

        if (response.tokenKey && response.token) {
            $('#security-token').attr('name', response.tokenKey);
            $('#security-token').val(response.token);
        }

        $('#{{componentId}}-{{sectionId}}-enable-twofa-button').attr('disabled', false);
        $('#{{componentId}}-{{sectionId}}-enable-twofa-button').children('i').attr('hidden', true);

    }, 'json');
});

$('#{{componentId}}-{{sectionId}}-verification').on('input propertychange', function() {
    if ($(this).val().length === 6) {
        $('#{{componentId}}-{{sectionId}}-verify').attr('disabled', false);
    } else {
        $('#{{componentId}}-{{sectionId}}-verify').attr('disabled', true);
    }
});

$('#{{componentId}}-{{sectionId}}-verify').click(function(e) {
    e.preventDefault();

    $(this).attr('disabled', true);
    $(this).children('i').attr('hidden', false);

    var postData = { };
    postData[$('#security-token').attr('name')] = $('#security-token').val();
    postData['code'] = $('#{{componentId}}-{{sectionId}}-verification').val().trim();

    var url = '{{links.url("system/users/profile/verifytwofa")}}';

    $.post(url, postData, function(response) {
        if (response.responseCode === 0) {
            PNotify.success({
                'title' : response.responseMessage
            });

            $('#{{componentId}}-{{sectionId}}-verification').val('');
            $('#twofa-qrcode').empty();
            $('#twofa-secret').empty();
            $('#twofa-details').attr('hidden', true);
            $('#{{componentId}}-{{sectionId}}-enable-twofa-button').attr('hidden', true);
            $('#{{componentId}}-{{sectionId}}-disable-twofa-button').attr('hidden', false);
            $('#{{componentId}}-{{sectionId}}-enable-twofa-button').html(
                '<i class="fas fa-fw fa-cog fa-spin" hidden="hidden"></i> ENABLE TWO FACTOR AUTHENTICATION'
            );
        } else {
            PNotify.error({
                'title' : response.responseMessage
            });
        }

        if (response.tokenKey && response.token) {
            $('#security-token').attr('name', response.tokenKey);
            $('#security-token').val(response.token);
        }

        $('#{{componentId}}-{{sectionId}}-verify').attr('disabled', false);
        $('#{{componentId}}-{{sectionId}}-verify').children('i').attr('hidden', true);

    }, 'json');
});

$('#{{componentId}}-{{sectionId}}-disable-twofa-button').click(function(e) {
    e.preventDefault();

    Swal.fire({
        title                       : '<span class="text-danger">Disable 2FA Authentication?</span>',
        icon                        : 'question',
        width                       : '100%',
        background                  : 'rgba(0,0,0,.8)',
        backdrop                    : 'rgba(0,0,0,.6)',
        buttonsStyling              : false,
        confirmButtonText           : 'Disable',
        customClass                 : {
            'confirmButton'             : 'btn btn-danger text-uppercase',
            'cancelButton'              : 'ml-2 btn btn-secondary text-uppercase',
            'inputLabel'                : 'text-white',
            'input'                     : 'text-white'
        },
        showCancelButton            : true,
        keydownListenerCapture      : true,
        allowOutsideClick           : false,
        allowEscapeKey              : false,
        input                       : 'text',
        inputLabel                  : 'GENERATED CODE',
        didOpen                     : function() {
            window.dataCollection.env.sounds.swalSound.play();
        }
    }).then((result) => {
        if (result.isConfirmed === true &&
            result.value !== ''
        ) {
            var postData = { };
            postData[$('#security-token').attr('name')] = $('#security-token').val();
            postData['code'] = result.value;

            var url = '{{links.url("system/users/profile/disabletwofa")}}';

            $.post(url, postData, function(response) {
                if (response.responseCode === 0) {
                    $('#{{componentId}}-{{sectionId}}-disable-twofa-button').attr('hidden', true);
                    $('#{{componentId}}-{{sectionId}}-enable-twofa-button').attr('hidden', false);
                    PNotify.success({
                        'title' : response.responseMessage
                    });
                } else {
                    PNotify.error({
                        'title' : response.responseMessage
                    });
                }

                if (response.tokenKey && response.token) {
                    $('#security-token').attr('name', response.tokenKey);
                    $('#security-token').val(response.token);
                }
            }, 'json');
        }
    });
});
</script>